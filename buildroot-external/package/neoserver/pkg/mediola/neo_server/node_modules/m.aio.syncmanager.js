var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,c){d!=Array.prototype&&d!=Object.prototype&&(d[b]=c.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var d=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+d++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var b=0;return $jscomp.iteratorPrototype(function(){return b<d.length?{done:!1,value:d[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.iteratorFromArray=function(d,b){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var c=0,a={next:function(){if(c<d.length){var e=c++;return{value:b(e,d[e]),done:!1}}a.next=function(){return{done:!0,value:void 0}};return a.next()}};a[Symbol.iterator]=function(){return a};return a};
$jscomp.polyfill=function(d,b,c,a){if(b){c=$jscomp.global;d=d.split(".");for(a=0;a<d.length-1;a++){var e=d[a];e in c||(c[e]={});c=c[e]}d=d[d.length-1];a=c[d];b=b(a);b!=a&&null!=b&&$jscomp.defineProperty(c,d,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.syncmanager=m.aio.syncmanager||{};m.aio.syncmanager.PROTOCOL="https";
m.aio.syncmanager.HOST="127.0.0.1";m.aio.syncmanager.PORT=8080;m.aio.syncmanager.PATH="";m.aio.syncmanager.HEADERS={"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"};m.aio.syncmanager.RemotesDownloader=function(d,b,c,a){this._logger=require("x.logger.js").getLogger("RemotesDownloader");this._host=d;this._port=b;this._username=c?c:"";this._password=a?a:""};m.aio.syncmanager.RemotesDownloader.PROTOCOL="https";
m.aio.syncmanager.RemotesDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemotesDownloader.prototype.downloadRemoteList=function(d){this._logger.log("debug","download remotes list from account:"+this._username);this._doRemoteDownloadReq(function(b,c){if(b)d&&d(b);else if(c.infos){b={remotes:[],info:c};if(0!=c.infos.length)for(var a=0;a<c.infos.length;a++)c.infos[a].name&&b.remotes.push({name:c.infos[a].name,encrypt:c.infos[a].encrypt?!0:!1});d&&d(null,b)}else d&&d(Error("download response format invalid"))})};
m.aio.syncmanager.RemotesDownloader.prototype.download=function(d,b){this._logger.log("debug","download remotes from account:"+this._username);var c=this;this._doRemoteDownloadReq(function(a,e){a?b&&b(a):e.infos?0==e.infos.length?b&&b():c._doDownloadRemotes(d,e.credential,e.infos,function(a){b&&b(a)}):b&&b(Error("download response format invalid"))})};
m.aio.syncmanager.RemotesDownloader.prototype._doRemoteDownloadReq=function(d){this._doGetRequest("/creatorneo/remote/requestDownload",null,function(b,c){if(b)d&&d(b);else try{var a=JSON.parse(c);d&&d(null,a)}catch(e){d&&d(e)}})};
m.aio.syncmanager.RemotesDownloader.prototype._doDownloadRemotes=function(d,b,c,a){var e=new m.aio.syncmanager.RemoteDownloader({host:this._host,port:this._port,username:this._username,password:this._password,credential:b}),f=0,g=function(b){b?a&&a(b):(f++,f<c.length?e.download(d,c[f],g):a&&a())};e.download(d,c[f],g)};
m.aio.syncmanager.RemotesDownloader.prototype._doGetRequest=function(d,b,c){var a=c,e=JSON.parse(JSON.stringify(m.aio.syncmanager.RemotesDownloader.OPTIONS));e.host=this._host?this._host:e.host;e.port=this._port?this._port:e.port;e.path+=d;e.method="GET";this._username&&this._password&&(e.auth=this._username+":"+this._password);b&&Object.keys(b).forEach(function(a){e.headers[a]=b[a]});var f="";d=require(m.aio.syncmanager.RemotesDownloader.PROTOCOL).request(e,function(c){c.setEncoding("utf8");c.on("data",
function(a){f+=a});c.on("end",function(){200==c.statusCode?a&&a(null,f):a&&a(Error("http error with status code:"+c.statusCode),f);a=null})});d.on("error",function(c){a&&(a(c),a=null)});d.end()};m.aio.syncmanager.RemotesDownloader.prototype._decrypt=function(d,b){try{return require("x.crypt.js").AES.decodeString(d,b).trim()}catch(c){return console.log(c),null}};
m.aio.syncmanager.RemotesDownloader.prototype._findRemote=function(d,b){if(!d||!b||!b.infos||0==b.infos.length)return null;for(var c=0;c<b.infos.length;c++)if(b.infos[c].name==d)return b.infos[c];return null};
m.aio.syncmanager.RemoteDownloader=function(d,b){var c=require("x.logger.js");this._logger=c?c.getLogger("RemoteDownloader"):{log:function(){}};this._listener=b;this._host=d.host;this._port=d.port;this._username=d.username?d.username:"";this._password=d.password?d.password:"";this._override="true"==d.override;this._s3cred=d.credential;this._remotePassword=d.remotePassword;this._encrypted=!1;this._s3cred&&(this._s3Client=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:d.credential.accessKeyId,
secretAccessKey:d.credential.secretAccessKey,sessionToken:d.credential.sessionToken}))};m.aio.syncmanager.RemoteDownloader.PROTOCOL="https";m.aio.syncmanager.RemoteDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemoteDownloader.prototype.download=function(d,b,c){this._logger.log("trace","download remote:"+b.name);var a=this,e=require("path");if(b.name){if(this._listener&&this._listener.onProgress)this._listener.onDownloadProgress(0,"start download");if(b.resources&&0!=b.resources.length){if(b.encrypt){this._encrypted=!0;if(!this._remotePassword){if(c){var f=Error("no remote password");f.code=1;c(f)}return}if(this._decrypt(b.encrypt,this._remotePassword)!=b.name){c&&(f=Error("remote password error"),
f.code=2,c(f));return}}var g=require("fs"),h=d+e.sep+b.name;try{var k=g.existsSync(h);if(k&&!this._override){c&&(f=Error("remote:"+b.name+" already exists"),f.code=3,c(f));return}if(k&&this._override){var l=(new Date).getTime();g.renameSync(h,h+"_"+l);this._deldir(h+"_"+l)}}catch(p){c&&c(p);return}if(this._listener&&this._listener.onProgress)this._listener.onDownloadProgress(1,"start to download files",{filesCount:b.resources.length});this._mkdir(d+e.sep+b.name,function(){var f=c,g=0,h=function(c){if(f&&
a._listener&&a._listener.onProgress)a._listener.onDownloadProgress(2,"one file download finish");g+=1;c?f&&(f(c),f=null):g==b.resources.length?f&&(f(),f=null):a._downloadFile(d+e.sep+b.name,b.resources[g],h)};a._downloadFile(d+e.sep+b.name,b.resources[g],h)})}else c&&c()}else c&&c(Error("remote info has no remote name"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFile=function(d,b,c){var a=this;this._logger.log("trace","download file:"+b.file);b.file?"device_db"===b.file?c&&c():b.file.match(/^resources.*/)&&this._s3cred?this._downloadFileFromS3(d,b,function(e){a._logger.log("trace","download file finish:"+b.file);e&&a._logger.log("trace","download file "+b.file+" from s3 error:"+e.message);c&&c(e)}):this._downloadFileFromServer(d,b,function(e){a._logger.log("trace","download file finish:"+b.file);if(e)a._logger.log("trace",
"download file "+b.file+" from server error:"+e.message),c&&c(e);else if("device_db"==b.file&&a._encrypted){e=require("path");var f=b.file.replace(/\//g,e.sep);a._decryptFile(d+e.sep+f,function(a){c&&c(a)})}else c&&c()}):c&&c(Error("file info has no file path"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromServer=function(d,b,c){if(b.ref){var a=require("path"),e=require("fs"),f=b.file.replace(/\//g,a.sep),g=d+a.sep+f;this._logger.log("trace","download file to:"+g);d=g.lastIndexOf(a.sep);d=g.substr(0,d);try{e.mkdirRecursiveSync(d)}catch(p){c&&c(p);return}d=require(m.aio.syncmanager.RemoteDownloader.PROTOCOL);a=this._host?this._host:m.aio.syncmanager.RemoteDownloader.OPTIONS.host;f=this._port?this._port:m.aio.syncmanager.RemoteDownloader.OPTIONS.port;
var h=m.aio.syncmanager.RemoteDownloader.OPTIONS.path+"/creatorneo/remote/downloadFile";b=b.ref.split("/");for(var k=0;k<b.length;k++)b[k]=encodeURIComponent(b[k]);b=m.aio.syncmanager.RemoteDownloader.PROTOCOL+"://"+a+":"+f+h+"/"+b.join("/");a=this._username?encodeURIComponent(this._username):"";f=this._password?encodeURIComponent(this._password):"";b+="?username="+a+"&password="+f;this._logger.log("trace","download file url:"+b);var l=e.createWriteStream(g);d.get(b,function(a){a.pipe(l);l.on("finish",
function(){l.close(c)})}).on("error",function(a){e.unlink(g);c&&c(a)})}else c&&c(Error("file info has no ref"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromS3=function(d,b,c){if(this._s3Client)if(b.ref){var a=require("path"),e=require("fs"),f=b.file.replace(/\//g,a.sep),g=d+a.sep+f;this._logger.log("trace","download file to:"+g);d=g.lastIndexOf(a.sep);d=g.substr(0,d);try{e.mkdirRecursiveSync(d)}catch(h){c&&c(h);return}this._s3Client.getObject({Bucket:"mediola-creator",Key:"resources/"+b.ref},function(a,b){a?c&&c(a):e.writeFile(g,b.Body,function(a){c&&c(a)})})}else c&&c(Error("file info has no ref"));
else c&&c(Error("s3 client not properly initialized"))};m.aio.syncmanager.RemoteDownloader.prototype._mkdir=function(d,b){var c=require("fs");try{c.mkdirSync(d)}catch(a){this._logger.log("warn","creator folder "+d+" error:"+a.message)}b&&b()};m.aio.syncmanager.RemoteDownloader.prototype._deldir=function(d){var b=require("fs"),c=this;b.existsSync(d)&&(b.readdirSync(d).forEach(function(a,e){a=d+"/"+a;b.lstatSync(a).isDirectory()?c._deldir(a):b.unlinkSync(a)}),b.rmdirSync(d))};
m.aio.syncmanager.RemoteDownloader.prototype._decrypt=function(d,b){try{return require("x.crypt.js").AES.decodeString(d,b).trim()}catch(c){return console.log(c),null}};m.aio.syncmanager.RemoteDownloader.prototype._decryptFile=function(d,b){var c=this,a=require("fs"),e=d+".bak";a.rename(d,e,function(f){f?b&&b(f):a.readFile(e,{encoding:"utf8"},function(f,h){f?b&&b(f):(f=c._decrypt(h,c._remotePassword))?a.writeFile(d,f,function(c){c?b&&b(c):a.unlink(e,function(a){b&&b(a)})}):b&&b(Error("decrypt error"))})})};
m.aio.syncmanager.RemoteUploader=function(d,b){var c=require("x.logger.js");this._logger=c?c.getLogger("RemoteUploader"):{log:function(){}};this._username=d.username?d.username:"";this._password=d.password?d.password:"";this._remotePassword=d.remotePassword?d.remotePassword:"";this._listener=b};m.aio.syncmanager.RemoteUploader.PROTOCOL="https";
m.aio.syncmanager.RemoteUploader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemoteUploader.prototype.upload=function(d,b,c,a){if(d)if(c){this._logger.log("debug","upload remote:"+c.id);var e=this;this._logger.log("trace","send upload remote request.");if(this._listener&&this._listener.onProgress)this._listener.onProgress(0,"start upload");this._doRemoteUploadReq(d,b,c,function(f,g){f?(e._logger.log("trace","send upload remote request error:"+f.stack),a&&a(f)):g.resources?(e._logger.log("trace","upload data one by one."),e._uploadResources(d,b,c,g,function(c,
b){c?a&&a(c):(e._logger.log("trace","send upload remote finish request."),e._finishUploadRemote(d,b,function(c){a&&a(c)}))})):a&&a(Error("server return format error"))})}else a&&a(Error("remote is null"));else a&&a(Error("license is empty"))};
m.aio.syncmanager.RemoteUploader.prototype._doRemoteUploadReq=function(d,b,c,a){var e=this,f=new m.aio.syncmanager.Assembler;if(this._listener&&this._listener.onProgress)this._listener.onProgress(1,"assemble files");f.generateRemoteUploadReq(b,c,function(c,b){if(c)e._logger.log("error","Error on generating remote upload request: "+c.message),a&&a(c);else{if(e._listener&&e._listener.onProgress)e._listener.onProgress(2,"inform server for upcoming upload");e._doPostRequest("/creatorneo/remote/requestUpload?license="+
d,null,JSON.stringify(b),function(c,b){if(c)a&&a(c);else try{var e=JSON.parse(b);a&&a(null,e)}catch(n){a&&a(n)}})}})};
m.aio.syncmanager.RemoteUploader.prototype._uploadResources=function(d,b,c,a,e){if(a&&a.resources){var f=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:a.credential.accessKeyId,secretAccessKey:a.credential.secretAccessKey,sessionToken:a.credential.sessionToken});if(this._listener&&this._listener.onProgress)this._listener.onProgress(3,"start to upload files",{filesCount:a.resources.length});var g=this;require("async").eachLimit(a.resources,5,function(a,e){if(a.exists&&
a.file&&"device_db"!=a.file){if(g._listener&&g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");e()}else if(a.file)a.file.match(/^resources.*/)?g._uploadFileToS3(f,b,c,a,function(c){a.success=c?!1:!0;if(g._listener&&g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");e(c)}):g._uploadFileToServer(d,b,c,a,function(c){a.success=c?!1:!0;if(g._listener&&g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");e(c)});else{a.success=!1;if(g._listener&&
g._listener.onProgress)g._listener.onProgress(4,"one file upload finish");e(Error("resource index has no file parameter"))}},function(c){e&&e(c,a)})}else e&&e(Error("no resource to upload in the req"))};
m.aio.syncmanager.RemoteUploader.prototype._uploadFileToServer=function(d,b,c,a,e){this._logger.log("trace","upload remote file:"+a.file);var f=this,g=require("fs"),h=require("path");c=c.getFolderPath();b=b.getFolderPath();switch(a.file){case "device_db":g.readFile(c+h.sep+a.file,function(c,b){if(c)e&&e(c);else{"device_db"==a.file&&f._remotePassword&&(b=f._encrypt(b,f._remotePassword));c="/creatorneo/remote/uploadFile?license="+d;var g={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),
"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};f._doPostRequest(c,g,b,function(c,b){c&&f._logger.log("trace","upload remote file "+a.file+" error:"+b);e&&e(c)})}});break;case "macros_db":case "deviceinfo.xml":g.readFile(b+h.sep+a.file,function(c,b){if(c)e&&e(c);else{"device_db"==a.file&&f._remotePassword&&(b=f._encrypt(b,f._remotePassword));c="/creatorneo/remote/uploadFile?license="+d;var g={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),
"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};f._doPostRequest(c,g,b,function(c,b){c&&f._logger.log("trace","upload remote file "+a.file+" error:"+b);e&&e(c)})}});break;default:g.readFile(c+h.sep+a.file,function(c,b){if(c)e&&e(c);else{c="/creatorneo/remote/uploadFile?license="+d;var g={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};f._doPostRequest(c,g,
b,function(c,b){c&&f._logger.log("trace","upload remote file "+a.file+" error:"+b);e&&e(c)})}})}};
m.aio.syncmanager.RemoteUploader.prototype._uploadFileToS3=function(d,b,c,a,e){this._logger.log("trace","upload remote resource:"+a.file);b=require("fs");var f=require("path");c=c.getFolderPath();var g=e;e=b.createReadStream(c+f.sep+a.file);e.on("error",function(a){g&&(g(a),g=null)});d.putObject({Bucket:"mediola-creator",Key:"resources/"+a.ref,Body:e},function(c){a.success=c?!1:!0;g&&(g(c),g=null)}).on("error",function(a){g&&(g(a),g=null)})};
m.aio.syncmanager.RemoteUploader.prototype._finishUploadRemote=function(d,b,c){if(this._listener&&this._listener.onProgress)this._listener.onProgress(5,"finalize the upload porcess");this._remotePassword&&(b.encrypt=this._encrypt(b.name,this._remotePassword));this._doPostRequest("/creatorneo/remote/finishUpload?license="+d,null,JSON.stringify(b),function(a,b){c&&c(a,b)})};
m.aio.syncmanager.RemoteUploader.prototype._doPostRequest=function(d,b,c,a){var e=a,f=JSON.parse(JSON.stringify(m.aio.syncmanager.RemoteUploader.OPTIONS));f.path+=d;f.method="POST";this._username&&this._password&&(f.auth=this._username+":"+this._password);b&&Object.keys(b).forEach(function(a){f.headers[a]=b[a]});var g="";d=require(m.aio.syncmanager.RemoteUploader.PROTOCOL).request(f,function(a){a.setEncoding("utf8");a.on("data",function(a){g+=a});a.on("end",function(){200==a.statusCode?e&&e(null,
g):e&&e(Error("http error with status code:"+a.statusCode),g);e=null})});d.on("error",function(a){e&&(e(a),e=null)});d.write(c);d.end()};m.aio.syncmanager.RemoteUploader.prototype._encrypt=function(d,b){return require("x.crypt.js").AES.encodeString(d,b).trim()};m.aio.syncmanager.Assembler=function(){};
m.aio.syncmanager.Assembler.prototype={generateRemoteDownloadRsp:function(d,b,c,a){var e=this;this._getRemoteDatabaseInfo(b,c,function(c,g){c?a&&a(c):(g&&g.forEach(function(a){a.file&&(a.ref="tenant/"+d.index+"/remote/"+b.index+"/"+a.file)}),e._getRemoteInfo(b,function(c,e){c?a&&a(c):(e.resources&&e.resources.forEach(function(a){a.file&&"device_db"!=a.file&&"macros_db"!=a.file&&"deviceinfo.xml"!=a.file&&(a.ref="tenant/"+d.index+"/remote/"+b.index+"/"+a.file,g.push(a))}),e.resources=g,a&&a(null,e))}))})},
generateRemoteUploadReq:function(d,b,c){this.generateRemoteDownloadRsp(d,b,"from_upload_req",c)},_getRemoteInfo:function(d,b){var c=require("unorm"),a=d.getFolderPath(),e={name:c.nfc(d.id),resources:[]};this._getFilesInfos(a,function(a,c){a?b&&b(a):(c&&(e.resources=c),b&&b(null,e))})},_getRemoteDatabaseInfo:function(d,b,c){var a=this,e=d.getFolderPath(),f=require("async"),g=require("fs"),h=require("fs-extra");f.parallel([function(c){var f=d.getDeviceFile();f?g.exists(f,function(d){d?a._getFileInfos(f,
e,function(a,e){if("from_download"==b)try{h.removeSync(f)}catch(q){}c(a,e)}):c()}):c()},function(c){var b=d.getMacrosFile();b?g.exists(b,function(d){d?a._getFileInfos(b,e,function(a,b){c(a,b)}):c()}):c()},function(c){var b=d.getDeviceinfoFile();b?g.exists(b,function(d){d?a._getFileInfos(b,e,function(a,b){c(a,b)}):c()}):c()}],function(a,b){var e=[];b&&b.forEach(function(a){a&&e.push(a)});c&&c(a,e)})},_getTenantDatabaseInfo:function(d,b){var c=this,a=d.getFolderPath(),e=require("async"),f=require("fs");
e.parallel([function(b){var e=d.getDeviceFile();e?f.exists(e,function(d){d?c._getFileInfos(e,a,function(a,c){b(a,c)}):b()}):b()},function(b){var e=d.getMacrosFile();e?f.exists(e,function(d){d?c._getFileInfos(e,a,function(a,c){b(a,c)}):b()}):b()},function(b){var e=d.getDeviceinfoFile();e?f.exists(e,function(d){d?c._getFileInfos(e,a,function(a,c){b(a,c)}):b()}):b()}],function(a,c){var e=[];c&&c.forEach(function(a){a&&e.push(a)});b&&b(a,e)})},_listAllFiles:function(d,b){var c=require("fs"),a=require("path"),
e=[],f=this,g=function(h,k){if(k>=h.length)b(null,e);else{var l=a.join(d,h[k]);c.stat(l,function(a,c){a?b(a,e):c.isDirectory()?f._listAllFiles(l,function(a,c){a?b(a,e):(Array.isArray(c)&&(e=e.concat(c)),g(h,k+1))}):(e.push(l),g(h,k+1))})}};c.readdir(d,function(a,c){a?b&&b(a,e):g(c,0)})},_getFilesInfos:function(d,b){var c=[],a=require("m.aio.configmanager.js").Page.FILE_EXT,e=require("async"),f=require("path"),g=this;this._listAllFiles(d,function(h,k){h?b&&b(h):e.eachLimit(k,50,function(b,e){if(0==
f.basename(b).indexOf("."))e();else{var h=b.replace(d,""),l=f.extname(h);"controls"==h.substr(1,8)&&l!==a.PAGE&&l!==a.POPUP?e():"resources_"==h.substr(1,10)?e():g._getFileInfos(b,d,function(a,b){a?e(a):(b&&c.push(b),e())})}},function(a){b&&b(a,c)})})},_getFileInfos:function(d,b,c){var a=require("fs"),e=require("path"),f=require("unorm");b=e.relative(b,d);b=f.nfc(b);d=f.nfc(d);"\\"==e.sep&&(b=b.replace(/\\/g,"/"));e=e.basename(d);var g={file:b,name:e},h=this;a.stat(d,function(a,b){a?c(a):b.isFile()?
(g.size=b.size,h._md5(d,function(a,b){a?c(a):(g.md5=b,h._sha1(d,function(a,b){a?c(a):(g.sha1=b,c(null,g))}))})):c(Error(d+" is not a file"))})},_md5:function(d,b){var c=require("fs"),a=require("crypto").createHash("md5"),e=c.createReadStream(d);e.on("readable",function(){for(var c;null!==(c=e.read());)a.update(c)}).on("end",function(){b(null,a.digest("base64"))})},_sha1:function(d,b){var c=require("fs"),a=require("crypto").createHash("sha1"),e=c.createReadStream(d);e.on("readable",function(){for(var c;null!==
(c=e.read());)a.update(c)}).on("end",function(){b(null,a.digest("base64"))})}};
m.aio.syncmanager.UserDBUploader=function(){var d=function(b,c){this._logger=require("x.logger.js").getLogger("UserDBUploader");this._username=b.username?b.username:"";this._password=b.password?b.password:"";this._listener=c};d.prototype.upload=function(b,c){if(b){var a=this;this._upload(b,function(b){if(b){if(a._logger.log("trace","upload user database error:"+b.stack),a._listener&&a._listener.onError)a._listener.onError({error:b.message,error_code:b.code})}else if(a._logger.log("trace","upload user database success"),
a._listener&&a._listener.onSuccess)a._listener.onSuccess(4);c&&c(b)})}else{if(this._listener&&this._listener.onError)this._listener.onError({error:"no such tenant",error_code:100});c&&c(Error("tenant is null"))}};d.prototype._upload=function(b,c){this._logger.log("debug","upload user db:"+b.index);var a=this;this._zipUserDB(b,function(b,d){b?(a._logger.log("trace","zip user database error:"+b.stack),c&&c(b)):(a._logger.log("trace","zip user database ok"),a._requestUpload(function(b,e){b?(a._logger.log("trace",
"send upload request error:"+b.stack),c&&c(b)):(a._logger.log("trace","send upload request ok"),a._uploadZip(d,e,function(b){b?(a._logger.log("trace","upload zip error:"+b.stack),c&&c(b)):(a._logger.log("trace","upload zip ok"),a._finishUpload(e.ref,function(b){b?a._logger.log("trace","finish user database upload error:"+b.stack):a._logger.log("trace","finish user database upload ok");c&&c(b)}))}))}))})};d.prototype._zipUserDB=function(b,c){var a=this;this._reportProgress(0,"zip user database",function(){a._logger.log("trace",
"zip the user database.");var e=require("path"),d=b.getDeviceFile(),g=b.getDeviceFile()+".enc",h=b.getMacrosFile();b.getDeviceinfoFile();var k=b.getFolderPath()+e.sep+"automation",l=require("m.aio.filemanager.js"),p=require("fs"),n=Math.round((new Date).getTime()/1E3),r=0;l=l.getTmpDir();for(var q=e.join(l,n+".zip");a._fileExistsSync(q);){r++;n++;if(10<r){c&&c(Error("can not create temp file"));return}q=e.join(l,n+".zip")}a._logger.log("trace","zip file:"+q);n=require("archiver");e=p.createWriteStream(q);
n=n("zip");e.on("error",function(b){a._logger.log("warn","create user database error:"+b.message);c&&(c(b),c=null)});e.on("close",function(){c&&(c(null,q),c=null)});n.pipe(e);a._fileExistsSync(d)&&n.append(p.createReadStream(d),{name:"device_db"});a._fileExistsSync(h)&&n.append(p.createReadStream(h),{name:"macros_db"});a._fileExistsSync(g)&&n.append(p.createReadStream(g),{name:"device_db.enc"});if(a._fileExistsSync(k))if(p.statSync(k).isDirectory())n.directory(k,"automation");else{d=Error("Automation folder is not a directory: "+
k);a._logger.log("error",d.message);c&&c(d);c=null;return}n.finalize()})};d.prototype._requestUpload=function(b){var c=this;this._reportProgress(1,"send upload request",function(){c._logger.log("trace","send upload user database request.");c._doRequest("POST","/creatorneo/userdb/requestUpload",null,null,function(a,c){if(c)try{c=JSON.parse(c)}catch(f){a=f,a.code=103}a||(c&&"success"==c.status?c.result&&c.result.ref&&c.result.credential||(a=Error("request upload response foramt error"),a.code=102):
(a=Error("request upload response error:"+c.message),a.code=101));a&&!a.code&&(a.code=100);b&&b(a,c&&c.result)})})};d.prototype._uploadZip=function(b,c,a){var e=this;this._reportProgress(2,"upload zip file",function(){e._logger.log("trace","upload zip file with ref:"+c.ref);var d=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:c.credential.accessKeyId,secretAccessKey:c.credential.secretAccessKey,sessionToken:c.credential.sessionToken}),g=require("fs");require("path");
var h=a;g=g.createReadStream(b);g.on("error",function(a){h&&(a.code=201,h(a),h=null)});d.putObject({Bucket:"mediola-creator",Key:"user_db/"+c.ref,Body:g},function(a){h&&(a&&(a.code=202),h(a),h=null)}).on("error",function(a){h&&(a.code=203,h(a),h=null)})})};d.prototype._finishUpload=function(b,c){var a=this;this._reportProgress(3,"finish upload",function(){a._logger.log("trace","finish upload zip file ref:"+b);a._doRequest("POST","/creatorneo/userdb/finishUpload?ref="+b,null,null,function(a,b){if(b)try{b=
JSON.parse(b)}catch(g){a=g,a.code=303}a||b&&"success"==b.status||(a=Error("request upload response error:"+b.message),a.code=301);a&&!a.code&&(a.code=300);c&&c(a)})})};d.prototype._reportProgress=function(b,c,a){if(this._listener&&this._listener.onProgress)this._listener.onProgress(b,c,null,a);else a&&a()};d.prototype._fileExistsSync=function(b){var c=require("fs");try{c.statSync(b)}catch(a){if("ENOENT"==a.code)return!1}return!0};d.prototype._doRequest=function(b,c,a,e,d){var f=d;d=require(m.aio.syncmanager.PROTOCOL);
var h={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};h.path+=c;h.method=b;this._username&&this._password&&(h.auth=this._username+":"+this._password);a&&Object.keys(a).forEach(function(c){h.headers[c]=a[c]});var k="";b=d.request(h,function(a){a.setEncoding("utf8");a.on("data",function(a){k+=a});a.on("end",function(){200==a.statusCode?f&&f(null,k):f&&f(Error("http error with status code:"+a.statusCode),k);f=null})});b.on("error",
function(a){f&&(f(a),f=null)});e&&b.write(e);b.end()};return d}();
m.aio.syncmanager.UserDBDownloader=function(){var d=function(b,c){this._logger=require("x.logger.js").getLogger("UserDBDownloader");this._username=b.username?b.username:"";this._password=b.password?b.password:"";this._listener=c};d.prototype.download=function(b,c){if(b){var a=this;this._download(b,function(b){if(b){if(a._logger.log("trace","download user database error:"+b.stack),a._listener&&a._listener.onError)a._listener.onError({error:b.message,error_code:b.code})}else if(a._logger.log("trace",
"download user database success"),a._listener&&a._listener.onSuccess)a._listener.onSuccess(4);c&&c(b)})}else{if(this._listener&&this._listener.onError)this._listener.onError({error:"no such tenant",error_code:100});c&&c(Error("tenant is null"))}};d.prototype._download=function(b,c){this._logger.log("debug","download user db:"+b.index);var a=this;this._requestDownload(function(d,f){d?(a._logger.log("trace","send download request error:"+d.stack),c&&c(d)):a._downloadZip(f,function(d,e){d?(a._logger.log("trace",
"download zip file error:"+d.stack),c&&c(d)):a._unzipFile(e,function(d,e){d?(a._logger.log("trace","unzip file error:"+d.stack),c&&c(d)):a._reloadUserDB(e,b,function(b){b&&a._logger.log("trace","reload user database error:"+b.stack);c&&c(b)})})})})};d.prototype._requestDownload=function(b){var c=this;this._reportProgress(0,"send download request",function(){c._logger.log("trace","send download user database request.");c._doRequest("GET","/creatorneo/userdb/requestDownload",null,null,function(a,c){if(c)try{c=
JSON.parse(c)}catch(f){a=f,a.code=103}a||(c&&"success"==c.status?c.result&&c.result.ref&&c.result.credential||(a=Error("request download response foramt error"),a.code=102):(a=Error("request download response error:"+c.message),a.code=101));a&&!a.code&&(a.code=100);b&&b(a,c&&c.result)})})};d.prototype._downloadZip=function(b,c){var a=this;this._reportProgress(1,"download zip file",function(){a._logger.log("trace","download zip file with ref:"+b.ref);var d=require("m.aio.filemanager.js"),f=require("path"),
g=require("fs"),h=Math.round((new Date).getTime()/1E3),k=0;d=d.getTmpDir();for(var l=f.join(d,h+".zip");a._fileExistsSync(l);){k++;h++;if(10<k){c&&c(Error("can not create temp file"));return}l=f.join(d,h+".zip")}a._logger.log("trace","zip file:"+l);(new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:b.credential.accessKeyId,secretAccessKey:b.credential.secretAccessKey,sessionToken:b.credential.sessionToken})).getObject({Bucket:"mediola-creator",Key:"user_db/"+b.ref},
function(a,b){a?(a.code=201,c&&c(a)):g.writeFile(l,b.Body,function(a){a&&(a.code=203);c&&c(a,l)})})})};d.prototype._unzipFile=function(b,c){var a=this;this._reportProgress(2,"unzip file",function(){var d=require("m.aio.filemanager.js"),f=require("path");require("fs");var g=Math.round((new Date).getTime()/1E3),h=0,k=d.getTmpDir();for(d=f.join(k,g+"");a._fileExistsSync(d);){h++;g++;if(10<h){f=Error("can not create temp folder");f.code=301;c&&c(f);return}d=f.join(k,g++)}a._logger.log("trace","unzip to folder:"+
d);try{require("fs-extra").ensureDirSync(d)}catch(l){l.code=201;c&&c(l);return}f=new (require("adm-zip"))(b);try{f.extractAllTo(d,!0),c&&c(null,d)}catch(l){l.code=202,c&&c(l)}})};d.prototype._reloadUserDB=function(b,c,a){var d=require("fs"),f=require("fs-extra"),g=this;this._reportProgress(3,"load user database",function(){var e=require("path"),k=c.getDeviceFile(),l=c.getDeviceFile()+".enc",p=c.getMacrosFile(),n=c.getDeviceinfoFile(),r=e.join(c.getFolderPath(),"automation"),q=e.join(b,"device_db"),
t=e.join(b,"device_db.enc"),u=e.join(b,"macros_db"),v=e.join(b,"deviceinfo.xml");e=e.join(b,"automation");g._copyFolder(e,r,function(b){b?(b.code=303,a&&a(b)):g._copyFile(v,n,function(b){b?(b.code=301,a&&a(b)):g._copyFile(u,p,function(b){if(b)b.code=302,a&&a(b);else{try{f.removeSync(l)}catch(w){}d.existsSync(t)?g._copyFile(t,l,function(b){if(b)b.code=302,a&&a(b);else{var d=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(c,function(){d.reloadTenant(c,function(){a&&a()})})}}):
g._copyFile(q,k,function(b){if(b)b.code=302,a&&a(b);else{var d=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(c,function(){d.reloadTenant(c,function(){a&&a()})})}})}})})})})};d.prototype._reportProgress=function(b,c,a){if(this._listener&&this._listener.onProgress)this._listener.onProgress(b,c,null,a);else a&&a()};d.prototype._fileExistsSync=function(b){var c=require("fs");try{c.statSync(b)}catch(a){if("ENOENT"==a.code)return!1}return!0};d.prototype._copyFile=function(b,
c,a){var d=require("fs");this._fileExistsSync(b)?d.readFile(b,function(b,e){b?a&&a(b):d.writeFile(c,e,function(b){a&&a(b)})}):d.writeFile(c,"",function(b){a&&a(b)})};d.prototype._copyFolder=function(b,c,a){var d=require("fs-extra"),f=this;d.remove(c,function(e){e?a&&a(e):f._fileExistsSync(b)?d.move(b,c,{overwrite:!0},function(b){a&&a(b)}):a&&a()})};d.prototype._doRequest=function(b,c,a,d,f){var e=f;f=require(m.aio.syncmanager.PROTOCOL);var h={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,
path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};h.path+=c;h.method=b;this._username&&this._password&&(h.auth=this._username+":"+this._password);a&&Object.keys(a).forEach(function(b){h.headers[b]=a[b]});var k="";b=f.request(h,function(a){a.setEncoding("utf8");a.on("data",function(a){k+=a});a.on("end",function(){200==a.statusCode?e&&e(null,k):e&&e(Error("http error with status code:"+a.statusCode),k);e=null})});b.on("error",function(a){e&&(e(a),e=null)});d&&b.write(d);b.end()};return d}();
m.aio.syncmanager.SyncManager=function(){this._configmanager=null};
m.aio.syncmanager.SyncManager.prototype={init:function(d,b,c,a){this._configmanager=d;b&&(m.aio.syncmanager.RemoteUploader.OPTIONS.host=b,m.aio.syncmanager.RemotesDownloader.OPTIONS.host=b,m.aio.syncmanager.RemoteDownloader.OPTIONS.host=b,m.aio.syncmanager.HOST=b);c&&0<c&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=c,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=c,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=c,m.aio.syncmanager.PORT=c,process&&"local"!=process.env.CLOUD&&80==c&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=
443,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=443,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=443,m.aio.syncmanager.PORT=443),process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=80,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=80,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=80,m.aio.syncmanager.PORT=80));process&&"local"==process.env.CLOUD?(m.aio.syncmanager.RemoteUploader.OPTIONS.path="/webservice",m.aio.syncmanager.RemotesDownloader.OPTIONS.path="/webservice",
m.aio.syncmanager.RemoteDownloader.OPTIONS.path="/webservice",m.aio.syncmanager.PATH="/webservice",m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL="http"):process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL=
"http");a&&a()},uploadRemote:function(d,b,c,a,e){if(c&&c.username&&c.password){var f=this;this._configmanager.trace("config/tenants/"+d,function(g,h){g?e&&e(g):h.license&&h.license.licenseTxt?f._configmanager.trace("config/tenants/"+d+"/remotes/"+b,function(b,d){if(b)e&&e(b);else{var f=require("m.aio.devicemanager.js");f.saveRemote(d,function(b){b?e&&e(b):(new m.aio.syncmanager.RemoteUploader(c,a)).upload(h.license.licenseTxt,h,d,function(a){f.clearRemoteDB(d,function(){e&&e(a)})})})}}):e&&e(Error("no license"))})}else e&&
e(Error("options format invalid"))},downloadRemote:function(d,b,c,a,e,f){a&&a.username&&a.password?this._configmanager.trace("config/tenants/"+d,function(d,h){if(d)f&&f(d);else if(h.license&&h.license.licenseTxt)if(h.isAccessible())if(d=(new m.aio.syncmanager.RemotesDownloader)._findRemote(b,c)){a.credential=c.credential;var g=h.getRemotes().getFolderPath();(new m.aio.syncmanager.RemoteDownloader(a,e)).download(g,d,function(a){a?f&&f(a):setTimeout(function(){h.reloadRemotes(function(a){f&&f(a)})},
100)})}else f&&f(Error("no such remote:"+b));else f&&f(Error("not permitted"));else f&&f(Error("no license"))}):f&&f(Error("options format invalid"))},downloadRemoteList:function(d,b,c){(new m.aio.syncmanager.RemotesDownloader(null,null,d,b)).downloadRemoteList(c)},testRemotePassword:function(d,b,c,a){if(d)if(b)if(c){var e=new m.aio.syncmanager.RemotesDownloader;(c=e._findRemote(d,c))?c.encrypt?(b=e._decrypt(c.encrypt,b),a&&a(null,b==d)):a&&a(null,!0):a&&a(Error("no such remote:"+d))}else a&&a(Error("info is null"));
else a&&a(Error("remote password is null"));else a&&a(Error("remote name is null"))},requestDownload:function(d){var b=this;this._configmanager.trace("config/tenants",function(c,a){if(c)d&&d(c);else{var e=null;a.getChildren()?(a.getChildren().forEach(function(a){a.isDefault()&&(e=a)}),e&&e.license&&!e.license.isTestLicense()&&e.license.valid?b.requestDownloadTenant(e.index,d):e&&e.license&&e.license.isTestLicense()?(c=Error("can not download from test license"),c.code=400,d&&d(c,null)):d&&d(null,
{infos:[]})):d&&d(null,{infos:[]})}})},requestDownloadTenant:function(d,b){this._configmanager.trace("config/tenants/"+d,function(c,a){if(c)b&&b(c);else if(a.isAccessible()){var e={infos:[]},f=a.getRemotes();f&&0!=f.size()?require("m.aio.devicemanager.js").deleteUnlicensed(d,function(c){if(c)b&&b(c);else{var d=0,g=new m.aio.syncmanager.Assembler;f.getChildren().forEach(function(c){g.generateRemoteDownloadRsp(a,c,"from_download",function(a,c){d+=1;a||e.infos.push(c);d==f.size()&&b&&b(null,e)})})}}):
b&&b(null,e)}else b&&b(Error("not permitted"))})},getTenantFile:function(d,b,c){d&&b?this._configmanager.trace("config/tenants/"+d,function(a,d){a?c&&c(a):(a=require("path"),b=b.replace(/\//g,a.sep),(d=d.getFolderPath())?c&&c(null,d+a.sep+b):c&&c(Error("tenant has no folder")))}):c&&c(Error("parameter invalid"))},getRemoteFile:function(d,b,c,a){d&&b&&c?this._configmanager.trace("config/tenants/"+d+"/remotes/"+b,function(b,d){b?a&&a(b):(b=require("path"),c=c.replace(/\//g,b.sep),(d=d.getFolderPath())?
a&&a(null,d+b.sep+c):a&&a(Error("remote has no folder")))}):a&&a(Error("parameter invalid"))},getRemoteDeviceDBData:function(d,b,c,a){d&&b&&c?require("m.aio.devicemanager.js").getDeviceDBForRemote(d,function(b,c){a&&a(b,c)}):a&&a(Error("parameter invalid"))},uploadUserDB:function(d,b,c,a){if(b&&b.username&&b.password)this._configmanager.trace("config/tenants/"+d,function(d,f){if(d){if(c&&c.onError)c.onError({error:d.message,error_code:100});a&&a(d)}else if(f.license&&f.license.licenseTxt)(new m.aio.syncmanager.UserDBUploader(b,
c)).upload(f,function(b){a&&a(b)});else{if(c&&c.onError)c.onError({error:"no license",error_code:100});a&&a(Error("no license"))}});else{if(c&&c.onError)c.onError({error:"options format invalid",error_code:100});a&&a(Error("options format invalid"))}},downloadUserDB:function(d,b,c,a){if(b&&b.username&&b.password)this._configmanager.trace("config/tenants/"+d,function(d,f){if(d){if(c&&c.onError)c.onError({error:d.message,error_code:100});a&&a(d)}else if(f.license&&f.license.licenseTxt)(new m.aio.syncmanager.UserDBDownloader(b,
c)).download(f,function(b){a&&a(b)});else{if(c&&c.onError)c.onError({error:"no license",error_code:100});a&&a(Error("no license"))}});else{if(c&&c.onError)c.onError({error:"options format invalid",error_code:100});a&&a(Error("options format invalid"))}},_downloadRemotes:function(d,b,c){b&&b.host&&b.port?(new m.aio.syncmanager.RemotesDownloader(b.host,b.port,b.username,b.password)).download(d,function(a){c&&c(a)}):c&&c(Error("options format invalid"))}};m.aio.syncmanager.Handler=m.aio.syncmanager.SyncManager;
m.aio.syncmanager.Handler.prototype.RemotesDownloader=m.aio.syncmanager.RemotesDownloader;m.aio.syncmanager.Handler.prototype.RemoteDownloader=m.aio.syncmanager.RemoteDownloader;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.syncmanager.Handler);
