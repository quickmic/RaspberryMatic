var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,b,a){e!=Array.prototype&&e!=Object.prototype&&(e[b]=a.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var e=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+e++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(e){var b=0;return $jscomp.iteratorPrototype(function(){return b<e.length?{done:!1,value:e[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,b){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var a=0,c={next:function(){if(a<e.length){var f=a++;return{value:b(f,e[f]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(e,b,a,c){if(b){a=$jscomp.global;e=e.split(".");for(c=0;c<e.length-1;c++){var f=e[c];f in a||(a[f]={});a=a[f]}e=e[e.length-1];c=a[e];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(a,e,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");$jscomp.owns=function(e,b){return Object.prototype.hasOwnProperty.call(e,b)};
$jscomp.polyfill("Object.values",function(e){return e?e:function(b){var a=[],c;for(c in b)$jscomp.owns(b,c)&&a.push(b[c]);return a}},"es8","es3");var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.Util={clearHttpOptionForLog:function(e){try{var b=JSON.parse(JSON.stringify(e));b.auth&&(b.auth="xxxxxx:xxxxxx");if(b.headers)for(var a in headers)if(a&&"authorization"==a.toLocaleLowerCase()){var c=headers[a];if(c){var f=c.indexOf(" ");headers[a]=-1==f?"xxxxxx":c.substr(0,f)+" xxxxxx"}}return b}catch(d){return e}}};
m.aio.voicemanager.CloudConfigHandler=function(){var e=function(a,c){this._devicemanager=a;this._macromanager=c};e.prototype._getCloudDeviceConfig=function(a,c,b){var d=null;if(c){var f=require("xnm.aio.cloudservice.js").resolveGateway(c);f?this._getCloudDevicesFromDB(a,f,function(c,a){c?b&&b(c):a&&0!=a.length?(c=a.map(function(c){c=c.info;delete c.gateway;delete c.commands;delete c.states;return c}),f.toCloudDevice(c,function(c,d){if(c)c.code=40003,b&&b(c);else if(d&&0!=d.length){c={};for(var f=
0;f<a.length;f++){var h=a[f];if(h)for(var k=0;k<d.length;k++){var g=d[k];g&&(g.data&&h.info.module==g.data.mod&&h.info.connection==g.data.connection&&h.info.id==g.data.id?(g.name=h.__cloudref,c[h.__cloudref]=g):h.info.module==g.mod&&h.info.connection==g.connection&&h.info.id==g.id&&(g.name=h.__cloudref,g.data={mod:g.mod,connection:g.connection,id:g.id},delete g.mod,delete g.connection,delete g.id,c[h.__cloudref]=g))}}b&&b(null,c)}else b&&b(null,{})})):b&&b(null,{})}):(d=Error("cloud json invalid"),
d.code=4E4,b&&b(d))}else d=Error("cloud json invalid"),d.code=4E4,b&&b(d)};e.prototype._mergeConfig=function(a,c){var b={},d;if(a)for(d in a)b[d]=a[d];if(c)for(d in c)b[d]=c[d];return b};e.prototype._getCloudDevicesFromDB=function(a,c,b){var d=function(c,a){for(var b=0;b<a.length;b++){var d=a[b];if(d&&d.index==c)return d}return null},f=this,k=require("xnm.aio.cloudservice.js"),g={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",a,"device",g,function(h,
l){h?(h.code=40001,b&&b(h)):l&&0!=l.length?(g={filter:"prop","info.sys":"cloudservice"},f._devicemanager.execute("read",a,"gateway",g,function(h,g){h?(h.code=40001,b&&b(h)):g&&0!=g.length?f._devicemanager.execute("read",a,"room",null,function(a,h){if(a)a.code=40001,b&&b(a);else if(h&&0!=h.length){a=[];for(var f=0;f<l.length;f++){var n=l[f];if(n&&n.info&&n.info.gateway){var e=d(n.info.gateway,g);if(e&&e.info&&(e=k.resolveGateway(e.info))){if(!e.equalsTo(c)){a=Error("cloud device "+n.index+" belongs to another account");
a.code=40002;b&&b(a);return}var q=d(n.room,h);q&&(e=n.name,q=q.name,e=(q?q+" ":"")+(e?e:""),n.cloud.alias&&(e=n.cloud.alias),n=JSON.parse(JSON.stringify(n)),n.__cloudref=e,a.push(n))}}}b&&b(null,a)}else b&&b(null,[])}):b&&b(null,[])})):b&&b(null,[])})};e.prototype._getCloudEnabledDevices=function(a,c){this._devicemanager.execute("read",a,"device",{filter:"prop","cloud.enabled":!0},function(a,b){c&&c(a,b)})};e.prototype._getGateways=function(a,c){this._devicemanager.execute("read",a,"gateway",null,
function(a,b){c&&c(a,b)})};e.prototype._getRooms=function(a,c){this._devicemanager.execute("read",a,"room",null,function(a,b){c&&c(a,b)})};e.prototype._getGatewayInfo=function(a,c){if(a)if("aio"!=a.sys&&"neoserver"!=a.sys)c&&c(Error("gateway type invalid"));else{var b=this,d=require("xnm.aio.gateway.js");if("neoserver"==a.sys){a=JSON.parse(JSON.stringify(a));a.sys="aio";a.version="EA";var l=d.resolveGateway(a,!0)}else l=d.resolveGateway(a);l?d.Admin.getGatewaySID(l,function(f,g){f?(b._logger.log("warn",
"get gateway sid error:"+f.message),f.code="50001",f.message="get gateway sid error:"+f.message,c&&c(f)):g?a.password?d.Admin.V5.getInfo(l,function(d,f){d?(b._logger.log("warn","get gateway info error:"+d.message),d.message="get gateway info error:"+d.message,d.code="50101",c&&c(d)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(b._logger.log("warn","gateway cloud server is deactivated"),d=Error("gateway cloud server is deactivated"),d.code="50103",c&&c(d)):b._getAccessToken(f.server,g,a.password,!1,
function(d,h){d?(d=Error("get accesss token error:"+d.message),d.code="50003",c&&c(d)):h?c&&c(null,h,f.server,g):b._getAccessToken(f.server,g,a.password,!0,function(a,b){a?(a=Error("generate accesss token error:"+a.message),a.code="50004",c&&c(a)):b?c&&c(null,b,f.server,g):c&&c(Error("access token empty"))})}):(b._logger.log("warn","gateway has no cloud server"),d=Error("gateway has no cloud server"),d.code="50102",c&&c(d))}):(f=Error("gateway has no password"),f.code="50002",c&&c(f)):(f=Error("gateway has no sid"),
f.code="50002",c&&c(f))}):c&&c(Error("gateway json invalid"))}else c&&c(Error("gateway json is null"))};e.prototype._getAccessToken=function(a,c,b,d,l){a=this._parseCCS(a);var f=a.port;"https"==a.protocol&&80==f&&(f=443);c={host:a.host,port:f,path:"/getAccessToken?sid="+c,method:"GET",timeout:3E4,auth:"user:"+b,user:"user",password:b,headers:{Authorization:"Basic "+(new Buffer("user:"+b)).toString("base64")}};d&&(c.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(c)));
var g=this,h=require(a.protocol).request(c,function(c){c.setEncoding("utf8");var a="";c.on("data",function(c){a+=c});c.on("end",function(){if(200==c.statusCode){g._logger.log("trace","get access token reponse:"+a);try{var b=JSON.parse(a);b.XC_ERR?l&&l(Error(b.XC_ERR.msg)):b.XC_SUC?l&&l(null,b.XC_SUC.at):l&&l(Error("invalid response"))}catch(r){l&&l(r)}}else g._logger.log("warn","get access token error +"+c.statusCode+":"+a),l&&l(Error("http response:"+c.statusCode))})});if(h.on)h.on("error",function(c){g._logger.log("warn",
"get access token error:"+c.message);l&&l(c);l=null});h.setTimeout&&h.setTimeout(5E3,function(){h.abort();g._logger.log("warn","get access token timeout");l&&l(Error("http timeout"));l=null});h.end()};e.prototype._parseCCS=function(a){var c=a.indexOf(":");if(-1==c)return{protocol:"https",host:a,port:443};var b=a.substr(0,c);a=a.substr(c+1);8080==a?a=8443:80==a&&(a=443);return{protocol:"https",host:b,port:a}};var b=function(a,c){e.call(this,a,c);this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler");
this._targetGatewayJSON=null;this._gatewayDetail={};this._currentMacroGatewayIndex=this._tenantIdx=null};b.prototype=new e;b.prototype.constructor=b;b.prototype.setTargetGateway=function(a){this._targetGatewayJSON=a};b.prototype.exportConfig=function(a,c,b){var d=this;this._gatewayDetail={};this._tenantIdx=a;this._currentMacroGatewayIndex=null;this._getCloudDeviceConfig(a,c,function(c,f){c?b&&b(c):d._getGatewayDeviceConfig(a,function(c,h){c?b&&b(c):d._getMacrosConfig(a,function(c,a){c?b&&b(c):(c=
d._mergeConfig(f,h),c=d._mergeConfig(a,c),b&&b(null,c))})})})};b.prototype._isSameAsTargetGateway=function(a){return this._targetGatewayJSON?a.ip==this._targetGatewayJSON.ip&&a.sid==this._targetGatewayJSON.sid:!1};b.prototype._getGatewayDeviceConfig=function(a,c){var b=function(c,a){if(!a||0==a.length)return null;for(var b=a.length;b--;){var d=a[b];if(d&&d.index==c)return d}return null},d=this;this._getDevicesDetail(a,function(a,f){if(a)c&&c(a);else{var g=f.devices,h=f.gateways,l=f.rooms,e={};for(a=
0;a<h.length;a++)(f=h[a])&&f.info&&"aio"==f.info.sys&&f.info.version&&!("C"!=f.info.version.charAt(0)&&"E"!=f.info.version.charAt(0)||"EA"==f.info.version||d._targetGatewayJSON&&!d._isSameAsTargetGateway(f.info))&&(e[f.index]=f);0==Object.keys(e)?c&&c(null,{}):d._getGatewaysDetail(Object.values(e),function(a){if(a)c&&c(a);else if(g&&0!=g.length){for(var f=[],k=0;k<g.length;k++)if((a=g[k])&&a.info&&"aio"==a.info.sys&&a.info.gateway){var n=b(a.info.gateway,h);if(n&&e[a.info.gateway]){var q=b(a.room,
l);f.push({device:a,gateway:n,room:q})}}if(0==f.length)c&&c(null,{});else{var p={};k=0;var x=function(a,b){!a&&b&&(p=d._mergeConfig(p,b));k++;k<f.length?d._genDeviceConfig(f[k].device,f[k].gateway,f[k].room,x):c&&c(null,p)};d._genDeviceConfig(f[k].device,f[k].gateway,f[k].room,x)}}else c&&c(null,{})})}})};b.prototype._genDeviceConfig=function(a,c,b,d){if(a&&a.info&&a.info.sys)if(c&&c.index){var f=this._gatewayDetail[c.index];if(f){var k=a.info.sys,g=this._devicemanager.getModule(k);g&&g.devicemanager&&
g.devicemanager.toGeneralDevice?(k=g.devicemanager.toGeneralDevice(a.info,null,"v5"))?(k.name=this._genDeviceName(a,b),k.local="http://"+c.info.ip+(c.info.port?":"+c.info.port:""),k.baseurl=this._genBaseUrl(f),k.data||(k.data={}),k.data.sid=f.sid,a={},a[k.name]=k,d&&d(null,a)):d&&d(null,null):d&&d(Error("sys "+k+" can not be convert to general device"))}else d&&d(Error("no gateway detail info"))}else d&&d(Error("invalid gateway json"));else d&&d(Error("invalid device json"))};b.prototype._genDeviceName=
function(a,c){if(a.cloud&&a.cloud.alias)return a.cloud.alias;a=a.name;c=c.name;return a?c?c+" "+a:a:c};b.prototype._genBaseUrl=function(a){var c=this._parseCCS(a.ccs);return c.protocol+"://"+c.host+"/rapi/"+a.token};b.prototype._getDevicesDetail=function(a,c){var b=this;this._getCloudEnabledDevices(a,function(d,f){d?c&&c(d):b._getGateways(a,function(d,g){d?c&&c(d):b._getRooms(a,function(a,b){c&&c(a,{devices:f,gateways:g,rooms:b})})})})};b.prototype._getGatewaysDetail=function(a,c){var b=this,d=0,
l=function(f,g,h,e){f?c&&c(f):(b._gatewayDetail[a[d].index]={sid:e,ccs:h,token:g},d++,d<a.length?b._getGatewayInfo(a[d].info,l):c&&c())};b._getGatewayInfo(a[d].info,l)};b.prototype._getMacrosConfig=function(a,c){var b=this;this._macromanager.execute(a,"read",null,null,null,function(a,f){if(a)c&&c(a);else if(f&&f.groups&&0!=f.groups.length){var d={};for(a=0;a<f.groups.length;a++){var g=f.groups[a];if(g&&g.macros&&0<g.macros.length){var h=0,e=function(a,c,f){!a&&c&&f&&(d[c]=f);h++;h<g.macros.length&&
b._getMacroConfig(g,g.macros[h],e)};b._getMacroConfig(g,g.macros[h],e)}}c&&c(null,d)}else c&&c(null,{})})};b.prototype._getMacroConfig=function(a,c,b){if(c&&c.cloud&&c.cloud.enabled){var d=a.name+" "+c.name;c.cloud.alias&&(d=c.cloud.alias);var f={name:d,type:"scene",commands:{on:{type:"POST",url:null,data:[]}}};this._currentMacroGatewayIndex=null;var e=this;if(c.commands&&0<c.commands.length){var g=0,h=function(a,l,k){!a&&l&&f.commands.on.data.push(l);g++;g<c.commands.length?e._convertMacroCommand(c.commands[g],
h):(a=e._gatewayDetail[e._currentMacroGatewayIndex])?(f.commands.on.url=e._genBaseUrl(a)+"/macro",b&&b(null,d,f)):b&&b(Error("no main gateway"))};this._convertMacroCommand(c.commands[g],h)}}else b&&b(null,null,null)};b.prototype._convertMacroCommand=function(a,c){if(a&&a.classid)switch(a.classid){case "sleep":c(null,{P:a.time});break;case "command":if(!a.action||!a.action.device){c(Error("invalid macro device command"));break}this._convertMacroDeviceCommand(a,c);break;default:c(Error("unknown macro command"))}else c(Error("invalid macro command"))};
b.prototype._convertMacroDeviceCommand=function(a,c){var b=this;this._devicemanager.execute("read",this._tenantIdx,"device",{filter:"prop",index:a.action.device.index},function(d,f){if(d)c(d);else if(f&&0!=f.length){var e=f[0];e&&e.info&&e.info.sys?"aio"==e.info.sys?b._devicemanager.execute("read",b._tenantIdx,"gateway",{filter:"prop",index:e.info.gateway},function(d,f){if(d)c(d);else if(f&&0!=f.length)if((d=f[0])&&d.info&&d.index)if(b._gatewayDetail[d.index]&&!b._currentMacroGatewayIndex&&(b._currentMacroGatewayIndex=
d.index),f=require("xnm.aio.gateway.js").devicemanager.getSystem(e.info,d.info)){var h={value:a.action.value,ext:a.action.ext};if(f.buildQuery)if(f=f.buildQuery(d.info,e.info,h)){h={};if("SendGenericCmd"==f.XC_FNC){var g="/cmd?XC_FNC=SendGenericCmd&id="+f.id;if(f.data)for(var l in f.data)g+="&"+l+"="+(null==f.data[l]||void 0==f.data[l]?"":encodeURIComponent(f.data[l]))}else if("/api/command"==f.fnc)g="/api/command?json=",f.data&&(g+=encodeURIComponent(JSON.stringify(f.data)));else for(l in g="/cmd?",
f)g+="&"+l+"="+(null==f[l]||void 0==f[l]?"":encodeURIComponent(f[l]));d.index==b._currentMacroGatewayIndex?h.C=g:h.A={host:d.info.ip,cmd:g};c(null,h)}else c(Error("invalid device command"));else c(Error("system do not support command"))}else c(Error("unknown device type"));else c(Error("invalid gateway json"));else c(Error("no such gateway"))}):c(null,null):c(Error("invalid device json"))}else c(Error("no such device"))})};return{V5:b}}();
m.aio.voicemanager.AlexaHandler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};e.LANG=["en","de"];e.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],
"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};e.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort","komfort"],"lamella up":["lamella up",
"lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};e.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off","off"],Auf:["up","up"],Ab:["down",
"down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up",
"up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off","led aus"],
"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};e.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};e.HUE_MAP={"color temperature":["color temperature","color temperatur"]};e.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};e.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};e.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};e.AV_MAP={stop:["stop","stop"]};e.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};e.NETATMO_MAP={manu:["value","value"]};e.FIBAROHC_MAP={"set value":["value","value"]};e.REMOTE_SERVER="https://cloud.mediola.com";e.prototype._getAccessToken=
function(b,a,c,f,d){b={host:require("url").parse("https://"+b).hostname,port:443,path:"/getAccessToken?sid="+a,method:"GET",timeout:3E4,auth:"user:"+c,user:"user",password:c,headers:{Authorization:"Basic "+(new Buffer("user:"+c)).toString("base64")}};f&&(b.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(b)));var e=this,k=require("https").request(b,function(a){a.setEncoding("utf8");var c="";a.on("data",function(a){c+=
a});a.on("end",function(){if(200==a.statusCode){e._logger.log("trace","get access token reponse:"+c);try{var b=JSON.parse(c);b.XC_ERR?d&&d(Error(b.XC_ERR.msg)):b.XC_SUC?d&&d(null,b.XC_SUC.at):d&&d(Error("invalid response"))}catch(q){d&&d(q)}}else e._logger.log("warn","get access token error +"+a.statusCode+":"+c),d&&d(Error("http response:"+a.statusCode))})});if(k.on)k.on("error",function(a){e._logger.log("warn","get access token error:"+a.message);d&&d(a);d=null});k.setTimeout&&k.setTimeout(5E3,
function(){k.abort();e._logger.log("warn","get access token timeout");d&&d(Error("http timeout"));d=null});k.end()};e.prototype._processHMCommands=function(b,a,c){return this._processCommandsFromMap(e.HM_MAP,b,a,c)};e.prototype._processAIOCommands=function(b,a,c){return this._processCommandsFromMap(e.AIO_MAP,b,a,c)};e.prototype._processSonosCommands=function(b,a,c){return this._processCommandsFromMap(e.SONOS_MAP,b,a,c)};e.prototype._processHueCommands=function(b,a,c){return this._processCommandsFromMap(e.HUE_MAP,
b,a,c)};e.prototype._processMilightCommands=function(b,a,c,f){return this._processCommandsFromMap(e.MILIGHT_MAP,b,a,c,f)};e.prototype._processOsramCommands=function(b,a,c){return this._processCommandsFromMap(e.OSRAM_MAP,b,a,c)};e.prototype._processHarmonyCommands=function(b,a,c,f){return this._processCommandsFromMap(e.HARMONY_MAP,b,a,c,f)};e.prototype._processMcontrolCommands=function(b,a,c){if(b&&b.info&&b.info.command){var f=JSON.parse(JSON.stringify(b.info.command));b.info.command=f;b.info.command.push({type:"enum",
name:"on",ref:{value:"do",ext:"on"}});b.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});b.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});b.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});b.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,b,a,c)};e.prototype._processFibaroHCCommands=function(b,a,c){if(c&&"blind"==c.type&&b&&b.info&&b.info.command){for(var f=JSON.parse(JSON.stringify(b.info.command)),
d=0;d<f.length;d++){var l=f[d];switch(l.name){case "open":l.name="up";break;case "close":l.name="down";break;case "up":l.name="step up";break;case "down":l.name="step down";break;case "stop":l.name="off"}}b.info.command=f}return this._processCommandsFromMap(e.FIBAROHC_MAP,b,a,c)};e.prototype._processAVCommands=function(b,a,c,f){return this._processCommandsFromMap(e.AV_MAP,b,a,c,f)};e.prototype._processTadoCommands=function(b,a,c){return this._processCommandsFromMap(e.TADO_MAP,b,a,c)};e.prototype._processNetatmoCommands=
function(b,a,c){return this._processCommandsFromMap(e.NETATMO_MAP,b,a,c)};e.prototype._processCommandsFromMap=function(b,a,c,f,d){c||(c="de");c=c.toLowerCase();for(var l={},k=e.LANG.indexOf(c),g=0;g<a.info.command.length;g++){var h=a.info.command[g];if("string"!=h.type||"aio"==a.info.sys&&"STRING"==a.info.type)if("root"==h.type)this._processRootCommandsFromMap(l,h,b,a,c,f,d);else{var n={type:"POST",url:"/cmd",original:h.name,data:{XC_FNC:"SendRM",device:a.index,command:JSON.parse(JSON.stringify(h.ref))}},
q=h.name.toLowerCase(),p=e.MAP[q]?e.MAP[q][k]:null;(q=b&&b[q]?b[q][k]:null)&&(p=q);var r=null;q=a.info.sys;if(this._customMap&&q&&this._customMap[q]){var t=this._customMap[q];r=t[h.name]?t[h.name][k]:null}r&&(p=r);if("%d"==h.ref.ext||"%f"==h.ref.ext||"%s"==h.ref.ext)n.data.command.ext="{val}","%f"==h.ref.ext&&(n["float"]=1),h.ref.extMeta&&(r=h.ref.extMeta.indexOf("-",1),-1!=r&&(q=parseFloat(h.ref.extMeta.substr(0,r)),r=parseFloat(h.ref.extMeta.substr(r+1)),n.min=q,n.max=r)),h.ref.scale&&(n.step=parseFloat(h.ref.scale)),
p||(p=h.name),"value"==p?l[p]=n:(f&&!f.values&&(f.values={}),f&&f.values&&(f.values[p]=n));else if("%e"==h.ref.ext){if(p||(p=h.name),h.ref.extMeta&&0<h.ref.extMeta.length)for(r=0;r<h.ref.extMeta.length;r++){var u=JSON.parse(JSON.stringify(n));u.data.command.ext=h.ref.extMeta[r];u.original+=" "+h.ref.extMeta[r];var v=p+" "+h.ref.extMeta[r];this._customMap&&q&&this._customMap[q]&&(t=this._customMap[q],(t=t[u.original]?t[u.original][k]:null)&&(v=t));l[v]=u}}else"rgb"==h.type||"rgbw"==h.type?(n=JSON.parse(JSON.stringify(n)),
n.data.command.ext="FF0000",l[e.MAP.red[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FF00FF",l[e.MAP.purple[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="0000FF",l[e.MAP.blue[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="00FFFF",l[e.MAP.cyan[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="00FF00",l[e.MAP.green[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FFFF00",l[e.MAP.yellow[k]]=n,n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FF8C00",
l[e.MAP.orange[k]]=n,"rgbw"==h.type&&(n=JSON.parse(JSON.stringify(n)),n.data.command.ext="FFFFFF",l[e.MAP.white[k]]=n)):(p||(p=h.name),l[p]=n,r&&(n.mappedCustom=!0))}}return l};e.prototype._processRootCommandsFromMap=function(b,a,c,f,d,l,k){d||(d="de");d=d.toLowerCase();d=e.LANG.indexOf(d);if(a&&a.value&&a.children&&0!=a.children.length){if("mainzone"!=a.value&&"global"!=a.value){b=l.name+" "+a.name;var g={name:b,type:l.type,sys:l.sys,baseurl:l.baseurl,commands:{}};k[b]=g;b=g.commands}for(k=0;k<a.children.length;k++)if(g=
a.children[k],("string"!=g.type||"aio"==f.info.sys&&"STRING"==f.info.type)&&"root"!=g.type){var h={type:"POST",url:"/cmd",original:g.name,data:{XC_FNC:"SendRM",device:f.index,command:JSON.parse(JSON.stringify(g.ref))}};h.data.command.path=[a.value];var n=g.name.toLowerCase(),q=e.MAP[n]?e.MAP[n][d]:null;(n=c&&c[n]?c[n][d]:null)&&(q=n);var p=null;n=f.info.sys;if(this._customMap&&n&&this._customMap[n]){var r=this._customMap[n];p=r[g.name]?r[g.name][d]:null}p&&(q=p);if("%d"==g.ref.ext||"%f"==g.ref.ext||
"%s"==g.ref.ext)h.data.command.ext="{val}","%f"==g.ref.ext&&(h["float"]=1),g.ref.extMeta&&(p=g.ref.extMeta.indexOf("-",1),-1!=p&&(n=parseFloat(g.ref.extMeta.substr(0,p)),p=parseFloat(g.ref.extMeta.substr(p+1)),h.min=n,h.max=p)),g.ref.scale&&(h.step=parseFloat(g.ref.scale)),q||(q=g.name),"value"!=q&&(l&&!l.values&&(l.values={}),l&&l.values&&(l.values[q]=h));else if("%e"==g.ref.ext){if(q||(q=g.name),g.ref.extMeta&&0<g.ref.extMeta.length)for(p=0;p<g.ref.extMeta.length;p++){var t=JSON.parse(JSON.stringify(h));
t.data.command.ext=g.ref.extMeta[p];t.original+=" "+g.ref.extMeta[p];var u=q+" "+g.ref.extMeta[p];this._customMap&&n&&this._customMap[n]&&(r=this._customMap[n],(r=r[t.original]?r[t.original][d]:null)&&(u=r));b[u]=t}}else"rgb"==g.type||"rgbw"==g.type?(h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF0000",b[e.MAP.red[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF00FF",b[e.MAP.purple[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="0000FF",b[e.MAP.blue[d]]=h,h=JSON.parse(JSON.stringify(h)),
h.data.command.ext="00FFFF",b[e.MAP.cyan[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="00FF00",b[e.MAP.green[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FFFF00",b[e.MAP.yellow[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF8C00",b[e.MAP.orange[d]]=h,"rgbw"==g.type&&(h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FFFFFF",b[e.MAP.white[d]]=h)):(q||(q=g.name),b[q]=h,p&&(h.mappedCustom=!0))}return b}};e.prototype._isDeviceHeater=function(b){var a="HM-CC-RT-DN;HM-CC-RT-DN-BoM;HM-CC-TC;ZEL STG RM FWT;HM-TC-IT-WM-W-EU;HMIP-WTH;HmIP-WTH-2;HMIP-eTRV;HmIP-eTRV-2;HmIP-eTRV-B;HmIP-STHD;HmIP-STH;HmIP-BWTH;HmIP-BWTH24;HM-CC-VG-1;HmIP-HEATING".split(";"),
c="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!b||!b.info)return!1;b=b.info;if("hm"==b.sys){if(-1!=a.indexOf(b.type))return!0}else if("aio"==b.sys)if("HM"==b.type){if(-1!=c.indexOf(b.data))return!0}else{if("FHT80b"==b.type)return!0}else if("max"==b.sys){if(1==b.type||2==b.type||3==b.type)return!0}else if("tado"==b.sys||"netatmo"==b.sys&&"NATherm1"==b.type)return!0;return!1};e.prototype._getDeviceCatagory=function(b){if(!b||!b.info)return null;
if(this._isDeviceHeater(b))return"heater";if(!b.info.command)return null;if("fibaro"==b.info.sys)return this._getFibaroHCDeviceCatagory(b);for(var a=b.info.command,c=!1,f=0;f<a.length;f++){var d=a[f];if(d&&d.name){d=d.name.toLowerCase();if(("hue"==b.info.sys||"osram"==b.info.sys)&&"brightness"==d)return"light";if("moveto"==d||"move to"==d||"position to"==d||"positionto"==d)return"blind";if("dimto"==d||"dim to"==d||"levelto"==d||"level to"==d)return"light";"on"==d&&(c=!0)}}return c||c?"switch":null};
e.prototype._getFibaroHCDeviceCatagory=function(b){b=b.info.command;for(var a=[],c=0;c<b.length;c++){var f=b[c];f&&f.name&&(f=f.name.toLowerCase(),-1==a.indexOf(f)&&a.push(f))}return-1!=a.indexOf("open")&&-1!=a.indexOf("close")?"blind":-1!=a.indexOf("up")&&-1!=a.indexOf("down")&&-1!=a.indexOf("set value")?"light":-1!=a.indexOf("on")&&-1!=a.indexOf("off")?"switch":null};e.prototype._convertDeviceToCloudFormat=function(b,a,c,f,d){var e=b.info.sys,k=b.info.type,g=this._getDeviceCatagory(b);g&&(k=g);
k={name:a,type:k,module:e,sys:e,baseurl:c,commands:{},states:{}};if("aio"==e&&"TASK"==b.info.type)return{name:a,type:"scene",module:e,sys:e,baseurl:c,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:b.index,command:{value:"run"}}}}};if(b.info.command&&0<b.info.command.length){switch(e){case "hm":a=this._processHMCommands(b,f,k,d);break;case "aio":a=this._processAIOCommands(b,f,k,d);break;case "sonos":a=this._processSonosCommands(b,f,k,d);break;case "hue":a=this._processHueCommands(b,
f,k,d);break;case "easyled":case "milight":case "milightv6":a=this._processMilightCommands(b,f,k,d);break;case "lightify":a=this._processOsramCommands(b,f,k,d);break;case "harmony":a=this._processHarmonyCommands(b,f,k,d);break;case "pioneer":case "onkyo":case "denon":case "yamaha":a=this._processHarmonyCommands(b,f,k,d);break;case "mcontrol":a=this._processMcontrolCommands(b,f,k,d);break;case "fibaro":a=this._processFibaroHCCommands(b,f,k,d);break;case "tado":a=this._processTadoCommands(b,f,k,d);
break;case "netatmo":a=this._processNetatmoCommands(b,f,k,d);break;default:a=this._processCommandsFromMap(null,b,f,k,d)}k.commands=a}b.info.status&&0<Object.keys(b.info.status).length&&(k.states=b.info.status);return k};e.prototype._resovleDeviceID=function(b,a,c){var f=b.name;c=c[b.room];if("_cameras"==f.substr(0,8)){c=null;var d=f.indexOf(":");f=f.substr(d+1)}"_progs&sysvars"==c&&(c=a[b.info.gateway],"gw"==f.substr(0,2)&&(d=f.indexOf("_"),f=f.substr(d+1)));a=(c?c+" ":"")+(f?f:"");b.cloud.alias&&
(a=b.cloud.alias);return a};e.prototype._resovleBaseUrl=function(b,a){var c=b,f=b.indexOf(":");-1!=f&&(c=b.substr(0,f));return"https://"+c+"/rapi/"+a};e.prototype.getAccessToken=function(b,a){if(b)if("aio"!=b.sys&&"neoserver"!=b.sys)a&&a(Error("gateway type invalid"));else{var c=this,f=require("xnm.aio.gateway.js");if("neoserver"==b.sys){b=JSON.parse(JSON.stringify(b));b.sys="aio";b.version="EA";var d=f.resolveGateway(b,!0)}else d=f.resolveGateway(b);d?f.Admin.getGatewaySID(d,function(e,k){e?(c._logger.log("warn",
"get gateway sid error:"+e.message),e.code="50001",e.message="get gateway sid error:"+e.message,a&&a(e)):k?b.password?f.Admin.V5.getInfo(d,function(d,f){d?(c._logger.log("warn","get gateway info error:"+d.message),d.message="get gateway info error:"+d.message,d.code="50101",a&&a(d)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(c._logger.log("warn","gateway cloud server is deactivated"),d=Error("gateway cloud server is deactivated"),d.code="50103",a&&a(d)):c._getAccessToken(f.server,k,b.password,!1,
function(d,e){d?(d=Error("get accesss token error:"+d.message),d.code="50003",a&&a(d)):e?a&&a(null,e,f.server,k):c._getAccessToken(f.server,k,b.password,!0,function(c,b){c?(c=Error("generate accesss token error:"+c.message),c.code="50004",a&&a(c)):b?a&&a(null,b,f.server,k):a&&a(Error("access token empty"))})}):(c._logger.log("warn","gateway has no cloud server"),d=Error("gateway has no cloud server"),d.code="50102",a&&a(d))}):(e=Error("gateway has no password"),e.code="50002",a&&a(e)):(e=Error("gateway has no sid"),
e.code="50002",a&&a(e))}):a&&a(Error("gateway json invalid"))}else a&&a(Error("gateway json is null"))};e.prototype.generateConfig=function(b,a,c,f,d,e,k,g,h,n){var l=require("url").parse("https://"+g),p=function(a){for(var c=a.length,b={};c--;){var d=a[c];b[d.index]=d.name}return b}(a),r=function(a){for(var c=a.length,b={};c--;){var d=a[c];b[d.index]=d.name}return b}(c);c={};g=this._resovleBaseUrl(g,e);a=h=null;for(var t=0;t<b.length;t++){var u=b[t];!u||!u.info||"cloudservice"==u.info.sys&&u.info.module||
"_webpages"==u.name.substr(0,9)||(h=this._resovleDeviceID(u,r,p),a=this._convertDeviceToCloudFormat(u,h,g,d,c),a.data={mod:"mediola",ccs:l.hostname,accessToken:e,deviceID:u.index},c[h]=a)}b={};d=null;if(f&&f.groups)for(e=0;e<f.groups.length;e++)if((l=f.groups[e])&&l.macros&&0!=l.macros.length)for(p=l.name,r=0;r<l.macros.length;r++)if(a=l.macros[r],h=a.name,a.cloud&&a.cloud.enabled){h=(p?p+" ":"")+(h?h:"");a.cloud.alias&&(h=a.cloud.alias);d="";t=h.toLowerCase();u="on off an aus up down auf ab hoch runter ein".split(" ");
for(var v=0;v<u.length;v++){var w=u[v],x=t.substr(t.length-w.length);t.length>w.length&&x==w&&(d=h.substr(0,t.length-w.length).trim(),b[d]||(b[d]=[]),b[d].push({original_id:h,command:w}))}a={name:h,type:"scene",baseurl:g,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:l.index,macroIdx:a.index}}}};c[h]=a}for(d in b){f=b[d];a={name:d,type:"scene",baseurl:g,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{}};for(h=0;h<f.length;h++)if((e=
f[h])&&e.original_id&&e.command&&(l=e.original_id,p=c[l],delete c[l],p)){l=p.commands.on;p=e.command;switch(e.command){case "on":case "an":case "ein":p="on";break;case "off":case "aus":p="off";break;case "up":case "auf":case "hoch":p="up";break;case "down":case "ab":case "runter":p="down"}a.commands[p]=l}c[d]=a}n&&n(null,c)};e.prototype.uploadConfig=function(b,a,c){a={type:"mediola",configuration:a};var f=b.ip;f||(f=require("url").parse(e.REMOTE_SERVER).host);var d=b.port;d||(d=443);var l=b.username?
b.username:"";b=b.password?b.password:"";b={host:f,port:d,path:"/alexa/setConfiguration",method:"POST",timeout:3E4,auth:l+":"+b,user:l,password:b,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(l+":"+b)).toString("base64"),Connection:"close"}};var k=this;this._logger.log("trace","upload config to:"+JSON.stringify(b));b=require("https").request(b,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){k._logger.log("trace",
"upload config reponse:"+b);try{var d=JSON.parse(b);if(d.XC_ERR){var f=Error(d.XC_ERR.msg);f.code=d.XC_ERR.code;c&&c(f)}else d.XC_SUC&&c&&c()}catch(p){c&&c(p)}}else k._logger.log("warn","upload config error +"+a.statusCode+":"+b),c&&c(Error("http response:"+a.statusCode))})});if(b.on)b.on("error",function(a){k._logger.log("warn","upload config error:"+a.message);c&&c(a);c=null});b.write(JSON.stringify(a));b.end()};e.prototype.setCustomCommandMap=function(b){this._customMap=b};e.prototype.loadCustomComamndMap=
function(b,a){var c=require("fs-extra");c.ensureFile(b,function(f){f?a&&a(null,{}):c.readFile(b,"utf8",function(c,b){if(c)a&&a(c);else if(b)try{var d=JSON.parse(b);a&&a(null,d)}catch(g){a&&a(null,{})}else a&&a(null,{})})})};e.prototype.saveCustomCommandMap=function(b,a,c){var f=require("fs-extra");f.ensureFile(b,function(d){if(d)c&&c(null,{});else try{var e=JSON.stringify(a,null,2);f.writeFile(b,e,function(a){c&&c(a)})}catch(k){c&&c(k)}})};return e}();
m.aio.voicemanager.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};e.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";e.prototype.init=function(b,a,c,f){this._configmanager=b;this._devicemanager=a;this._macromanager=
c;f&&f()};e.prototype.loadCustomComamndMap=function(b,a){var c=this;this._configmanager.trace("/config/tenants/"+b,function(b,d){b?(b.code="50100",a&&a(b)):(b=require("path"),(d=d.getFolderPath())?(d=b.join(d,c.CUSTOM_CMD_MAP_FILE),c._alexaHandler.loadCustomComamndMap(d,function(b,c){a&&a(b,c)})):(b=Error("tenant folder is null"),b.code="50100",a&&a(b)))})};e.prototype.saveCustomComamndMap=function(b,a,c){var f=this;this._configmanager.trace("/config/tenants/"+b,function(b,e){b?(b.code="50100",c&&
c(b)):(b=require("path"),e=e.getFolderPath(),e=b.join(e,f.CUSTOM_CMD_MAP_FILE),f._alexaHandler.saveCustomCommandMap(e,a,function(a){c&&c(a)}))})};e.prototype.getCloudDeviceConfig=function(b,a,c){var f=null;if(a){var d=require("xnm.aio.cloudservice.js").resolveGateway(a);d?this._getCloudDevicesFromDB(b,d,function(a,b){a?c&&c(a):b&&0!=b.length?(a=b.map(function(a){a=a.info;delete a.gateway;delete a.commands;delete a.states;return a}),d.toCloudDevice(a,function(a,d){if(a)a.code=40003,c&&c(a);else if(d&&
0!=d.length){a={};for(var f=0;f<b.length;f++){var e=b[f];if(e)for(var h=0;h<d.length;h++){var g=d[h];g&&(g.data&&e.info.module==g.data.mod&&e.info.connection==g.data.connection&&e.info.id==g.data.id?(g.name=e.__cloudref,a[e.__cloudref]=g):e.info.module==g.mod&&e.info.connection==g.connection&&e.info.id==g.id&&(g.name=e.__cloudref,g.data={mod:g.mod,connection:g.connection,id:g.id},delete g.mod,delete g.connection,delete g.id,a[e.__cloudref]=g))}}c&&c(null,a)}else c&&c(null,{})})):c&&c(null,{})}):(f=
Error("cloud json invalid"),f.code=4E4,c&&c(f))}else f=Error("cloud json invalid"),f.code=4E4,c&&c(f)};e.prototype._getCloudDevicesFromDB=function(b,a,c){var f=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d&&d.index==a)return d}return null},d=this,e=require("xnm.aio.cloudservice.js"),k={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",b,"device",k,function(g,h){g?(g.code=40001,c&&c(g)):h&&0!=h.length?(k={filter:"prop","info.sys":"cloudservice"},
d._devicemanager.execute("read",b,"gateway",k,function(g,k){g?(g.code=40001,c&&c(g)):k&&0!=k.length?d._devicemanager.execute("read",b,"room",null,function(b,d){if(b)b.code=40001,c&&c(b);else if(d&&0!=d.length){b=[];for(var g=0;g<h.length;g++){var l=h[g];if(l&&l.info&&l.info.gateway){var n=f(l.info.gateway,k);if(n&&n.info&&(n=e.resolveGateway(n.info))){if(!n.equalsTo(a)){b=Error("cloud device "+l.index+" belongs to another account");b.code=40002;c&&c(b);return}var p=f(l.room,d);p&&(n=l.name,p=p.name,
n=(p?p+" ":"")+(n?n:""),l.cloud.alias&&(n=l.cloud.alias),l=JSON.parse(JSON.stringify(l)),l.__cloudref=n,b.push(l))}}}c&&c(null,b)}else c&&c(null,[])}):c&&c(null,[])})):c&&c(null,[])})};e.prototype.previewAlexaConfig=function(b,a,c,f,d){if(c&&c.username)if(f)if(f.version&&"C"==f.version.charAt(0)){var e=new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager);e.setTargetGateway(f);e.exportConfig(b,c,function(a,b){d&&d(a,b)})}else{var k=this;this.getCloudDeviceConfig(b,c,
function(c,e){c?d&&d(c):k._alexaHandler.getAccessToken(f,function(c,g,h,l){c?d&&d(c):k._getDeviceWithCommandAndStatus(b,function(c,n){c?(c.code="50005",d&&d(c)):k._devicemanager.execute("read",b,"gateway",null,function(c,p){c?(c.code="50007",d&&d(c)):k._devicemanager.execute("read",b,"room",null,function(c,q){c?(c.code="50008",d&&d(c)):k._macromanager.execute(b,"read",null,null,null,function(c,r){c?(c.code="50009",d&&d(c)):k.loadCustomComamndMap(b,function(b,c){if(b||!c)c=null;k._alexaHandler.setCustomCommandMap(c);
k._alexaHandler.generateConfig(n,q,p,r,a,g,f,h,l,function(a,b){if(a)k._logger.log("warn","generate configuration error:"+a.message),a.code="50010",d&&d(a);else{a={};var c;if(e)for(c in e)a[c]=e[c];if(b)for(c in b)a[c]=b[c];(b=Object.keys(a))&&0!=b.length?d&&d(null,a):(k._logger.log("warn","generate empty configuration"),a=Error("empty configuration"),a.code="50011",d&&d(a))}})})})})})})})})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};e.prototype.exportAlexaConfig=function(b,
a,c,f,d){if(c&&c.username)if(f){var e=this;this.previewAlexaConfig(b,a,c,f,function(a,f){if(a)d&&d(a);else{var h={};if(f)for(var g in f)a=f[g],delete a.sys,delete a.module,h[g]=a;e._configmanager.execute("read","/config/tenants/"+b,null,function(a,b){if(a)a.code="50013",d&&d(a);else{var f=null;b.license&&"normal"==b.license.type&&b.license.valid&&b.license.license&&(f=b.license.license);e._alexaHandler.uploadConfig(c,h,function(a){a?(e._logger.log("warn","upload configuration error:"+a.message),a.code=
"000009"==a.code?"50014":"50012",d&&d(a)):f?e.bindLicense(c.username,c.password,f,function(a){a&&e._logger.log("warn","bind user license error:"+a.message);d&&d(null,h)}):d&&d(null,h)})}})}})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};e.prototype._getDeviceWithCommandAndStatus=function(b,a){var c={filter:"prop","cloud.enabled":!0},f=this,d={};this._devicemanager.execute("read",b,"device",{filter:"ui",f_ui_elem:"*",f_ui_type:"command"},function(e,k){if(e)a(e);else{if(k&&
0<k.length)for(e=0;e<k.length;e++){var g=k[e];g&&g.cloud&&g.cloud.enabled&&g.info&&g.info.command&&0!=g.info.command.length&&(d[g.index]=g)}f._devicemanager.execute("read",b,"device",c,function(c,e){if(c)a(c);else if(e&&0!=e.length){var g=0,h=function(c,k){!c&&k&&(d[e[g].index]?d[e[g].index].info.status=k.states:(d[e[g].index]=e[g],e[g].info.status=k.states));g++;g<e.length?f._devicemanager.toGeneralDevice(b,e[g].index,!1,h):(c=Object.values(d),a(null,c))};f._devicemanager.toGeneralDevice(b,e[g].index,
!1,h)}else c=Object.values(d),a(null,c)})}})};e.prototype.bindLicense=function(b,a,c,f){a={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+c,method:"GET",timeout:3E4,auth:b+":"+a,user:b,password:a,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(b+":"+a)).toString("base64"),Connection:"close"}};var d=this;this._logger.log("trace","bind license "+c+" to:"+b);b=require(this.CLOUD_PROTOCOL).request(a,function(a){a.setEncoding("utf8");var b=
"";a.on("data",function(a){b+=a});a.on("end",function(){200==a.statusCode?(d._logger.log("trace","bind license success"),f&&f()):(d._logger.log("warn","bind license success +"+a.statusCode+":"+b),f&&f(Error("http response:"+a.statusCode)));f=null})});if(b.on)b.on("error",function(a){d._logger.log("warn","upload config error:"+a.message);f&&f(a);f=null});b.setTimeout(3E4,function(){f&&f(Error("timeout"));f=null});b.end()};e.prototype.uploadDeviceDB=function(b,a,c,f){this._uploadFile(b,a,"device_db",
c,f)};e.prototype.uploadMacroDB=function(b,a,c,f){this._uploadFile(b,a,"macros_db",c,f)};e.prototype._uploadFile=function(b,a,c,f,d){b="/xhub/xhubsync/upload2?gatewayid="+b+"&fileName="+c+"&auth=";a.password&&(b+=a.password);a={host:a.ip,port:a.port,path:b,method:"POST",timeout:3E4,headers:{"Content-Type":"text/plain",Connection:"close"}};var e=this;this._logger.log("trace","upload "+c+" to:"+JSON.stringify(a));a=require("http").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=
a});a.on("end",function(){if(200==a.statusCode){e._logger.log("trace","upload "+c+" reponse:"+b);try{"success"==JSON.parse(b).status?d&&d():d&&d(Error("failed to upload "+c))}catch(h){d&&d(h)}}else e._logger.log("warn","upload "+c+" error +"+a.statusCode+":"+b),d&&d(Error("http response:"+a.statusCode))})});if(a.on)a.on("error",function(a){e._logger.log("warn","upload "+c+" error:"+a.message);d&&d(a);d=null});a.write(JSON.stringify(f));a.end()};e.prototype.exportV5Config=function(b,a,c,e,d){if(c&&
c.username)if(e){var f=this;(new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager)).exportConfig(b,c,function(a,e){a?(f._logger.log("error","generate configuration error:"+a.message),a.code="50012",d&&d(a)):f._configmanager.execute("read","/config/tenants/"+b,null,function(a,b){if(a)a.code="50013",d&&d(a);else{var g=null;b.license&&"normal"==b.license.type&&b.license.valid&&b.license.license&&(g=b.license.license);f._alexaHandler.uploadConfig(c,e,function(a){a?(f._logger.log("warn",
"upload configuration error:"+a.message),a.code="000009"==a.code?"50014":"50012",d&&d(a)):g?f.bindLicense(c.username,c.password,g,function(a){a&&f._logger.log("warn","bind user license error:"+a.message);d&&d(null,e)}):d&&d(null,e)})}})})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
