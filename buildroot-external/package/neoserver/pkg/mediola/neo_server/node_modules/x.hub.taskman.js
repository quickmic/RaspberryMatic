var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(d,b,c){if(null==d)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return d+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,c){d!=Array.prototype&&d!=Object.prototype&&(d[b]=c.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,b,c,f){if(b){c=$jscomp.global;d=d.split(".");for(f=0;f<d.length-1;f++){var k=d[f];k in c||(c[k]={});c=c[k]}d=d[d.length-1];f=c[d];b=b(f);b!=f&&null!=b&&$jscomp.defineProperty(c,d,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("String.prototype.repeat",function(d){return d?d:function(b){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var f="";b;)if(b&1&&(f+=c),b>>>=1)c+=c;return f}},"es6","es3");var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),Logger=require("x.logger.js"),deviceman=require("x.hub.deviceman.js"),fileman=require("x.hub.fileman.js"),x=x||{};
x.hub=x.hub||{};x.hub.taskman=x.hub.taskman||{};x.hub.taskman.ERROR_CODE={General_Error:"100000",Pin_Error:"100001"};
x.hub.taskman.Cloud=function(){var d=function(){};d.prototype.URL="https://webservice.mediola.com";d.prototype._doRequest=function(b,c,f,k,d,a,g){c=require("url").parse(this.URL+c);b={host:c.hostname,port:c.port,path:c.path,method:b,headers:k};if(d||a)b.auth=(d?d:"")+":"+(a?a:"");d=require("http");"https:"==c.protocol?(d=require("https"),process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),b.port||(b.port=443)):b.port||(b.port=80);var l=g;g=d.request(b,function(a){var c="";a.on("data",
function(a){c+=a});a.on("end",function(){var b=null;200!=a.statusCode&&(b=Error("http response error"));l&&l(b,c,a.statusCode,a.headers)})});g.setTimeout(5E3,function(){l&&l(Error("timeout"));l=null});g.on("error",function(a){l&&l(a);l=null});f&&g.write(f);g.end()};return d}();
x.hub.taskman._Util={TimeZone_MAP:[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"CET"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},
{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,
dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},
{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],_getTimeZone:function(){var d="8C";localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));d=parseInt(d,16);var b=0!=(d&128),c=(d&31)-11,f=null;this.TimeZone_MAP.forEach(function(k){k.utc==
c&&k.dst==b&&(f=k.zone)});f||(f="Europe/Berlin");return f},_getlatlong:function(){var d="1392",b="035C";localStorage.getItem("x.hub.Server.geo.lat")&&(d=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(b=localStorage.getItem("x.hub.Server.geo.long"));d=parseInt(d,16);32768<d&&(d=32768-d);d/=100;b=parseInt(b,16);32768<b&&(b=32768-b);return{lat:d,long:b/100}}};
x.hub.taskman._TimerManager=function(){var d=function(c,b){this._logger=require("x.logger.js").getLogger("x.hub.taskman._TimerManager.CronTimer");this.taskID=c;this.timer=b;this._cronJob=null};d.prototype.start=function(){if(this.timer.time){var c=[],b=this.timer.time.indexOf(":"),k=this.timer.time.substr(0,b);b=this.timer.time.substr(b+1);c.push("00");c.push(b);c.push(k);c.push("*");c.push("*");k="0-6";if(this.timer.week&&7==this.timer.week.length){k=[];"1"==this.timer.week.charAt(6)&&k.push(0);
for(b=0;6>b;b++)"1"==this.timer.week.charAt(b)&&k.push(b+1);k=k.join(",")}c.push(k);c=c.join(" ");k=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+c+" tz:"+k);this._cronJob=new (require("cron").CronJob)(c,this.onTick.bind(this),null,!0,k)}};d.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=
null)};d.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" timer tick:"+JSON.stringify(this.timer));var c=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),k=(new Date).getTime();k=c.tz(k,b);var d=k.year(),a=!1,g=!1,l=null,p=null;k=k.valueOf();var m=this.timer.start;m&&("00"==m.substr(0,2)&&(a=!0,m=d+m.substr(2)),m=c.tz(m,b),m.set({hour:0,minute:0,second:0,millisecond:0}),l=m.valueOf());var r=this.timer.end;r&&("00"==r.substr(0,2)&&(g=!0,r=d+r.substr(2)),r=c.tz(r,
b),r.set({hour:23,minute:59,second:59,millisecond:999}),p=r.valueOf());if(a&&g&&l>p){if(p<k&&l>k)return}else if(m&&l>k||r&&p<k)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID)};d.prototype.onLocationChange=function(){this.stop();this.start()};d.prototype.onTimeChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(c,b){c=new d(c,b);this._timers.push(c);c.start()};b.prototype.stopTimer=function(c){var b=[];this._timers.forEach(function(f){f.taskID==
c?f.stop():b.push(f)});this._timers=b};b.prototype.onLocationChange=function(){this._timers.forEach(function(c){c.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(c){c.onTimeChange()})};b.prototype.clear=function(){var c=this._timers;this._timers=[];c.forEach(function(c){c.stop()})};return new b}();
x.hub.taskman._AstroManager=function(){var d=function(c,b){this._logger=require("x.logger.js").getLogger("x.hub.taskman._AstroManager.AstroTimer");this.taskID=c;this.astro=b;this._job=null};d.prototype.start=function(){this.astro.astro&&(this._logger.log("debug","#"+this.taskID+" start astro:"+JSON.stringify(this.astro)),this._startNextTick())};d.prototype.stop=function(){this._logger.log("debug","stop astro:"+JSON.stringify(this.astro));this._job&&(clearTimeout(this._job),this._job=null)};d.prototype._startNextTick=
function(){var c=this._getNextTickTime();this._logger.log("debug","#"+this.taskID+" next "+this.astro.astro+":"+new Date(c));var b=(new Date).getTime(),d=this;this._job=setTimeout(function(){try{d.onTick()}catch(h){}d._startNextTick()},c-b)};d.prototype._getNextTickTime=function(){var c=x.hub.taskman._Util._getlatlong(),b=require("suncalc"),d=new Date,h=b.getTimes(d,c.lat,c.long);h="sunrise"==this.astro.astro?h.sunrise:h.sunset;h=h.getTime();this.astro.delay&&(h+=6E4*parseInt(this.astro.delay));h<=
d.getTime()&&(d=new Date(d.getTime()+864E5),h=b.getTimes(d,c.lat,c.long),h="sunrise"==this.astro.astro?h.sunrise:h.sunset,h=h.getTime(),this.astro.delay&&(h+=6E4*parseInt(this.astro.delay)));return h};d.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" astro tick:"+JSON.stringify(this.astro));var b=require("moment-timezone"),f=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=b.tz(d,f);var h=d.year();if(this.astro.offTime){var a=this.astro.offTime.indexOf(":"),g=this.astro.offTime.substr(0,
a);a=this.astro.offTime.substr(a+1);g=parseInt(g);a=parseInt(a);if(d.hour()<g||d.hour()==g&&d.minute()<=a)return}g=d.day();0==g&&(g=7);if(!this.astro.week||7!=this.astro.week.length||"0"!=this.astro.week.charAt(g-1)){if(g=this.astro.start)if("00"==g.substr(0,2)&&(g=h+g.substr(2)),g=b.tz(g,f),g.set({hour:0,minute:0,second:0,millisecond:0}),g.valueOf()>d.valueOf())return;if(g=this.astro.end)if("00"==g.substr(0,2)&&(g=h+g.substr(2)),g=b.tz(g,f),g.set({hour:23,minute:59,second:59,millisecond:999}),g.valueOf()<
d.valueOf())return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.astro))}};d.prototype.onLocationChange=function(){this.stop();this.start()};d.prototype.onTimeChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(b,f){b=new d(b,f);this._timers.push(b);b.start()};b.prototype.stopTimer=function(b){var c=[];this._timers.forEach(function(f){f.taskID==b?f.stop():c.push(f)});this._timers=c};b.prototype.onLocationChange=
function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};b.prototype.clear=function(){var b=this._timers;this._timers=[];b.forEach(function(b){b.stop()})};b.prototype.getSunriseSunset=function(b){var c=require("moment-timezone"),d=x.hub.taskman._Util._getTimeZone();b=c.tz(b,d);b.set({hour:12,minute:0,second:0,millisecond:0});c=x.hub.taskman._Util._getlatlong();return require("suncalc").getTimes(b.toDate(),
c.lat,c.long)};return new b}();
x.hub.taskman._PeriodicTimerManager=function(){var d=function(b,f){this._logger=require("x.logger.js").getLogger("x.hub.taskman._PeriodicTimerManager.CronTimer");this.taskID=b;this.timer=f;this._repeater=this._cronJob=this._starter=null};d.prototype.start=function(){if(this.timer.interval){var b=this.timer.startTime,f=this.timer.endTime;b||(b="00:00");f||(f="23:59");var d=[],h=b.indexOf(":"),a=b.substr(0,h);h=b.substr(h+1);d.push("00");d.push(h);d.push(a);d.push("*");d.push("*");var g="0-6";if(this.timer.week&&
7==this.timer.week.length){g=[];"1"==this.timer.week.charAt(6)&&g.push(0);for(var l=0;6>l;l++)"1"==this.timer.week.charAt(l)&&g.push(l+1);g=g.join(",")}d.push(g);d=d.join(" ");g=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+d+" tz:"+g);this._cronJob=new (require("cron").CronJob)(d,this.onFirstTick.bind(this),null,!0,g);l=require("moment-timezone");var p=(new Date).getTime();d=l.tz(p,
g);a=d.year();var m=this.timer.start;if(m&&("00"==m.substr(0,2)&&(m+=m.substr(2)),m=l.tz(m,g),m.set({hour:0,minute:0,second:0,millisecond:0}),m.valueOf()>d.valueOf()))return;if(m=this.timer.end)if("00"==m.substr(0,2)&&(m=a+m.substr(2)),m=l.tz(m,g),m.set({hour:23,minute:59,second:59,millisecond:999}),m.valueOf()<d.valueOf())return;if(a=this.timer.week)if(m=d.isoWeekday(),"1"!=a.charAt(m-1))return;m=l.tz(p,g);h=b.indexOf(":");a=b.substr(0,h);h=b.substr(h+1);m.set({hour:parseInt(a),minute:parseInt(h),
second:0,millisecond:0});if(!(m.valueOf()>d.valueOf()||(b=l.tz(p,g),h=f.indexOf(":"),a=f.substr(0,h),h=f.substr(h+1),b.set({hour:parseInt(a),minute:parseInt(h),second:0,millisecond:0}),b.valueOf()<d.valueOf()||!(f=this.timer.interval)))){f=1E3*parseInt(f);f=Math.ceil((d.valueOf()-m.valueOf())/f)*f+m.valueOf()-d.valueOf();this._logger.log("trace","first tick in "+f/1E3+" seconds");var r=this;this._starter=setTimeout(function(){r.onFirstTick()},f)}}};d.prototype.stop=function(){this._logger.log("debug",
"stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._starter&&(clearTimeout(this._starter),this._starter=null)};d.prototype.onFirstTick=function(){this._logger.log("debug","periodic timer first tick:"+JSON.stringify(this.timer));var b=this.timer.interval;if(b){b=1E3*parseInt(b);var d=this;this._starter&&(clearTimeout(this._starter),this._starter=null);this._repeater&&(clearInterval(this._repeater),
this._repeater=null);this._repeater=setInterval(function(){d.onTick()},b);this.onTick()}};d.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" periodic timer tick:"+JSON.stringify(this.timer));var b=require("moment-timezone"),d=this.timer.interval;d=1E3*parseInt(d);var k=x.hub.taskman._Util._getTimeZone(),h=(new Date).getTime();d=h+d;var a=b.tz(h,k);h=b.tz(h,k);var g=h.year(),l=this.timer.start;if(l&&("00"==l.substr(0,2)&&(l=g+l.substr(2)),l=b.tz(l,k),l.set({hour:0,minute:0,second:0,
millisecond:0}),l.valueOf()>h.valueOf()))return;if(l=this.timer.end)if("00"==l.substr(0,2)&&(l=g+l.substr(2)),l=b.tz(l,k),l.set({hour:23,minute:59,second:59,millisecond:999}),l.valueOf()<h.valueOf())return;(k=this.timer.endTime)||(k="23:59");g=k.indexOf(":");b=k.substr(0,g);k=k.substr(g+1);a.set({hour:parseInt(b),minute:parseInt(k),second:59,millisecond:999});a.valueOf()<h.valueOf()?(this._logger.log("trace","repeater exceed end time:"+a.toString()),this._repeater&&(clearInterval(this._repeater),
this._repeater=null)):(d>a.valueOf()&&(this._logger.log("trace","repeater next tick will exceed end time:"+a.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)),require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.timer)))};d.prototype.onLocationChange=function(){this.stop();this.start()};d.prototype.onTimerChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(b,f){b=new d(b,f);this._timers.push(b);
b.start()};b.prototype.stopTimer=function(b){var c=[];this._timers.forEach(function(d){d.taskID==b?d.stop():c.push(d)});this._timers=c};b.prototype.onLocationChange=function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};b.prototype.clear=function(){var b=this._timers;this._timers=[];b.forEach(function(b){b.stop()})};return new b}();
x.hub.taskman._Block=function(){var d=function(e){this.type=e;this._parent=null;this._canceling=this._running=!1;this._trace=null};d.prototype.isRunning=function(){return this._running};d.prototype.do=function(e){e&&e()};d.prototype.cancel=function(e){var a=this._running;this._canceling=this._running=!1;e&&e(null,a)};d.prototype.toJSON=function(){return{type:this.type}};d.prototype.fromJSON=function(){};d.prototype.setTrace=function(e){this._trace=e};var b=function(){d.call(this);this.type=b.TYPE;
this.subtype=null;this.flowIf=[];this.flowThen=[];this.flowElse=[]};util.inherits(b,d);b.TYPE="condition";b.prototype.isRunning=function(){var e=!1;this.flowIf&&this.flowIf.forEach(function(a){a&&a.isRunning&&(e|=a.isRunning())});this.flowThen&&this.flowThen.forEach(function(a){a&&a.isRunning&&(e|=a.isRunning())});this.flowElse&&this.flowElse.forEach(function(a){a&&a.isRunning&&(e|=a.isRunning())});return e?!0:!1};b.prototype.do=function(e,a){var b=this;this._trace&&this._trace.log('condition | check "if"');
this._checkIfBlocks(function(n,c){b._trace&&b._trace.log('condition | check "if" - '+(n?"error:"+n.message:c));n?e&&e(n):c?(b._trace&&b._trace.log('condition | do "then"'),b._doThenBlocks(e,a)):(b._trace&&b._trace.log('condition | do "else"'),b._doElseBlocks(e,a))},a)};b.prototype.cancel=function(e){var a=0;this.flowIf&&this.flowIf.forEach(function(e){e&&e.cancel?e.cancel():a++});this.flowThen&&this.flowThen.forEach(function(e){e&&e.cancel?e.cancel():a++});this.flowElse&&this.flowElse.forEach(function(e){e&&
e.cancel?e.cancel():a++})};b.prototype.toJSON=function(){var e={type:this.type,subtype:this.subtype,if:[],then:[],else:[]};this.flowIf&&this.flowIf.forEach(function(a){a&&e.if.push(a.toJSON())});this.flowThen&&this.flowThen.forEach(function(a){a&&e.then.push(a.toJSON())});this.flowElse&&this.flowElse.forEach(function(a){a&&e.else.push(a.toJSON())});return e};b.prototype.fromJSON=function(e){if(e){var a=this;this.subtype=e.subtype;e.if&&0<e.if.length&&e.if.forEach(function(e){e&&(e=d.parse(e))&&(e._parent=
a,a.flowIf.push(e))});e.then&&0<e.then.length&&e.then.forEach(function(e){e&&(e=d.parse(e))&&a.flowThen.push(e)});e.else&&0<e.else.length&&e.else.forEach(function(e){e&&(e=d.parse(e))&&a.flowElse.push(e)})}};b.prototype._checkIfBlocks=function(e,a){var b=[],n=0,c=this;if(this.flowIf&&0!=this.flowIf.length){var g=function(d,f){n++;d?b.push(!1):b.push(f);if(n<c.flowIf.length)c.flowIf[n].do(g,a);else if(0==b.length)e&&e(null,!0);else{d=1;for(f=b[0];d<b.length&&d+1!=b.length;)"AND"==b[d]?f&=b[d+1]:"OR"==
b[d]?f|=b[d+1]:"XOR"==b[d]&&(f=f!=b[d+1]),d+=2;e&&e(null,f)}};this.flowIf[n].do(g,a)}else e&&e(null,!0)};b.prototype._doThenBlocks=function(e,a){var b=0,n=this;if(this.flowThen&&0!=this.flowThen.length){var c=function(){b++;b<n.flowThen.length?n.flowThen[b].do(c,a):e&&e()};this.flowThen[b].do(c,a)}else e&&e()};b.prototype._doElseBlocks=function(e,a){var b=0,c=this;if(this.flowElse&&0!=this.flowElse.length){var n=function(){b++;b<c.flowElse.length?c.flowElse[b].do(n,a):e&&e()};this.flowElse[b].do(n,
a)}else e&&e()};b.prototype.setTrace=function(e){this._trace=e;this.flowIf&&this.flowIf.forEach(function(a){a&&a.setTrace&&a.setTrace(e)});this.flowThen&&this.flowThen.forEach(function(a){a&&a.setTrace&&a.setTrace(e)});this.flowElse&&this.flowElse.forEach(function(a){a&&a.setTrace&&a.setTrace(e)})};d.Condition=b;var c=function(){b.call(this);this.type=d.Root.TYPE;this._lastTiggerTime=this._taskID=null;this.singleton=!1;this.singletonMethod="ignore";this._task=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Root")};
util.inherits(c,b);c.TYPE="root";c.prototype.init=function(e){this._taskID=e;this.flowIf.forEach(function(a){a&&a.init&&a.init(e)})};c.prototype.finalize=function(e){this.flowIf.forEach(function(a){a&&a.finalize&&a.finalize(e)})};c.prototype.getTriggers=function(){return this.flowIf?this.flowIf:[]};c.prototype._onTriggered=function(e,a){var b=(new Date).getTime();if(!(this._lastTiggerTime&&400>b-this._lastTiggerTime)){if(this.singleton&&this._running){if("ignore"==this.singletonMethod){this._logger.log("debug",
"task "+this._taskID+" is running and ignore the new trigger");e&&e();return}this._logger.log("debug","task "+this._taskID+" is running and cancel it");this.cancel()}this._logger.log("info","task "+this._taskID+" triggered");this._logger.log("trace","task "+this._taskID+" is "+(this._running?"running":"not running"));this._lastTiggerTime=b;this._trace&&this._trace.log("root | task:"+this._taskID+" triggered");this._running=!0;var c=this;this._doThenBlocks(function(){c._running=!1;e&&e()},{trigger:a,
task:this._task})}};c.prototype.onStatusEvt=function(e){var a=!1;this._logger.log("trace","check trigger for status event");for(var b=null,c=0;c<this.flowIf.length;c++){var g=this.flowIf[c];if((g.type==m.TYPE||g.type==u.TYPE)&&g.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}a&&this._onTriggered(null,b)};c.prototype.onDedicatedStatusEvt=function(e){var a=!1;this._logger.log("trace","check trigger for status event");for(var b=null,c=0;c<this.flowIf.length;c++){var g=
this.flowIf[c];if(g.type==m.TYPE){if(g.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}else if(g.type==u.TYPE&&g.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}a&&this._onTriggered(null,b)};c.prototype.onIREvt=function(e){this._trace&&this._trace.log("root | receive ir event:"+JSON.stringify(e));var a=!1;this._logger.log("trace","check trigger for ir event");for(var b=0;b<this.flowIf.length;b++){var c=
this.flowIf[b];if(c.type==p.TYPE&&c.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(c.toJSON()));a=!0;break}}a&&this._onTriggered()};c.prototype.onTimerTick=function(e){this._trace&&this._trace.log("root | timer tick:"+e);this._onTriggered()};c.prototype.onHttpEvt=function(e,a){this._trace&&this._trace.log("root | receive http event:"+JSON.stringify(e));for(var b=!1,c=0;c<this.flowIf.length;c++){var g=this.flowIf[c];if(g.type==h.TYPE&&g.isMatch(e)){this._logger.log("info","trigger hit:"+
JSON.stringify(g.toJSON()));b=!0;break}}b&&this._onTriggered();a&&a(null,b)};c.prototype.setTrace=function(e){this._trace=e;this.flowIf&&this.flowIf.forEach(function(a){a&&a.setTrace&&a.setTrace(e)});this.flowThen&&this.flowThen.forEach(function(a){a&&a.setTrace&&a.setTrace(e)})};c.prototype.hasCloudTrigger=function(){if(!this.flowIf||0==this.flowIf.length)return!1;for(var e=0;e<this.flowIf.length;e++)if(this.flowIf[e]instanceof r)return!0;return!1};c.prototype.toCloudRuleFormat=function(){if(!this.flowIf||
0==this.flowIf.length)return[];for(var e=[],a=0;a<this.flowIf.length;a++){var b=this.flowIf[a];b instanceof r&&(b=b.toCloudRuleFormat())&&e.push(b)}return e};d.Root=c;var f=function(e){d.call(this);this.type=f.TYPE;e&&(this.op=e.op)};util.inherits(f,d);f.TYPE="logic.operator";f.prototype.do=function(e){e&&e(null,this.op)};f.prototype.toJSON=function(){var e=d.prototype.toJSON.call(this);e.op=this.op;return e};f.prototype.fromJSON=function(e){e&&(this.op=e.op)};d.LogicOP=f;var k=function(){d.call(this);
this.type=k.TYPE;this.children=[]};util.inherits(k,d);k.TYPE="bracket";k.prototype.do=function(e){var a=[],b=0,c=this;if(this.children&&0!==this.children.length){var g=function(n,d){b++;n?a.push(!1):a.push(d);if(b<c.children.length)c.children[b].do(g);else if(0===a.length)e&&e(null,!0);else{n=1;for(d=a[0];n<a.length&&n+1!=a.length;)"AND"==a[n]?d&=a[n+1]:"OR"==a[n]?d|=a[n+1]:"XOR"==a[n]&&(d=d!=a[n+1]),n+=2;e&&e(null,d)}};this.children[b].do(g)}else e&&e(null,!0)};k.prototype.toJSON=function(){var e=
d.prototype.toJSON.call(this);e.children=[];this.children&&this.children.forEach(function(a){a&&e.children.push(a.toJSON())});return e};k.prototype.fromJSON=function(e){if(e){var a=this;e.children&&0<e.children.length&&e.children.forEach(function(e){e&&(e=d.parse(e))&&a.children.push(e)})}};d.Bracket=k;var h=function(){d.call(this);this.type=h.TYPE;this.params=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpTrigger")};util.inherits(h,d);h.TYPE="http.trigger";h.prototype.isMatch=
function(e){if(!e||!this.params)return!1;for(var a in this.params)if(a&&this.params[a]!=e[a])return!1;this._logger.log("trace","trigger hit:"+JSON.stringify(this.toJSON()));return!0};h.prototype.toJSON=function(){var e=d.prototype.toJSON.call(this);e.params=this.params;return e};h.prototype.fromJSON=function(e){e&&(this.params=e.params)};d.HttpTrigger=h;var a=function(){d.call(this);this.type=a.TYPE;this.op=this.end=this.start=this.week=this.time=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Timer")};
util.inherits(a,d);a.TYPE="timer";a.prototype.init=function(e){x.hub.taskman._TimerManager.startTimer(e,this)};a.prototype.do=function(e){this._trace&&this._trace.log("check time | "+this._getDescription());var a=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=a.tz(c,b);var g=c.year(),d=!1,f=!1,l=null,k=null,p=c.valueOf(),h=this.start;h&&("00"==h.substr(0,2)&&(d=!0,h=g+h.substr(2)),h=a.tz(h,b),h.set({hour:0,minute:0,second:0,millisecond:0}),l=h.valueOf());
var m=this.end;m&&("00"==m.substr(0,2)&&(f=!0,m=g+m.substr(2)),m=a.tz(m,b),m.set({hour:23,minute:59,second:59,millisecond:999}),k=m.valueOf());if(d&&f&&l>k){if(k<p&&l>p){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if(h&&l>p||m&&k<p){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}if(a=this.week)if(b=c.day(),0==b&&(b=7),"1"!=a.charAt(b-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));
e&&e(null,!1);return}if(this.time&&this.op)if(b=this.time.indexOf(":"),a=this.time.substr(0,b),b=this.time.substr(b+1),a=parseInt(a),b=parseInt(b),g=c.hour(),c=c.minute(),">="==this.op){if(g<a||g==a&&c<b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if(">"==this.op){if(g<a||g==a&&c<=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if("<="==this.op){if(g>a||g==a&&c>b){this._logger.log("trace",
"condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if("<"==this.op){if(g>a||g==a&&c>=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if("="==this.op||"=="==this.op)if(g!=a||g==a&&c!=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}this._logger.log("trace","condition match:"+JSON.stringify(this.toJSON()));e&&e(null,!0)};a.prototype.finalize=function(e){x.hub.taskman._TimerManager.stopTimer(e)};
a.prototype.toJSON=function(){var e=d.prototype.toJSON.call(this);e.time=this.time;e.week=this.week;e.start=this.start;e.end=this.end;e.op=this.op;return e};a.prototype.fromJSON=function(e){e&&(this.time=e.time,this.week=e.week,this.start=e.start,this.end=e.end,this.op=e.op)};a.prototype._getDescription=function(){var e="time:"+this.time;e+=" week:"+this.week;e+=" start:"+this.start;e+=" end:"+this.end;return e+=" op:"+this.op};d.Timer=a;var g=function(){d.call(this);this.type=g.TYPE;this.op=this.end=
this.start=this.week=this.delay=this.offTime=this.astro=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Astro")};util.inherits(g,d);g.TYPE="astro";g.prototype.init=function(e){x.hub.taskman._AstroManager.startTimer(e,this)};g.prototype.do=function(e){this._trace&&this._trace.log("check astro | "+this._getDescription());var a=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=a.tz(c,b);var g=c.year(),d=!1,f=!1,l=null,k=null,p=c.valueOf(),
h=this.start;h&&("00"==h.substr(0,2)&&(d=!0,h=g+h.substr(2)),h=a.tz(h,b),h.set({hour:0,minute:0,second:0,millisecond:0}),l=h.valueOf());var m=this.end;m&&("00"==m.substr(0,2)&&(f=!0,m=g+m.substr(2)),m=a.tz(m,b),m.set({hour:23,minute:59,second:59,millisecond:999}),k=m.valueOf());if(d&&f&&l>k){if(k<p&&l>p){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if(h&&l>p||m&&k<p){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));
e&&e(null,!1);return}if(a=this.week)if(b=c.day(),0==b&&(b=7),"1"!=a.charAt(b-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}a=!1;this.astro&&this.op&&(b=x.hub.taskman._AstroManager.getSunriseSunset(c.toDate()),b="sunrise"==this.astro?b.sunrise.getTime():b.sunset.getTime(),this.delay&&(b+=6E4*parseInt(this.delay)),">="==this.op&&c.valueOf()>=b?a=!0:">"==this.op&&c.valueOf()>b?a=!0:"<="==this.op&&c.valueOf()<=b?a=!0:"<"==this.op&&c.valueOf()<b?
a=!0:("="==this.op||"=="==this.op)&&c.valueOf()==b&&(a=!0));this._logger.log("trace","condition "+(a?"match":"mismatch")+":"+JSON.stringify(this.toJSON()));e&&e(null,a)};g.prototype.finalize=function(e){x.hub.taskman._AstroManager.stopTimer(e)};g.prototype.toJSON=function(){var e=d.prototype.toJSON.call(this);e.astro=this.astro;e.offTime=this.offTime;e.delay=this.delay;e.week=this.week;e.start=this.start;e.end=this.end;e.op=this.op;return e};g.prototype.fromJSON=function(e){e&&(this.astro=e.astro,
this.offTime=e.offTime,this.delay=e.delay,this.week=e.week,this.start=e.start,this.end=e.end,this.op=e.op)};g.prototype._getDescription=function(){var e="astro:"+this.astro;e+=" offTime:"+this.offTime;e+=" delay:"+this.delay;e+=" week:"+this.week;e+=" start:"+this.start;e+=" end:"+this.end;return e+=" op:"+this.op};d.Astro=g;var l=function(){d.call(this);this.type=l.TYPE;this.end=this.start=this.week=this.endTime=this.startTime=this.interval=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Periodic")};
util.inherits(l,d);l.TYPE="periodic";l.prototype.init=function(e){x.hub.taskman._PeriodicTimerManager.startTimer(e,this)};l.prototype.finalize=function(e){x.hub.taskman._PeriodicTimerManager.stopTimer(e)};l.prototype.toJSON=function(){var e=d.prototype.toJSON.call(this);e.interval=this.interval;e.startTime=this.startTime;e.endTime=this.endTime;e.week=this.week;e.start=this.start;e.end=this.end;return e};l.prototype.fromJSON=function(e){e&&(this.interval=e.interval,this.startTime=e.startTime,this.endTime=
e.endTime,this.week=e.week,this.start=e.start,this.end=e.end)};d.Periodic=l;var p=function(){d.call(this);this.type=p.TYPE;this._lastTiggerTime=this.ir=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IRTrigger")};util.inherits(p,d);p.TYPE="ir";p.prototype.isMatch=function(e){if(!(e&&e.code&&this.ir&&this.ir.code))return!1;var a=this._getDataCode(this.ir.code);e=this._getDataCode(e.code);if(a==e){a=(new Date).getTime();if(!this._lastTiggerTime)return this._lastTiggerTime=a,
!0;if(1E3>a-this._lastTiggerTime)return!1;this._lastTiggerTime=a;return!0}return!1};p.prototype.toJSON=function(){var e=d.prototype.toJSON.call(this);e.ir=this.ir;return e};p.prototype.fromJSON=function(e){e&&(this.ir=e.ir)};p.prototype._getDataCode=function(e){e=new Buffer(e,"hex");var a=e.readInt8(8);return e.slice(4*a+9).toString("hex")};d.IRTrigger=p;var m=function(){d.call(this);this.type=m.TYPE;this._cancelCB=this._lastStatus=this._lastTiggerTime=this.hysteresis=this.value=this.op=this.status=
this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DeviceStatus");this._gatewayName=this._deviceName=null};util.inherits(m,d);m.TYPE="device.status";m.prototype.init=function(e){if((this.device||this.gateway)&&this.status){var a=null;this.gateway&&this.gateway.sys&&(a=this.gateway.sys);!a&&this.device&&this.device.sys&&(a=this.device.sys);if(a&&("hm"!=a||this.gateway?"neoserver"==a&&(a="aio"):a="aio",(a=require("x.hub.moduleman.js").modulemanager.getModule(a))&&
a.addStateDevice)){var b={},c=this._getDevice(),g=this._getGateway();c&&(b=c);delete b.gateway;g&&(b.gateway=g);c=this.status;c.ref&&c.ref.value?c=c.ref.value:c.value&&(c=c.value);a.addStateDevice(b,null,{taskID:e,statusKey:c,src:"taskman",callback:this})}}};m.prototype.finalize=function(e){if(this.device||this.gateway){var a=null;this.gateway&&this.gateway.sys&&(a=this.gateway.sys);!a&&this.device&&this.device.sys&&(a=this.device.sys);if(a&&(a=require("x.hub.moduleman.js").modulemanager.getModule(a))&&
a.removeStateDevice){var b={},c=this._getDevice(),g=this._getGateway();c&&(b=c);delete b.gateway;g&&(b.gateway=g);c=this.status;c.ref&&c.ref.value?c=c.ref.value:c.value&&(c=c.value);a.removeStateDevice(b,null,{taskID:e,statusKey:c,src:"taskman",callback:this})}}};m.prototype.do=function(e){if(this.device||this.gateway)if(this.status&&this.op){var a=this.status;this.status.ref&&(a=this.status.ref);a.value&&(a=a.value);a={value:a};this.status&&this.status.value?a=this.status:this.status&&this.status.ref&&
(a=this.status.ref);var b=this,c=this._getDevice(),g=this._getGateway();this._logger.log("trace","get states:"+JSON.stringify(this._toBluredJSON()));this._trace&&this._trace.log("get status | "+this._getDescription());this._running=!0;require("x.hub.commandman.js").commandHandler.getState(c,g,a,function(a){if(b._canceling){b._logger.log("trace","get states canceled:"+JSON.stringify(b._toBluredJSON()));b._canceling=!1;a=b._running;b._running=!1;var c=b._cancelCB;b._cancelCB=null;c&&c(null,a)}else if(b._running=
!1,!a||a.error?b._trace&&b._trace.log("get status | "+b._getDescription()+" | error:"+(a?a.error.message:"invalid response")):("undefined"==typeof a.data||null==a.data)&&b._trace&&b._trace.log("get status | "+b._getDescription()+" | error:no status"),!a||a.error)e&&e(a?a.error:Error("get state error"));else if("undefined"==typeof a.data||null==a.data)e&&e(null,!1);else{c=a.data.value;var g=!1;"="==b.op||"=="==b.op?g="true"==b.value?"true"==String(c):"false"==b.value?"false"==String(c):c==b.value:
"!="==b.op?g="true"==b.value?"true"!=String(c):"false"==b.value?"false"!=String(c):c!=b.value:">="==b.op?g=parseFloat(c)>=parseFloat(b.value):">"==b.op?g=parseFloat(c)>parseFloat(b.value):"<="==b.op?g=parseFloat(c)<=parseFloat(b.value):"<"==b.op&&(g=parseFloat(c)<parseFloat(b.value));b._logger.log("trace","condition "+(g?"match":"mismatch")+":"+JSON.stringify(b.toJSON()));b._trace&&b._trace.log("get status | "+b._getDescription()+" | success:"+JSON.stringify(a.data)+" | match="+g);e&&e(null,g)}})}else e&&
e(Error("no status point or operator"));else e&&e(Error("no device or gateway"))};m.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};m.prototype.isMatch=function(a){if(!a||!a.device)return!1;var e=a.device.sys;e&&"neoserver"!=e||(e="aio");e=require("x.hub.moduleman.js").modulemanager.getModule(e);if(!e||!e.checkDeviceMatch)return!1;var b=this._getDevice(),c=this._getGateway();if(!e.checkDeviceMatch({device:b,gateway:c},a))return!1;e=this.status;
e.ref&&e.ref.value?e=e.ref.value:e.value&&(e=e.value);return e!=a.data.key?!1:this.isValueMatch(a)};m.prototype.isValueMatch=function(a){if(!a||!a.data)return!1;var e=(new Date).getTime(),b=!1,c=this._lastStatus,g=a.data.value;this._lastStatus=g;"="==this.op||"changeTo"==this.op?(b="true"==this.value?"true"==String(a.data.value):"false"==this.value?"false"==String(a.data.value):this.value==a.data.value,"changeTo"==this.op&&g==c&&(b=!1)):">="==this.op?b=parseFloat(a.data.value)>=parseFloat(this.value):
">"==this.op?b=parseFloat(a.data.value)>parseFloat(this.value):"<="==this.op?b=parseFloat(a.data.value)<=parseFloat(this.value):"<"==this.op?b=parseFloat(a.data.value)<parseFloat(this.value):"changed"==this.op?g!=c&&(b=!0):b=!1;c=this.value;"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&(c=this.hysteresis);g=!1;if(">"==this.op)g=parseFloat(a.data.value)<=parseFloat(c);else if(">="==this.op)g=parseFloat(a.data.value)<parseFloat(c);else if("<"==this.op)g=parseFloat(a.data.value)>=parseFloat(c);
else if("<="==this.op)g=parseFloat(a.data.value)>parseFloat(c);else if("="==this.op||"=="==this.op)g=a.data.value!=c;g&&(this._lastTiggerTime=null);this._trace&&(this._trace.log("trigger | "+this._getDescription()),this._trace.log("receive event | "+JSON.stringify(a.data)+" | hysteresis="+this.hysteresis+" | hit="+b));if(b){if(!this._lastTiggerTime)return this._lastTiggerTime=e,!0;if(1E3>e-this._lastTiggerTime||"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&this._lastTiggerTime||(a=this._getDevice())&&
"aio"==a.sys&&"ENOCEAN"==a.type&&("bb-aa-cc"==a.data||"d2-06-10"==a.data)&&this._lastTiggerTime)return!1;this._lastTiggerTime=e;return!0}return!1};m.prototype.onEvent=function(a){try{this.isValueMatch(a)&&this._parent&&this._parent._onTriggered&&this._parent._onTriggered(null,this)}catch(n){}};m.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.status=this.status;a.op=this.op;a.value=this.value;a.hysteresis=this.hysteresis;return a};m.prototype.fromJSON=
function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.status=a.status,this.op=a.op,this.value=a.value,this.hysteresis=a.hysteresis)};m.prototype._toBluredJSON=function(){try{var a=JSON.parse(JSON.stringify(this.toJSON()));a.device&&(a.device.username&&(a.device.username="xxxxxx"),a.device.password&&(a.device.password="xxxxxx"));a.gateway&&(a.gateway.username&&(a.gateway.username="xxxxxx"),a.gateway.password&&(a.gateway.password="xxxxxx"));return a}catch(n){return this.toJSON()}};m.prototype._getDevice=
function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);b&&b.info&&(this._deviceName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};m.prototype._getGateway=function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);
b&&b.info&&(this._gatewayName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};m.prototype._getDescription=function(){var a=null,b=null;if(this._deviceName||this._gatewayName)a=this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{b=JSON.parse(JSON.stringify(this.device)),b.username&&(b.username="xxxxxx"),b.password&&(b.password="xxxxxx"),
a=JSON.stringify(b)}catch(J){a=JSON.stringify(this.device)}else if(this.gateway)try{b=JSON.parse(JSON.stringify(this.gateway)),b.username&&(b.username="xxxxxx"),b.password&&(b.password="xxxxxx"),a=JSON.stringify(b)}catch(J){a=JSON.stringify(this.gateway)}b=this.status;this.status.ref&&(b=this.status.ref);b.value&&(b=b.value);return a+" | "+b+" "+this.op+" "+this.value};d.DeviceStatus=m;var r=function(){m.call(this);this.type=r.TYPE;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudDeviceTrigger");
this._cloudRuleID=null};util.inherits(r,m);r.TYPE="cloud.trigger.device";r.prototype.init=function(a){};r.prototype.finalize=function(a){};r.prototype.toCloudTriggerFormat=function(){var a=this.status;a.ref&&a.ref.value?a=a.ref.value:a.value&&(a=a.value);a={event:{sys:this.device.module,data:{connection:this.device.connection,id:this.device.id,state:a},comp:{value:this.value,operator:this.op}}};if("undefined"!=typeof this.hysteresis&&null!=this.hysteresis)if("="==this.op||"=="==this.op)a.event.comp.hyst=
.1;else if(">="==this.op||">"==this.op)a.event.comp.hyst=parseFloat(this.value)-parseFloat(this.hysteresis);else if("<="==this.op||"<"==this.op)a.event.comp.hyst=parseFloat(this.hysteresis)-parseFloat(this.value);return a};d.CloudDeviceTrigger=r;var u=function(){d.call(this);this.type=u.TYPE;this.gateway=this.device=null;this.upperThreshold={type:null,op:null,value:null,delay:null,repeat:null};this.lowerThreshold={type:null,op:null,value:null,delay:null,repeat:null};this._upper_threshold_state=0;
this._upper_threshold_repeat_to=this._upper_threshold_deley_to=null;this._lower_threshold_state=0;this._lower_threshold_repeat_to=this._lower_threshold_deley_to=null;this._lastTigger={upperThreshold:!1,lowerThreshold:!1};this._upperMatchCount=0;this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DominoswissWS");this._lastHit=null};util.inherits(u,m);u.TYPE="device.dominoswiss.weatherstation";u.prototype.init=function(a){if(this.device||this.gateway){var e=null;
this.gateway&&this.gateway.sys&&(e=this.gateway.sys);!e&&this.device&&this.device.sys&&(e=this.device.sys);if(e&&(e=require("x.hub.moduleman.js").modulemanager.getModule(e))&&e.addStateDevice){var b={},c=this._getDevice(),g=this._getGateway();c&&(b=c);delete b.gateway;g&&(b.gateway=g);e.addStateDevice(b,null,{taskID:a,statusKey:"*",src:"taskman"})}}};u.prototype.finalize=function(a){if(this.device||this.gateway){var e=null;this.gateway&&this.gateway.sys&&(e=this.gateway.sys);!e&&this.device&&this.device.sys&&
(e=this.device.sys);if(e&&(e=require("x.hub.moduleman.js").modulemanager.getModule(e))&&e.removeStateDevice){var b={},c=this._getDevice(),g=this._getGateway();c&&(b=c);delete b.gateway;g&&(b.gateway=g);e.removeStateDevice(b,null,{taskID:a,statusKey:"*",src:"taskman"})}}};u.prototype.isMatch=function(a){if(!a||!a.device||!a.device.sys)return!1;var b=require("x.hub.moduleman.js").modulemanager.getModule(a.device.sys);if(!b||!b.checkDeviceMatch)return!1;var e=this._getDevice(),c=this._getGateway();if(!b.checkDeviceMatch({device:e,
gateway:c},a))return!1;this._logger.log("trace","receive event for device:"+JSON.stringify(a));e=b=!1;c=this._matchUpperThreshold(a);a=this._matchLowerThreshold(a);this._logger.log("trace","upperMatch:"+c+" - lowerMatch:"+a);if("upper"==this._lastHit&&!a)return this._logger.log("trace","lastHit:upper - lowerMatch:"+a),!1;if("lower"==this._lastHit&&!c)return this._logger.log("trace","lastHit:lower - upperMatch:"+c),!1;"upper"==this._lastHit&&a&&(this._lastHit=null);"lower"==this._lastHit&&c&&(this._lastHit=
null);1==c&&(this._upperMatchCount+=1,65535<this._upperMatchCount&&(this._upperMatchCount=1));switch(this._upper_threshold_state){case 0:1==c&&("undefined"!=typeof this.upperThreshold.delay&&null!=this.upperThreshold.delay&&0<parseInt(this.upperThreshold.delay)?this._handleUpperThresholdDelay():(b=!0,this.upperThreshold.repeat&&this._handleUpperThresholdRepeat()));break;case 1:0==c&&(this._logger.log("trace","upper threshold not match, clear delay timeout"),this._upper_threshold_deley_to&&(clearTimeout(this._upper_threshold_deley_to),
this._upper_threshold_deley_to=null),this._upper_threshold_state=0);break;case 2:0==c&&(this._logger.log("trace","upper threshold not match, clear repeat timeout"),this._upper_threshold_repeat_to&&(clearTimeout(this._upper_threshold_repeat_to),this._upper_threshold_repeat_to=null),this._upper_threshold_state=0)}switch(this._lower_threshold_state){case 0:1==a&&0<this._upperMatchCount&&("undefined"!=typeof this.lowerThreshold.delay&&null!=this.lowerThreshold.delay&&0<parseInt(this.lowerThreshold.delay)?
this._handleLowerThresholdDelay():(e=!0,this._upperMatchCount=0,this.lowerThreshold.repeat&&this._handleLowerThresholdRepeat()));break;case 1:0==a&&(this._logger.log("trace","lower threshold not match, clear delay timeout"),this._lower_threshold_deley_to&&(clearTimeout(this._lower_threshold_deley_to),this._lower_threshold_deley_to=null),this._lower_threshold_state=0);break;case 2:0==a&&(this._logger.log("trace","lower threshold not match, clear repeat timeout"),this._lower_threshold_repeat_to&&(clearTimeout(this._lower_threshold_repeat_to),
this._lower_threshold_repeat_to=null),this._lower_threshold_state=0)}this._lastTigger={upperThreshold:b,lowerThreshold:e};this._logger.log("trace","upperHit:"+b+" - lowerHit:"+e);b?this._lastHit="upper":e&&(this._lastHit="lower");return b|e};u.prototype._matchUpperThreshold=function(a){if(!(this.upperThreshold&&this.upperThreshold.type&&a&&a.data&&a.data.key&&this.upperThreshold.type==a.data.key))return null;var b=this.upperThreshold.op;b||(b=">=");var e=this.upperThreshold.value;if("undefined"==
typeof e||null==e)e=0;return this._matchThreshold(b,e,a.data.value)};u.prototype._matchLowerThreshold=function(a){if(!(this.lowerThreshold&&this.lowerThreshold.type&&a&&a.data&&a.data.key&&this.lowerThreshold.type==a.data.key))return null;var b=this.lowerThreshold.op;b||(b=">=");var e=this.lowerThreshold.value;if("undefined"==typeof e||null==e)e=0;return this._matchThreshold(b,e,a.data.value)};u.prototype._matchThreshold=function(a,b,c){return"="==a||"=="==a?"true"==b?"true"==String(c):"false"==b?
"false"==String(c):b==c:">="==a?parseFloat(c)>=parseFloat(b):">"==a?parseFloat(c)>parseFloat(b):"<="==a?parseFloat(c)<=parseFloat(b):"<"==a?parseFloat(c)<parseFloat(b):!1};u.prototype._handleUpperThresholdDelay=function(){var a=this;this._upper_threshold_state=1;this._logger.log("trace","start upper threshold hit delay timeout:"+parseInt(this.upperThreshold.delay));this._upper_threshold_deley_to=setTimeout(function(){a._logger.log("trace","upper threshold delay timeout expired");a._lastTigger={upperThreshold:!0,
lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,a)}catch(n){}a.upperThreshold.repeat?a._handleUpperThresholdRepeat():a._upper_threshold_state=0},1E3*parseInt(this.upperThreshold.delay))};u.prototype._handleLowerThresholdDelay=function(){var a=this;this._lower_threshold_state=1;this._logger.log("trace","start lower threshold hit delay timeout:"+parseInt(this.lowerThreshold.delay));this._lower_threshold_delay_to=setTimeout(function(){a._lastTigger=
{upperThreshold:!1,lowerThreshold:!0};a._upperMatchCount=0;a._logger.log("trace","lower threshold delay timeout expired");if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",a._parent._onTriggered(null,a)}catch(n){}a.lowerThreshold.repeat?a._handleLowerThresholdRepeat():a._lower_threshold_state=0},1E3*parseInt(this.lowerThreshold.delay))};u.prototype._handleUpperThresholdRepeat=function(){var a=this;this._upper_threshold_state=2;var b=this.upperThreshold.repeat,c=0;if(b&&"string"==typeof b&&
b.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){c=require("moment-timezone");var g=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=c.tz(d,g);var f=parseInt(b.substr(0,b.indexOf(":")));b=parseInt(b.substr(b.indexOf(":")+1));var l=(new Date).getTime();l=c.tz(l,g);l.set({hour:f,minute:b,second:0,millisecond:0});c=l.valueOf()-d.valueOf();if(0>c){this._upper_threshold_state=0;return}}else if(0<parseInt(b))c=1E3*parseInt(b);else{this._upper_threshold_state=0;return}this._logger.log("trace",
"start upper threshold hit repeat timeout:"+Math.round(c/1E3));this._upper_threshold_repeat_to=setTimeout(function(){a._logger.log("trace","upper threshold repeat timeout expired");a._upper_threshold_state=0;a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,a)}catch(N){}},c)};u.prototype._handleLowerThresholdRepeat=function(){var a=this;this._lower_threshold_state=2;var b=this.lowerThreshold.repeat,c=0;if(b&&
"string"==typeof b&&b.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){c=require("moment-timezone");var g=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=c.tz(d,g);var f=parseInt(b.substr(0,b.indexOf(":")));b=parseInt(b.substr(b.indexOf(":")+1));var l=(new Date).getTime();l=c.tz(l,g);l.set({hour:f,minute:b,second:0,millisecond:0});c=l.valueOf()-d.valueOf();if(0>c){this._lower_threshold_state=0;return}}else if(0<parseInt(b))c=1E3*parseInt(b);else{this._lower_threshold_state=0;return}this._logger.log("trace",
"start lower threshold hit repeat timeout:"+Math.round(c/1E3));this._lower_threshold_repeat_to=setTimeout(function(){a._logger.log("trace","lower threshold repeat timeout expired");a._upperMatchCount=0;a._lower_threshold_state=0;a._lastTigger={upperThreshold:!1,lowerThreshold:!0};if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",a._parent._onTriggered(null,a)}catch(N){}},c)};u.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.upperThreshold=
this.upperThreshold;a.lowerThreshold=this.lowerThreshold;return a};u.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.upperThreshold=a.upperThreshold,this.lowerThreshold=a.lowerThreshold)};d.DominoswissWS=u;var q=function(){d.call(this);this.type=q.TYPE};util.inherits(q,d);q.TYPE="action";d.Action=q;var D=function(){q.call(this);this.subtype=D.SUBTYPE;this.body=this.event=this.key=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IFTTTMakerAction")};
util.inherits(D,q);D.SUBTYPE="iftttmaker";D.prototype.do=function(a){if(this.key||this.event){var b=a;a={hostname:"maker.ifttt.com",port:443,path:"/trigger/"+this.event+"/with/key/"+this.key,method:"POST",headers:{"Content-Type":"application/json"}};this._logger.log("trace","send https:"+JSON.stringify(a));this._logger.log("trace","with data:"+JSON.stringify(this.body));var e=this;a=require("https").request(a,function(a){a.setEncoding("utf8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){e._logger.log("trace",
"action response:"+a.statusCode);e._logger.log("trace","with data:"+c);b&&(b(null,a.statusCode,c),b=null)})});a.on("error",function(a){e._logger.log("debug","do action err:"+a.stack);b&&(b(a),b=null)});a.setTimeout(5E3,function(){e._logger.log("debug","do action timeout");b&&(b(Error("timeout")),b=null)});if(this.body)try{var c=JSON.stringify(this.body);a.write(c)}catch(P){}a.end()}else a&&a(Error("no key or event"))};D.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;
a.key=this.key;a.event=this.event;a.body=this.body;return a};D.prototype.fromJSON=function(a){a&&(this.key=a.key,this.event=a.event,this.body=a.body)};d.IFTTTMakerAction=D;var A=function(){q.call(this);this.subtype=A.SUBTYPE;this._cancelCB=this._doCB=this.body=this.headers=this.query=this.pathname=this.port=this.hostname=this.auth=this.protocol=this.method=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpAction")};util.inherits(A,q);A.SUBTYPE="http.action";A.prototype.do=
function(a){var b=this.method;b||(b="GET");var e=this.protocol;e||(e="http");var c=this.port;if(!c||0>=parseInt(c))c="https"==e?443:80;var g=require("querystring"),d=this.pathname?this.pathname:"/";this.query&&(d+="?"+g.stringify(this.query));c={hostname:this.hostname,port:c,path:d,method:b,headers:this.headers};this.auth&&(c.auth=this.auth);this._logger.log("trace","send "+e+" "+b+":"+JSON.stringify(c));this._logger.log("trace","with data:"+JSON.stringify(this.body));this._trace&&(this._trace.log("execute http | "+
e+" "+b+":"+JSON.stringify(c)),this._trace.log("execute http | with data:"+JSON.stringify(this.body)));this._running=!0;this._doCB=a;var f=this;a=require(e).request(c,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){f._logger.log("trace","action response:"+a.statusCode);f._logger.log("trace","with data:"+b);f._trace&&(f._trace.log("execute http | response code:"+a.statusCode),f._trace.log("execute http | response data:"+b));f._doCB&&(f._running=!1,f._doCB(null,
a.statusCode,b),f._doCB=null)})});a.on("error",function(a){f._trace&&f._trace.log("execute http | error:"+a.message);f._logger.log("debug","do action err:"+a.stack);f._doCB&&(f._running=!1,f._doCB(a),f._doCB=null)});a.setTimeout(5E3,function(){f._trace&&f._trace.log("execute http | error:timeout");f._logger.log("debug","do action timeout");f._doCB&&(f._running=!1,f._doCB(Error("timeout")),f._doCB=null)});if(this.body&&"GET"!=b&&"DELETE"!=b)if("string"==typeof this.body)a.write(this.body);else try{var l=
JSON.stringify(this.body);a.write(l)}catch(Q){}a.end()};A.prototype.cancel=function(a){this._running?(this._logger.log("trace","http action canceled"),this._doCB=null,this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};A.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.method=this.method;a.protocol=this.protocol;a.auth=this.auth;a.hostname=this.hostname;a.port=this.port;a.pathname=this.pathname;a.query=this.query;a.headers=this.headers;a.body=this.body;
return a};A.prototype.fromJSON=function(a){a&&(this.subtype=a.subtype,this.method=a.method,this.protocol=a.protocol,this.auth=a.auth,this.hostname=a.hostname,this.port=a.port,this.pathname=a.pathname,this.query=a.query,this.headers=a.headers,this.body=a.body)};d.HttpAction=A;var t=function(){q.call(this);this.subtype=t.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CommandAction");this._gatewayName=this._deviceName=
null};util.inherits(t,q);t.SUBTYPE="command";t.prototype.do=function(a,b){if(this.device||this.gateway)if(this.command){b=this.command;b.ref&&(b=b.ref);var e=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do command:"+JSON.stringify(this._toBluredJSON()));var c=this._getDevice(),g=this._getGateway();if(c&&"sonos"==c.sys&&b&&"playAlarm"==b.value&&(b=this._buildSonosCommand(b.ext),!b))return;this._running=!0;this._trace&&this._trace.log("execute command | "+this._getDescription());
var d=this;e.executeCommand(c,g,b,function(b){b&&b.error?d._trace&&d._trace.log("execute command | "+d._getDescription()+" | error:"+b.error.message):d._trace&&d._trace.log("execute command | "+d._getDescription()+" | success");if(d._canceling){d._logger.log("trace","command action canceled:"+JSON.stringify(d._toBluredJSON()));d._canceling=!1;b=d._running;d._running=!1;var e=d._cancelCB;d._cancelCB=null;e&&e(null,b)}else d._running=!1,a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};
t.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};t.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};t.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};t.prototype._toBluredJSON=function(){try{var a=JSON.parse(JSON.stringify(this.toJSON()));a.device&&(a.device.username&&(a.device.username=
"xxxxxx"),a.device.password&&(a.device.password="xxxxxx"));a.gateway&&(a.gateway.username&&(a.gateway.username="xxxxxx"),a.gateway.password&&(a.gateway.password="xxxxxx"));return a}catch(n){return this.toJSON()}};t.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);b&&b.info&&(this._deviceName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||
(a=JSON.parse(JSON.stringify(this.device)));return a};t.prototype._getGateway=function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);b&&b.info&&(this._gatewayName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};t.prototype._getDescription=
function(){var a=null;if(this._deviceName||this._gatewayName)a=this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{tmp=JSON.parse(JSON.stringify(this.device)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),a=JSON.stringify(tmp)}catch(J){a=JSON.stringify(this.device)}else if(this.gateway)try{tmp=JSON.parse(JSON.stringify(this.gateway)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),a=JSON.stringify(tmp)}catch(J){a=JSON.stringify(this.gateway)}var b=
this.command;b.ref&&(b=b.ref);return a+" | "+JSON.stringify(b)};t.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var c=a[b],g=0;g<c.length;g++){var d=c[g];if(d&&"IPv4"==d.family&&0==d.internal)return d.address}return null};t.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:null};t.prototype._buildSonosCommand=function(a){var b=this._getLocalIP(),c=this._getLocalPort();if(!b||!c)return null;switch(a){case "alarm_on":a=
"alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+b+":"+c+"/resources/rehau_alarm/"+a}};d.CommandAction=t;var K=function(){q.call(this);this.subtype=K.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagUpperThresholdAction")};util.inherits(K,t);K.SUBTYPE="command.dominoswiss.upperthreshold";
K.prototype.do=function(a,b){if(b&&b.trigger&&b.trigger.type==u.TYPE){var c=b.trigger._lastTigger;c&&c.upperThreshold?t.prototype.do.call(this,a,b):a&&a()}else a&&a()};d.BrelagUpperThresholdAction=K;var L=function(){q.call(this);this.subtype=L.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagLowerThresholdAction")};util.inherits(L,t);L.SUBTYPE="command.dominoswiss.lowerthreshold";L.prototype.do=function(a,b){if(b&&
b.trigger&&b.trigger.type==u.TYPE){var c=b.trigger._lastTigger;c&&c.lowerThreshold?t.prototype.do.call(this,a,b):a&&a()}else a&&a()};d.BrelagUpperThresholdAction=L;var E=function(){q.call(this);this.subtype=E.SUBTYPE;this.actionID=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudAction")};util.inherits(E,q);E.SUBTYPE="cloud_action";E.prototype.do=function(a){if(this.actionID){this._logger.log("trace","do cloud action:"+this.actionID);var b=require("x.hub.js").server;if(b)if(b=
b._cloudConnect){var c=JSON.stringify({type:"ACTION",data:this.actionID});c=new Buffer("EVT:"+c,"utf8");b.sendMessageActive("0103"+c.toString("hex"),function(b){a&&a(b)})}else a&&a(Error("no cloud connect"));else a&&a(Error("no server in hub"))}else a&&a(Error("action id is empty"))};E.prototype.cancel=function(a){a&&a(null,!1)};E.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.actionID=this.actionID;return a};E.prototype.fromJSON=function(a){a&&(this.actionID=
a.actionID)};var v=function(){q.call(this);this.subtype=v.SUBTYPE;this.macroName=this.groupName=null;this._canceling=!1;this._macroExecutorID=this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.MacroAction")};util.inherits(v,q);v.SUBTYPE="macro";v.prototype.do=function(a){if(this.groupName&&this.macroName){var b=require("x.hub.macroman.js");this._logger.log("trace","do macro:"+JSON.stringify(this.toJSON()));var c=this;this._running=!0;this._trace&&this._trace.log("execute macro | "+
this._getDescription());b.execute(this.groupName,this.macroName,function(b){c._trace&&c._trace.log("execute macro | "+c._getDescription()+" | return:"+JSON.stringify(b));c._canceling?(c._logger.log("trace","macro action canceled:"+JSON.stringify(c.toJSON())),c._canceling=!1,c._running=!1,b=c._cancelCB,c._cancelCB=null,b&&b()):(c._running=!1,a&&a(b))},function(a){a&&a.id&&(c._macroExecutorID=a.id)})}else a&&a(Error("no group or macro"))};v.prototype.cancel=function(a){this._running?(this._canceling=
!0,this._cancelCB=a,this._macroExecutorID&&require("x.hub.macroman.js").cancel(this._macroExecutorID)):a&&a(null,this._running)};v.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.groupName=this.groupName;a.macroName=this.macroName;return a};v.prototype.fromJSON=function(a){a&&(this.groupName=a.groupName,this.macroName=a.macroName)};v.prototype._getDescription=function(){return this.groupName+"."+this.macroName};d.MacroAction=v;var B=function(){q.call(this);
this._cancelCB=this.token=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.SnsAction")};util.inherits(B,q);B.prototype.do=function(a){if(this.token){var b=this;this._logger.log("trace","do sns:"+JSON.stringify(this.toJSON()));var c=new x.hub.taskman.Cloud;this._running=!0;this._trace&&this._trace.log("execute sns | "+this._getDescription());c._doRequest("GET","/xhub/sns/dosns?token="+this.token,null,null,null,null,function(c,e){b._trace&&b._trace.log("execute sns | "+b._getDescription()+
" | "+(c?"error:"+c.message:"response:"+e));b._canceling?(b._logger.log("trace","sns action canceled:"+JSON.stringify(b.toJSON())),b._canceling=!1,c=b._running,b._running=!1,e=b._cancelCB,b._cancelCB=null,e&&e(null,c)):(b._running=!1,c&&b._logger.log("warn","do sns error:"+c.stack),a&&a(c))})}else a&&a(Error("token is empty"))};B.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};B.prototype._getDescription=function(){return this.subtype+"."+
this.token};var G=function(){B.call(this);this.subtype=G.SUBTYPE;this.token=null};util.inherits(G,B);G.SUBTYPE="EMAIL";G.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};G.prototype.fromJSON=function(a){a&&(this.token=a.token)};d.EmailAction=G;var H=function(){B.call(this);this.subtype=H.SUBTYPE;this.token=null};util.inherits(H,B);H.SUBTYPE="PUSH";H.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;
a.token=this.token;return a};H.prototype.fromJSON=function(a){a&&(this.token=a.token)};d.PushAction=H;var I=function(){B.call(this);this.subtype=I.SUBTYPE;this.token=null};util.inherits(I,B);I.SUBTYPE="SMS";I.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};I.prototype.fromJSON=function(a){a&&(this.token=a.token)};d.SmsAction=I;var O=function(a,b){this._runCallback=b;this._finishCallback=null;this._action=a;var c=this;this.runCallback=
function(a){c._action.removeRunTask(c);c._runCallback&&c._runCallback(a)};this.finishCallback=function(){c._action.removeRunTask(c)}},w=function(){q.call(this);this.subtype=w.SUBTYPE;this.name=this.id=null;this._scriptRunTasks=[];this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ScriptAction")};util.inherits(w,q);w.SUBTYPE="script";w.prototype.do=function(a){if(this.id){var b=require("x.hub.scriptman.js").scriptManager;this._logger.log("trace","do script:"+JSON.stringify(this.toJSON()));
this._running=!0;a=new O(this,a);this._scriptRunTasks.push(a);this._trace&&this._trace.log("execute skript | "+this.id);b.runScript(this.id,a.runCallback,a.finishCallback)}else a&&a(Error("no script id"))};w.prototype.cancel=function(a){if(this._running){var b=require("x.hub.scriptman.js").scriptManager;this._scriptRunTasks=[];this._running=!1;this._logger.log("trace","script action canceled:"+JSON.stringify(this.toJSON()));b.stopScript(this.id,function(){a&&a(null,!0)})}else a&&a(null,this._running)};
w.prototype.removeRunTask=function(a){a=this._scriptRunTasks.indexOf(a);-1!=a&&this._scriptRunTasks.splice(a,1);0==this._scriptRunTasks.length&&(this._running=!1)};w.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.id=this.id;a.name=this.name;return a};w.prototype.fromJSON=function(a){a&&(this.id=a.id,this.name=a.name)};d.ScriptAction=w;var C=function(){q.call(this);this.subtype=C.SUBTYPE;this._to=this.value=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.WaitAction")};
util.inherits(C,q);C.SUBTYPE="wait";C.prototype.do=function(a){if(this.value){this._running=!0;var b=this;this._trace&&this._trace.log("execute wait | wait "+this.value+" ms");this._to=setTimeout(function(){b._trace&&b._trace.log("execute wait | wait expired");b._running=!1;b._to=null;a&&a()},this.value)}else a&&a()};C.prototype.cancel=function(a){this._running?(this._to&&(this._logger.log("trace","wait action canceled:"+JSON.stringify(this.toJSON())),clearTimeout(this._to),this._to=null),this._running=
!1,a&&a(null,!0)):a&&a(null,this._running)};C.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.value=this.value;return a};C.prototype.fromJSON=function(a){a&&(this.value=a.value)};d.WaitAction=C;var y=function(){q.call(this);this.subtype=y.SUBTYPE;this.page=this.remote=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ChangePageAction");this._cancelCB=null};util.inherits(y,q);y.SUBTYPE="remote.changepage";y.prototype.do=function(a){this._trace&&
this._trace.log("execute change page | "+this.remote+"."+this.page);this._running=!0;var b=[],c=require("os").networkInterfaces(),g;for(g in c)for(var e=c[g],d=0;d<e.length;d++){var f=e[d];"IPv4"==f.family&&0==f.internal&&b.push(f.address)}var l=this,k=0,p=function(){if(l._canceling){l._logger.log("trace","change page action canceled:"+JSON.stringify(l.toJSON()));l._canceling=!1;var c=l._running;l._running=!1;var g=l._cancelCB;l._cancelCB=null;g&&g(null,c)}else k++,k>=b.length?(l._running=!1,a&&a()):
l._sendEvent(b[k],p)};this._sendEvent(b[k],p)};y.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};y.prototype._sendEvent=function(a,b){var c=require("dgram"),g=require("unorm"),e={func:"changePage",remote:g.nfc(this.remote),page:g.nfc(this.page),time:Date.now()};e=new Buffer("{XC_EVT}"+JSON.stringify(e),"utf8");var d=c.createSocket({type:"udp4",reuseAddr:!0});d.bind(a,function(){d.setBroadcast(!0);d.send(e,0,e.length,1902,"255.255.255.255");
d.send(e,0,e.length,1902,"255.255.255.255",function(a){d.close();b&&b(a)})})};y.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.remote=this.remote;a.page=this.page;return a};y.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.page=a.page)};d.ChangePageAction=y;var z=function(){q.call(this);this.subtype=z.SUBTYPE;this.template=this.settings=this.action=this.popup=this.remote=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.PopupAction");
this._cancelCB=null};util.inherits(z,q);z.SUBTYPE="remote.popup";z.prototype.do=function(a){this._trace&&this._trace.log("execute popup action | "+this.remote+"."+this.popup+"."+this.action);this._running=!0;var b=[],c=require("os").networkInterfaces(),g;for(g in c)for(var e=c[g],d=0;d<e.length;d++){var f=e[d];"IPv4"==f.family&&0==f.internal&&b.push(f.address)}var l=this,k=0,p=function(){if(l._canceling){l._logger.log("trace","popup action canceled:"+JSON.stringify(l.toJSON()));l._canceling=!1;var c=
l._running;l._running=!1;var g=l._cancelCB;l._cancelCB=null;g&&g(null,c)}else k++,k>=b.length?(l._running=!1,a&&a()):l._sendEvent(b[k],p)};this._sendEvent(b[k],p)};z.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};z.prototype._sendEvent=function(a,b){var c=require("dgram"),g=require("unorm"),e={func:"popup",remote:g.nfc(this.remote),action:g.nfc(this.action),time:Date.now()};if(this.popup&&"open"===this.action&&(e.popup=g.nfc(this.popup),
this.settings))try{e.settings=g.nfc(JSON.stringify(this.settings))}catch(M){self._logger.log("error",M.message)}e=new Buffer("{XC_EVT}"+JSON.stringify(e),"utf8");var d=c.createSocket({type:"udp4",reuseAddr:!0});d.bind(a,function(){d.setBroadcast(!0);d.send(e,0,e.length,1902,"255.255.255.255");d.send(e,0,e.length,1902,"255.255.255.255",function(a){d.close();b&&b(a)})})};z.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.remote=this.remote;a.popup=this.popup;
a.action=this.action;a.settings=this.settings;a.template=this.template;return a};z.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.popup=a.popup,this.action=a.action,this.settings=a.settings,this.template=a.template)};d.PopupAction=z;var F=function(){t.call(this);this.subtype=F.SUBTYPE;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.AudioAction")};util.inherits(F,t);F.SUBTYPE="audio";F.prototype.do=function(a){if(this.device||this.gateway)if(this.command){var b=this.command;
b.ref&&(b=b.ref);this._logger.log("trace","do audio command:"+JSON.stringify(this._toBluredJSON()));var c=this._getDevice(),g=this._getGateway();this._running=!0;this._trace&&this._trace.log("execute audio command | "+this._getDescription());var d=this;require("x.hub.commandman.js").commandHandler.executeCommand(c,g,b,function(b){b&&b.error?d._trace&&d._trace.log("execute command | "+d._getDescription()+" | error:"+b.error.message):d._trace&&d._trace.log("execute command | "+d._getDescription()+" | success");
d._running=!1;a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};F.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};F.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};d.AudioAction=F;d.parse=function(e){if(!e||!e.type)return null;switch(e.type){case c.TYPE:var n=d.Root;break;case b.TYPE:n=b;break;case q.TYPE:switch(e.subtype){case t.SUBTYPE:n=
t;break;case K.SUBTYPE:n=K;break;case L.SUBTYPE:n=L;break;case G.SUBTYPE:n=G;break;case H.SUBTYPE:n=H;break;case I.SUBTYPE:n=I;break;case w.SUBTYPE:n=w;break;case C.SUBTYPE:n=C;break;case v.SUBTYPE:n=v;break;case D.SUBTYPE:n=D;break;case A.SUBTYPE:n=A;break;case y.SUBTYPE:n=y;break;case E.SUBTYPE:n=E;break;case F.SUBTYPE:n=F;break;case z.SUBTYPE:n=z;break;default:return null}break;case m.TYPE:n=m;break;case u.TYPE:n=u;break;case a.TYPE:n=a;break;case g.TYPE:n=g;break;case l.TYPE:n=l;break;case f.TYPE:n=
f;break;case k.TYPE:n=k;break;case h.TYPE:n=h;break;case p.TYPE:n=p;break;case r.TYPE:n=r;break;default:return null}n=new n;n.fromJSON(e);return n};return d}();
x.hub.taskman.Task=function(){var d=function(b){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Task");this.root=this.name=this.id=null;this.active=!0;this.singleton=this.rehauAlarmTask=this.isAlarmTask=!1;this.singletonMethod="ignore";this._trace=null;b&&(this.id=b.id,this.name=b.name,this.active=b.active,this.isAlarmTask=b.isAlarmTask,this.rehauAlarmTask=b.rehauAlarmTask,this.singleton=b.singleton,this.singletonMethod=b.singletonMethod);if("undefined"==typeof this.active||null==this.active)this.active=
!0;if("undefined"==typeof this.isAlarmTask||null==this.isAlarmTask)this.isAlarmTask=!1;if("undefined"==typeof this.rehauAlarmTask||null==this.rehauAlarmTask)this.rehauAlarmTask=!1};d.prototype.init=function(){this.root&&this.root.init(this.id)};d.prototype.getTriggers=function(){return this.root?this.root.getTriggers():[]};d.prototype.finalize=function(){try{this.root&&this.root.finalize(this.id)}catch(b){this._logger.log("warn","finalize task "+this.id+" error:"+b.message)}};d.prototype.trigger=
function(b){this.root?(this.root._onTriggered(),b&&b()):b&&b(Error("no content"))};d.prototype.cancel=function(b){this.root?(this.root.cancel(),b&&b()):b&&b(Error("no content"))};d.prototype.isActive=function(){return this.active};d.prototype.setActive=function(b){if("undefined"==typeof b||null==b)b=!0;"string"==typeof b&&(b="false"==b?!1:!0);this.active=b};d.prototype.toggleActive=function(){this.active=!this.active};d.prototype.setRehauAlarmTask=function(b){this.rehauAlarmTask=b};d.prototype.isRehauAlarmTask=
function(){return this.rehauAlarmTask};d.prototype.setAlarmTask=function(b){if("undefined"==typeof b||null==b)b=!1;"string"==typeof b&&(b="false"==b?!1:!0);this.isAlarmTask=b};d.prototype.isRunning=function(){return this.root?this.root.isRunning():!1};d.prototype.onStatusEvt=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onStatusEvt(b)};
d.prototype.onStatusEvtForTask=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive dedicated status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onDedicatedStatusEvt(b)};d.prototype.onIREvt=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive ir event");if(this.active&&this.root&&(!this.isAlarmTask||
require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onIREvt(b)};d.prototype.onTimerTick=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive timer tick");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onTimerTick(b)};d.prototype.onHttpEvt=function(b,c){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive http event");
if(this.active&&this.root)if(this.isAlarmTask&&!require("x.hub.taskman.js").taskManager._alarmTask._active)c&&c(null,!1);else this.root.onHttpEvt(b,c);else c&&c(null,!1)};d.prototype.toJSON=function(){var b={id:this.id,name:this.name,active:this.active,isAlarmTask:this.isAlarmTask,rehauAlarmTask:this.rehauAlarmTask,singleton:this.singleton,singletonMethod:this.singletonMethod,root:{}};this.root&&(b.root=this.root.toJSON());return b};d.prototype.startTaskTrace=function(b,c){this._trace||(this._trace=
new x.hub.taskman.TaskTrace(this),this.root&&this.root.setTrace(this._trace));this._trace.addListener(b);c&&c()};d.prototype.stopTaskTrace=function(b,c){this._trace&&(this._trace.removeListener(b),0==this._trace.getListeners().length&&(this.root&&this.root.setTrace(null),this._trace=null));c&&c()};d.prototype.toCloudRuleJSON=function(b,c,d,k,h){var a=[],g=this.getTriggers();if(!g||0==g.length)return null;for(var f=0;f<g.length;f++){var p=g[f];p&&"cloud.trigger.device"==p.type&&(p=p.toCloudTriggerFormat())&&
a.push(p)}return 0==a.length?null:{name:this.name,owner:c,app:b,action:[{sys:"mediola",data:{data:{XC_FNC:"DoTask",id:this.id},token:h,ccs:d+(k?":"+k:""),cmd:"cmd"}}],trigger:a}};d.prototype.getCloudDeviceTriggerGateway=function(){if(!this.root)return null;var b=this.root.getTriggers(),c=null;if(!b||0>=b.length)return null;for(var d=0;d<b.length;d++){var k=b[d];if(k&&"cloud.trigger.device"==k.type&&(c=k._getGateway()))break}return c};d.parse=function(b){if(!b||!b.id||!b.name)return null;var c=new d(b);
b.root&&(c.root=x.hub.taskman._Block.parse(b.root),c.root&&(c.root._task=c,c.root.singleton=c.singleton,c.root.singletonMethod=c.singletonMethod));return c};return d}();
x.hub.taskman.AlarmTask=function(){var d=function(){this._active=!1;this._delay=0;this._activateDelayTO=null};d.prototype.init=function(){this._active="true"==localStorage.getItem("x.hub.taskman.TaskManager.alarmActive");this._delay=parseInt(localStorage.getItem("x.hub.taskman.TaskManager.alarmDelay"))};d.prototype.setAlarmActive=function(b,c,d,k){var f=function(a,b,c){if("undefined"==typeof b||null==b)b=!0;"string"==typeof b&&(b="false"==b?!1:!0);a._tasks.forEach(function(a){a.isAlarmTask&&(a.active=
b)});a._writeData(c)};if(this._getAlarmPin()!=c)c=Error("pin error"),c.code=x.hub.taskman.ERROR_CODE.Pin_Error,k&&k(c);else if(this._activateDelayTO&&(clearTimeout(this._activateDelayTO),this._activateDelayTO=null),this._delay&&b){var a=this;this._activateDelayTO=setTimeout(function(){localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",b);a._active=b;a._activateDelayTO=null;f(d,b)},1E3*this._delay);k&&k()}else localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",b),this._active=b,
f(d,b,k)};d.prototype.setAlarmDelay=function(b,c,d){this._getAlarmPin()!=c?(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmDelay",b),this._delay=b,d&&d())};d.prototype.getAlarmInfo=function(b){b&&b(null,{active:this._active,delay:this._delay?this._delay:0,pendingActive:null!=this._activateDelayTO})};d.prototype.selectAlarmTask=function(b,c,d,k,h){if(b){for(var a=null,g=0;g<k.length;g++){var f=k[g];if(f.id==b){a=f;break}}a?
(b=this._getAlarmPin(),d&&d==b?this._active?h&&h(Error("alarm task active")):(a.setAlarmTask(c),h&&h()):(c=Error("pin error"),c.code=x.hub.taskman.ERROR_CODE.Pin_Error,h&&h(c))):h&&h(Error("no such task:"+b))}else h&&h(Error("task id is null"))};d.prototype._getAlarmPin=function(){return localStorage.getItem("x.hub.taskman.TaskManager.alarmPin")?localStorage.getItem("x.hub.taskman.TaskManager.alarmPin"):d.DEFAULT_PIN};d.prototype.setAlarmPin=function(b,c,d){var f=this._getAlarmPin();b?c!=f?(b=Error("pin error"),
b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmPin",b),d&&d()):d&&d(Error("new pin invalid"))};d.DEFAULT_PIN="0000";return d}();
x.hub.taskman.TaskTrace=function(){var d=function(b){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskTrace");this._task=b;this._listeners=[]};d.prototype.addListener=function(b){b&&-1==this._listeners.indexOf(b)&&this._listeners.push(b)};d.prototype.removeListener=function(b){b&&(b=this._listeners.indexOf(b),-1!=b&&this._listeners.splice(b,1))};d.prototype.getListeners=function(b){return this._listeners};d.prototype.log=function(b){this._logger.log("trace","[Task "+this._task.id+
"]:"+b);b="["+this._getTimestamp()+"] "+b;this._listeners.forEach(function(c){c&&c(b)})};d.prototype._getTimestamp=function(){return(new Date).toTimeString()};return d}();x.hub.taskman.rehau={};
x.hub.taskman.rehau.AlarmTaskManager=function(){var d=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmDoor");this._alarmTask=this._activateEvent=this._device=this._id=null};d.prototype.init=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");a&&a.addStateDevice&&this._activateEvent&&this._activateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};
d.prototype.finalize=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");a&&a.removeStateDevice&&this._activateEvent&&this._activateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};d.prototype.setAlarmTask=function(a){this._alarmTask=a};d.prototype.getID=function(){return this._id};d.prototype.setID=function(a){this._id=a};d.prototype.setDevice=function(a){this._device=
a};d.prototype.setActivateEvent=function(a){this._activateEvent=a};d.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent}};d.prototype.matchDevice=function(a){return this._device&&a?this._device.type==a.type&&this._device.address==a.address:!1};d.prototype.onStatusEvt=function(a){a&&a.data&&this._activateEvent&&this._activateEvent.status==a.data.key&&this._activateEvent.value==a.data.value&&(this._logger.log("trace","alarm door:"+this._device.address+
" receive event:"+a.data.value+" and trigger door alarm"),this._alarmTask&&this._alarmTask.triggerDoorAlarm())};d.buildDoorfromJSON=function(a){if(!a||!a.device)return null;var b=new d;b.setID(a.id);b.setDevice(a.device);b.setActivateEvent(a.activateEvent);return b};var b=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmKey");this._alarmTask=this._deactivateEvent=this._activateEvent=this._device=this._id=null};b.prototype.init=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");
a&&a.addStateDevice&&(this._activateEvent&&this._activateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};b.prototype.finalize=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");
a&&a.removeStateDevice&&(this._activateEvent&&this._activateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};b.prototype.setAlarmTask=function(a){this._alarmTask=a};b.prototype.getID=function(){return this._id};
b.prototype.setID=function(a){this._id=a};b.prototype.setDevice=function(a){this._device=a};b.prototype.setActivateEvent=function(a){this._activateEvent=a};b.prototype.setDeactivateEvent=function(a){this._deactivateEvent=a};b.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent,deactivateEvent:this._deactivateEvent}};b.prototype.matchDevice=function(a){return this._device&&a?this._device.type==a.type&&this._device.address==a.address:!1};b.prototype.onStatusEvt=
function(a){if(a&&a.data)if(this._activateEvent&&this._activateEvent.status==a.data.key&&this._activateEvent.value==a.data.value){if(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+a.data.key+" and activate alarm task"),this._alarmTask){a=this._alarmTask.getManager();var b=this._alarmTask.getID();a._setAlarmActive(b,!0,function(a){})}}else this._deactivateEvent&&this._deactivateEvent.status==a.data.key&&this._deactivateEvent.value==a.data.value&&(this._logger.log("trace",
"alarm key:"+this._device.address+" receive event:"+a.data.key+" and deactivate alarm task"),this._alarmTask&&this._alarmTask.deactivate())};b.buildKeyfromJSON=function(a){if(!a||!a.device)return null;var c=new b;c.setID(a.id);c.setDevice(a.device);c.setActivateEvent(a.activateEvent);c.setDeactivateEvent(a.deactivateEvent);return c};var c=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmConfirmation");this._alarmTask=this._preAlarmNotificationInterval=this._deactivateAction=
this._activateAction=this._device=this._id=null};c.prototype.setAlarmTask=function(a){this._alarmTask=a};c.prototype.getID=function(){return this._id};c.prototype.setID=function(a){this._id=a};c.prototype.setDevice=function(a){this._device=a};c.prototype.setActivateAction=function(a){this._activateAction=a};c.prototype.setDeactivateAction=function(a){this._deactivateAction=a};c.prototype.toJSON=function(){return{id:this._id,device:this._device,activateAction:this._activateAction,deactivateAction:this._deactivateAction}};
c.prototype.activationBlockedForAlarmKey=function(){if(this._device&&this._activateAction&&"aio"==this._device.sys&&"HM"==this._device.type&&"ip_siren"==this._device.data){var a=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var b=this;a.executeCommand(this._device,null,{value:"triggerAlarm12,6,2,0",ext:[{value:"alarmAudio",ext:"FREQUENCY_FALLING"},{value:"alarmVisual",ext:"BLINKING_ALTERNATELY_REPEATING"},{value:"alarmDur",
ext:1},{value:"alarmDurUnit",ext:"S"}]},function(a){a&&a.error&&b._logger.log("trace","do activate confirmation error:"+a.error.message)})}};c.prototype.onActivated=function(){if(this._device&&this._activateAction){var a=this._activateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand(this._activateAction.ext),!a))return;var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var c=this;b.executeCommand(this._device,
null,a,function(a){a&&a.error&&c._logger.log("trace","do activate confirmation error:"+a.error.message)})}};c.prototype.onDeactivated=function(){this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null);if(this._device&&this._deactivateAction){var a=this._deactivateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand(this._deactivateAction.ext),!a))return;var b=require("x.hub.commandman.js").commandHandler;
this._logger.log("trace","do deactivate confirmation:"+JSON.stringify(this.toJSON()));var c=this;b.executeCommand(this._device,null,a,function(a){a&&c._logger.log("trace","do deactivate confirmation error:"+a.message)})}};c.prototype.startPreAlarmNotification=function(){if(!this._preAlarmNotificationInterval){var a=this;this._doPreAlarmNotification();this._preAlarmNotificationInterval=setInterval(function(){a._doPreAlarmNotification()},7E3)}};c.prototype.stopPreAlarmNotification=function(){this._preAlarmNotificationInterval&&
(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null)};c.prototype._doPreAlarmNotification=function(){if(this._device&&this._activateAction){var a=this._activateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand("pre_alarm"),!a))return;var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do pre alarm notification:"+JSON.stringify(this.toJSON()));var c=this;b.executeCommand(this._device,null,a,function(a){a&&
a.error&&c._logger.log("trace","do pre alarm notification error:"+a.error.message)})}};c.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var c=a[b],d=0;d<c.length;d++){var f=c[d];if(f&&"IPv4"==f.family&&0==f.internal)return f.address}return null};c.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:null};c.prototype._buildSonosCommand=function(a){var b=this._getLocalIP(),c=this._getLocalPort();if(!b||!c)return null;
switch(a){case "alarm_on":a="alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+b+":"+c+"/resources/rehau_alarm/"+a,timeout:15}};c.buildConfirmationfromJSON=function(a){if(!a||!a.device)return null;var b=new c;b.setID(a.id);b.setDevice(a.device);b.setActivateAction(a.activateAction);b.setDeactivateAction(a.deactivateAction);return b};var f=function(a){this._logger=
Logger.getLogger("x.hub.taskman.rehau.AlarmTask");this._id=a;this._pin=null;this._active=!1;this._delay=0;this._doorAlarmDelay=5;this._alarmKeys=[];this._alarmDoors=[];this._manager=this._doorAlarmDelayTimer=this._activateDelayTimer=this._associateTaskId_prealarm=this._associateTaskId_alarm=this._alarmConfirmation=null};f.DEFAULT_PIN="0000";f.prototype.init=function(a){this._logger.log("trace","init rehau alarm task");this._initAllAlarmKeys();this._initAllAlarmDoors();this._initAllAlarmWindowsSensors();
a&&a()};f.prototype._initAllAlarmKeys=function(){for(var a=0;a<this._alarmKeys.length;a++){var b=this._alarmKeys[a];b&&b.init()}};f.prototype._initAllAlarmDoors=function(){for(var a=0;a<this._alarmDoors.length;a++){var b=this._alarmDoors[a];b&&b.init()}};f.prototype._initAllAlarmWindowsSensors=function(){this._active&&require("x.hub.m.enocean.js").setRehauAlarm(this._active)};f.prototype.setManager=function(a){this._manager=a};f.prototype.getManager=function(){return this._manager};f.prototype.getID=
function(){return this._id};f.prototype.getDelay=function(){return this._delay};f.prototype.setDelay=function(a){this._delay=a};f.prototype.getAssociateTaskIdAlarm=function(){return this._associateTaskId_alarm};f.prototype.setAssociateTaskIdAlarm=function(a){this._associateTaskId_alarm=a};f.prototype.getAssociateTaskIdPreAlarm=function(){return this._associateTaskId_prealarm};f.prototype.setAssociateTaskIdPreAlarm=function(a){this._associateTaskId_prealarm=a};f.prototype.getPin=function(){return this._pin?
this._pin:f.DEFAULT_PIN};f.prototype.setPin=function(a){this._pin=a};f.prototype.getDoorAlarmDelay=function(){return this._doorAlarmDelay};f.prototype.setDoorAlarmDelay=function(a){this._doorAlarmDelay=a};f.prototype.isActive=function(){return this._active};f.prototype.isWaitForActive=function(){return this._activateDelayTimer&&!this._active?!0:!1};f.prototype.cancelDelayActive=function(){this._activateDelayTimer&&clearTimeout(this._activateDelayTimer);this._activateDelayTimer=null;this._doorAlarmDelayTimer&&
clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null};f.prototype.activate=function(){var a=require("x.hub.m.enocean.js");if(a.isRehauWindowOpen()||require("x.hub.m.hm.js").isWindowOpen())return!0;var b=this;if(this._delay)this._logger.log("trace","activate alarm task:"+this._id+" after "+this._delay+" seconds"),this._activateDelayTimer=setTimeout(function(){b._logger.log("trace","activate alarm task:"+this._id);b._active=!0;b._setAssociateTaskActive(!0);b._manager&&b._manager.save();
a.setRehauAlarm(!0);b._activateDelayTimer=null;if(b._alarmConfirmation)b._alarmConfirmation.onActivated()},1E3*this._delay);else if(this._logger.log("trace","activate alarm task:"+this._id),this._active=!0,this._setAssociateTaskActive(!0),this._manager&&this._manager.save(),a.setRehauAlarm(!0),this._alarmConfirmation)this._alarmConfirmation.onActivated();return!1};f.prototype.deactivate=function(){this._active=!1;this._activateDelayTimer&&clearTimeout(this._activateDelayTimer);this._activateDelayTimer=
null;this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null;this._logger.log("trace","deactivate alarm task:"+this._id);this._setAssociateTaskActive(!1);this._manager&&this._manager.save();require("x.hub.m.enocean.js").setRehauAlarm(!1);if(this._alarmConfirmation)this._alarmConfirmation.onDeactivated()};f.prototype._setAssociateTaskActive=function(a,b){if(this._manager){var c=0;this._associateTaskId_alarm&&(c+=1);this._associateTaskId_prealarm&&(c+=1);var d=
function(){c--;0==c&&b&&b()};this._associateTaskId_alarm&&this._manager.setAssociateTaskActive(this._associateTaskId_alarm,a,d);this._associateTaskId_prealarm&&this._manager.setAssociateTaskActive(this._associateTaskId_prealarm,a,d)}else b&&b(Error("manager is null"))};f.prototype.activationBlockedForAlarmKey=function(){this._alarmConfirmation&&this._alarmConfirmation.activationBlockedForAlarmKey()};f.prototype.addAlarmKey=function(a,c){if(a)if(a=b.buildKeyfromJSON(a))if(a.getID())c&&c(Error("id for new alarm key is not null "));
else{a.setID(this._generateAlarmKeyID());this._addAlarmKeySync(a);var d=this;this._manager.save(function(a){c&&c(a,d.toJSON())})}else c&&c(Error("alarm key json invalid"));else c&&c(Error("alarm key json is null"))};f.prototype.updateAlarmKey=function(a,c){if(a)if(a=b.buildKeyfromJSON(a)){var d=a.getID();if(d){var g=this._getAlarmKeySync(d);if(g){this._deleteAlarmKeySync(g);this._addAlarmKeySync(a);var f=this;this._manager.save(function(a){c&&c(a,f.toJSON())})}else c&&c(Error("no such alarm key with id:"+
d))}else c&&c(Error("id for alarm key is null"))}else c&&c(Error("alarm key json invalid"));else c&&c(Error("alarm key json is null"))};f.prototype.deleteAlarmKey=function(a,b){if(a){var c=this._getAlarmKeySync(a.id);if(c){this._deleteAlarmKeySync(c);var d=this;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("no such alarm key with id:"+a.id))}else b&&b(Error("alarm key is null"))};f.prototype.addAlarmDoor=function(a,b){if(a)if(a=d.buildDoorfromJSON(a))if(a.getID())b&&b(Error("id for new alarm door is not null "));
else{a.setID(this._generateAlarmDoorID());this._addAlarmDoorSync(a);var c=this;this._manager.save(function(a){b&&b(a,c.toJSON())})}else b&&b(Error("alarm door json invalid"));else b&&b(Error("alarm door json is null"))};f.prototype.updateAlarmDoor=function(a,b){if(a)if(a=d.buildDoorfromJSON(a)){var c=a.getID();if(c){var g=this._getAlarmDoorSync(c);if(g){this._deleteAlarmDoorSync(g);this._addAlarmDoorSync(a);var f=this;this._manager.save(function(a){b&&b(a,f.toJSON())})}else b&&b(Error("no such alarm door with id:"+
c))}else b&&b(Error("id for alarm door is null"))}else b&&b(Error("alarm door json invalid"));else b&&b(Error("alarm door json is null"))};f.prototype.deleteAlarmDoor=function(a,b){if(a){var c=this._getAlarmDoorSync(a.id);if(c){this._deleteAlarmDoorSync(c);var d=this;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("no such alarm door with id:"+a.id))}else b&&b(Error("alarm door is null"))};f.prototype.setAlarmConfirmation=function(a,b){if(a)if(a=c.buildConfirmationfromJSON(a)){a.setAlarmTask(this);
var d=this;this._alarmConfirmation=a;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("alarm confirmation json invalid"));else b&&b(Error("alarm confirmation json is null"))};f.prototype.getAlarmTaskSync=function(a){return this._taskmanager.readTaskSync(a)};f.prototype.triggerDoorAlarm=function(){if(this._active)if(!this._doorAlarmDelay)this._logger.log("trace","no door alarm delay, execute associated task:"+this._associateTaskId_alarm),this._associateTaskId_alarm&&this._manager&&
this._manager.executeAssociateTask(this._associateTaskId_alarm);else if(!this._doorAlarmDelayTimer){this._alarmConfirmation&&(this._logger.log("trace","door alarm start pre-alarm notification"),this._alarmConfirmation.startPreAlarmNotification());this._logger.log("trace","door alarm execute associated task:"+this._associateTaskId_alarm+" after "+this._doorAlarmDelay+" seconds");var a=this;this._doorAlarmDelayTimer=setTimeout(function(){a._doorAlarmDelayTimer=null;a._alarmConfirmation&&(a._logger.log("trace",
"door alarm stop pre-alarm notification"),a._alarmConfirmation.stopPreAlarmNotification());a._associateTaskId_alarm&&(a._logger.log("trace","door alarm execute associated task:"+a._associateTaskId_alarm),a._manager&&a._manager.executeAssociateTask(a._associateTaskId_alarm))},1E3*this._doorAlarmDelay)}};f.prototype.triggerWindowSensorAlarm=function(a){this._active&&(a&&this._associateTaskId_prealarm?this._manager&&this._manager.executeAssociateTask(this._associateTaskId_prealarm):!a&&this._associateTaskId_alarm&&
this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm))};f.prototype.onStatusEvt=function(a){if(a){for(var b=0;b<this._alarmKeys.length;b++){var c=this._alarmKeys[b];if(c&&c.matchDevice(a.device))c.onStatusEvt(a)}for(b=0;b<this._alarmDoors.length;b++)if((c=this._alarmDoors[b])&&c.matchDevice(a.device))c.onStatusEvt(a)}};f.prototype._getAlarmKeySync=function(a){if(!a)return null;var b=this._alarmKeys.length;if(!b)return null;for(;b--;){var c=this._alarmKeys[b];if(c&&c.getID()==
a)return c}return null};f.prototype._addAlarmKeySync=function(a){a.setAlarmTask(this);this._alarmKeys.push(a);a.init()};f.prototype._deleteAlarmKeySync=function(a){a.finalize();a=this._alarmKeys.indexOf(a);-1!=a&&this._alarmKeys.splice(a,1)};f.prototype._getAlarmDoorSync=function(a){if(!a)return null;var b=this._alarmDoors.length;if(!b)return null;for(;b--;){var c=this._alarmDoors[b];if(c&&c.getID()==a)return c}return null};f.prototype._addAlarmDoorSync=function(a){a.setAlarmTask(this);this._alarmDoors.push(a);
a.init()};f.prototype._deleteAlarmDoorSync=function(a){a.finalize();a=this._alarmDoors.indexOf(a);-1!=a&&this._alarmDoors.splice(a,1)};f.prototype._generateAlarmKeyID=function(){var a=[],b=this._alarmKeys.length;if(0==b)return 1;for(;b--;){var c=this._alarmKeys[b];c&&(a[c.getID()]=!0)}for(b=1;a[b];)b++;return b};f.prototype._generateAlarmDoorID=function(){var a=[],b=this._alarmDoors.length;if(0==b)return 1;for(;b--;){var c=this._alarmDoors[b];c&&(a[c.getID()]=!0)}for(b=1;a[b];)b++;return b};f.prototype._getActivationDelayTimer=
function(a){return this._activateDelayTimer[a]};f.prototype._clearActivationDelayTimer=function(a){var b=this._activateDelayTimer[a];b&&clearTimeout(b);delete this._activateDelayTimer[a]};f.prototype.toJSON=function(){for(var a={id:this._id,active:this._active,delay:this._delay,doorAlarmDelay:this._doorAlarmDelay,alarmKeys:[],alarmDoors:[],alarmConfirmation:null,associateTaskId_alarm:this._associateTaskId_alarm,associateTaskId_prealarm:this._associateTaskId_prealarm},b=0;b<this._alarmKeys.length;b++){var c=
this._alarmKeys[b];c&&(c=c.toJSON())&&a.alarmKeys.push(c)}for(b=0;b<this._alarmDoors.length;b++)(c=this._alarmDoors[b])&&(c=c.toJSON())&&a.alarmDoors.push(c);this._alarmConfirmation&&(a.alarmConfirmation=this._alarmConfirmation.toJSON());return a};f.buldTaskFromJSON=function(a){if(!a||!a.id)return null;var g=new f(a.id);g._pin=a.pin;g._active=a.active;g._delay=a.delay;g._doorAlarmDelay=a.doorAlarmDelay;g._associateTaskId_alarm=a.associateTaskId_alarm;g._associateTaskId_prealarm=a.associateTaskId_prealarm;
if(a.alarmKeys)for(var k=0;k<a.alarmKeys.length;k++){var h=a.alarmKeys[k];h&&(h=b.buildKeyfromJSON(h))&&(h.setAlarmTask(g),g._alarmKeys.push(h))}if(a.alarmDoors)for(k=0;k<a.alarmDoors.length;k++)if(h=a.alarmDoors[k])if(h=d.buildDoorfromJSON(h))h.setAlarmTask(g),g._alarmDoors.push(h);a.alarmConfirmation&&(a=c.buildConfirmationfromJSON(a.alarmConfirmation))&&(a.setAlarmTask(g),g._alarmConfirmation=a);return g};var k=function(a){this._alarmTaskTokenPoll=[];this._manager=a};k.prototype.generateToken=
function(a){var b=this._manager._getAlarmTask(a);if(null==b||100<this._alarmTaskTokenPoll.length)return null;for(var c=this._generateNonce();this._nonceExist(c);)c=this._generateNonce();b=b.getPin();b=this._hashPin(c,b);var d=this,f={nonce:c,hash:b,taskID:a,timeout:null,failedCount:0};this._alarmTaskTokenPoll.push(f);f.timeout=setTimeout(function(){d._tokenExpired(f)},3E4);return c};k.prototype.authenticate=function(a,b){if(null==this._manager._getAlarmTask(a)||20>=b.length)return!1;var c=b.substr(0,
20);b=b.substr(20);for(var d=null,f=0;f<this._alarmTaskTokenPoll.length;f++){var g=this._alarmTaskTokenPoll[f];if(g&&g.nonce==c&&g.hash==b&&g.taskID==a)return this._tokenExpired(g),!0;g&&g.nonce==c&&(d=g)}d&&(d.failedCount+=1,3<=d.failedCount&&this._tokenExpired(d));return!1};k.prototype.expireAllToken=function(a){var b=[],c,d;for(c=0;c<this._alarmTaskTokenPoll.length;c++)(d=this._alarmTaskTokenPoll[c])&&d.taskID==a&&b.push(d);if(b&&0<b.length)for(c=0;c<this._alarmTaskTokenPoll.length;c++)d=this._alarmTaskTokenPoll[c],
this._tokenExpired(d);return!1};k.prototype._tokenExpired=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null);a=this._alarmTaskTokenPoll.indexOf(a);-1!=a&&this._alarmTaskTokenPoll.splice(a,1)};k.prototype._nonceExist=function(a){for(var b=0;b<this._alarmTaskTokenPoll.length;b++){var c=this._alarmTaskTokenPoll[b];if(c&&c.nonce==a)return!0}return!1};k.prototype._generateNonce=function(){return require("crypto").randomBytes(10).toString("hex")};k.prototype._hashPin=function(a,b){a=a.substr(5,
4);var c=require("crypto").createHash("sha1");c.update(a+b);return c.digest("hex")};var h=function(a){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTaskManager");this._taskmanager=a;this._alarmTasks=[];this._auth=new k(this)};h.FILE_NAME="alarm_rehau.json";h.prototype.init=function(a){this._logger.log("trace","init rehau alarm task manager");var b=this;this._loadSettings(function(c){c&&b._logger.log("warn","init rehau alarm task manager error:"+c.message);b._setupDefaultAlarmTask();b._initAllAlarmTasks();
a&&a()})};h.prototype.save=function(a){this._saveSettings(a)};h.prototype.challenge=function(a,b){this._getAlarmTask(a)?(a=this._auth.generateToken(a),b&&b(a?null:Error("generate token failed"),{token:a})):b&&b(Error("no such alarm task with id:"+a))};h.prototype.getAlarmInfo=function(a){var b=this._toSettingsJSON();a&&a(null,b)};h.prototype.setAlarmDelay=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?(f.setDelay(b),this._saveSettings(function(a){d&&
d(a,f.toJSON())})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.selectAssociateTaskAlarm=function(a,b,c,d){var f=this._getAlarmTask(a);if(f){var g=null;if(b&&(g=this._taskmanager.readTaskSync(b),!g)){d&&d(Error("no such task with id:"+b));return}if(f.isActive())d&&d(Error("alarm task is active"));else if(this._auth.authenticate(a,c)){a=f.getAssociateTaskIdPreAlarm();(c=f.getAssociateTaskIdAlarm())&&c!=b&&c!=a&&(a=
this._taskmanager.readTaskSync(c))&&a.setRehauAlarmTask(!1);f.setAssociateTaskIdAlarm(b);g&&(g.setRehauAlarmTask(!0),g.setActive(!1));var k=this;this._saveSettings(function(a){a?d&&d(a):k._taskmanager.save(function(a){d&&d(a,f.toJSON())})})}else b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)}else d&&d(Error("no such alarm task with id:"+a))};h.prototype.selectAssociateTaskPreAlarm=function(a,b,c,d){var f=this._getAlarmTask(a);if(f){var g=null;if(b&&(g=this._taskmanager.readTaskSync(b),
!g)){d&&d(Error("no such task with id:"+b));return}if(f.isActive())d&&d(Error("alarm task is active"));else if(this._auth.authenticate(a,c)){a=f.getAssociateTaskIdAlarm();(c=f.getAssociateTaskIdPreAlarm())&&c!=b&&c!=a&&(a=this._taskmanager.readTaskSync(c))&&a.setRehauAlarmTask(!1);f.setAssociateTaskIdPreAlarm(b);g&&(g.setRehauAlarmTask(!0),g.setActive(!1));var k=this;this._saveSettings(function(a){a?d&&d(a):k._taskmanager.save(function(a){d&&d(a,f.toJSON())})})}else b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,
d&&d(b)}else d&&d(Error("no such alarm task with id:"+a))};h.prototype.setAlarmActive=function(a,b,c,d){b||this._auth.authenticate(a,c)?this._setAlarmActive(a,b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a))};h.prototype._setAlarmActive=function(a,b,c){for(var d=null,f=0;f<this._alarmTasks.length;f++)if(this._alarmTasks[f])if(this._alarmTasks[f].getID()==a)d=this._alarmTasks[f];else{if(this._alarmTasks[f].isActive()){c&&c(Error("another alarm task with id:"+this._alarmTasks[f].getID()+
" is active"));return}this._alarmTasks[f].isWaitForActive()&&this._alarmTasks[f].cancelDelayActive()}d?b&&d.isActive()?c&&c(null,d.toJSON()):b&&!d.isActive()?d.activate()?(a=Error("rehau window is open"),a.code="200002",c&&c(a)):c&&c(null,d.toJSON()):(d.deactivate(),c&&c(null,d.toJSON())):c&&c(Error("no such alarm task with id:"+a))};h.prototype.setNewPin=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.getPin()==b?d&&
d():(f.setPin(b),this._auth.expireAllToken(a),this._saveSettings(function(a){d&&d(a)})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setDoorAlarmDelay=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?(f.setDoorAlarmDelay(b),this._saveSettings(function(a){d&&d(a,f.toJSON())})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,
d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.addAlarmKey=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.addAlarmKey(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.updateAlarmKey=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.updateAlarmKey(b,
d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.deleteAlarmKey=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.deleteAlarmKey(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.addAlarmDoor=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?
d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.addAlarmDoor(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.updateAlarmDoor=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.updateAlarmDoor(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.deleteAlarmDoor=
function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.deleteAlarmDoor(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setAlarmConfirmation=function(a,b,c,d){var f=this._getAlarmTask(a);f?f.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?f.setAlarmConfirmation(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,
d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setAssociateTaskActive=function(a,b,c){var d=this._taskmanager.readTaskSync(a);d?(d.setActive(b),this._taskmanager.save(c)):c&&c(Error("no such task with id:"+a))};h.prototype.executeAssociateTask=function(a,b){var c=this._taskmanager.readTaskSync(a);c?c.trigger(b):b&&b(Error("no such task with id:"+a))};h.prototype.onStatusEvtForTask=function(a,b){this._logger.log("debug","for task:"+b+" receive status event:"+JSON.stringify(a));
if(b=this._getAlarmTask(b))b.onStatusEvt(a)};h.prototype.onWindowSensorAlarmTriggered=function(a){for(var b=0;b<this._alarmTasks.length;b++){var c=this._alarmTasks[b];c&&c.isActive()&&c.triggerWindowSensorAlarm(a)}};h.prototype._getAlarmTask=function(a){for(var b=0;b<this._alarmTasks.length;b++){var c=this._alarmTasks[b];if(c&&c.getID()==a)return c}return null};h.prototype._isAlarmTaskActive=function(a){};h.prototype._setupDefaultAlarmTask=function(){if(0==this._alarmTasks.length){var a=new f(1);
a.setManager(this);this._alarmTasks.push(a)}1==this._alarmTasks.length&&(a=this._alarmTasks[0],a=1==a.getID()?2:1,a=new f(a),a.setManager(this),this._alarmTasks.push(a))};h.prototype._initAllAlarmTasks=function(){for(var a=0;a<this._alarmTasks.length;a++){var b=this._alarmTasks[a];b&&b.init()}};h.prototype._loadSettings=function(a){var b=this,c=this._getFile();fs_extra.ensureFile(c,function(d){d?a&&a(d):b._loadFile(c,function(c,d){c?a&&a(c):(b._fromSettingsJSON(d),a&&a())})})};h.prototype._saveSettings=
function(a){var b=this._getFile(),c=this._toSettingsJSON();this._saveFile(b,c,function(b){a&&a(b)})};h.prototype._fromSettingsJSON=function(a){if(a&&Array.isArray(a))for(var b=0;b<a.length;b++){var c=f.buldTaskFromJSON(a[b]);c&&(c.setManager(this),this._alarmTasks.push(c))}};h.prototype._toSettingsJSON=function(){for(var a=[],b=0;b<this._alarmTasks.length;b++){var c=this._alarmTasks[b];c&&a.push(c.toJSON())}return a};h.prototype._loadFile=function(a,b){fs.readFile(a,"utf8",function(a,c){if(a)b&&b(a);
else if(c)try{var d=JSON.parse(c);b&&b(null,d)}catch(r){b&&b(r)}else b&&b(null,null)})};h.prototype._saveFile=function(a,b,c){fs.writeFile(a,JSON.stringify(b,null,2),function(a){c&&c(a)})};h.prototype._getFile=function(){var a=fileman.fileManager.getUserRootDataPath();return path.resolve(a,h.FILE_NAME)};return h}();
x.hub.taskman.TaskManager=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskManager");this.version=d.TMP_VERSION;this._tasks=[];this._alarmTask=new x.hub.taskman.AlarmTask;this._mode=31;this._lock=!1};d.TMP_VERSION="1.0.0";d.NS_VERSION="2.3.2";d.FILE_NAME="tm.json";d.prototype.init=function(b){this._alarmTask.init();this._load(b)};d.prototype.clear=function(){for(var b=0;b<this._tasks.length;b++)try{this._tasks[b].finalize()}catch(c){}x.hub.taskman._TimerManager.clear();
x.hub.taskman._AstroManager.clear();x.hub.taskman._PeriodicTimerManager.clear();this._tasks=[]};d.prototype.save=function(b){this._writeData(b)};d.prototype.reload=function(b){this.clear();this._load(b)};d.prototype.import=function(b,c){var d=this;this._writeFile(b,function(b){b?c&&c(b):d.reload(c)})};d.prototype._load=function(b){var c=this,d=require("fs-extra"),k=this._getFile();d.ensureFile(k,function(d){d?b&&b(d):c._loadData(function(a,d){a?b&&b(a):(c._tasks=d,c._sort(),c._lock||d.forEach(function(a){try{a.init()}catch(p){console.error(p)}}),
b&&b())})})};d.prototype.lock=function(){this._lock=!0};d.prototype.unlock=function(){this._lock=!1};d.prototype.createTask=function(b,c){if(b){for(var d=1,k=-1,h=0;h<this._tasks.length;h++)if(this._tasks[h].id>d){b.id=d;k=h;break}else d++;-1==k&&(b.id=d,k=this._tasks.length);this._tasks.splice(k,0,b);this._lock||b.init();this._writeData(function(a){a?c&&c(a):c&&c(null,b.toJSON())})}else c&&c(Error("task is null"))};d.prototype.readTask=function(b,c){if(b){for(var d=null,k=0;k<this._tasks.length;k++){var h=
this._tasks[k];if(h.id==b){d=h;break}}d?c&&c(null,d):c&&c(Error("no such task with id:"+b))}else c&&c(Error("task id is null"))};d.prototype.readAllTasks=function(b){b&&b(null,this._tasks)};d.prototype.updateTask=function(b,c,d){for(var f=null,h=-1,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b.id){f=g;h=a;break}}if(f){if(f.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}a=this._alarmTask._getAlarmPin();if(!c||c!=a){b=Error("pin error");b.code=x.hub.taskman.ERROR_CODE.Pin_Error;
d&&d(b);return}}f.isRehauAlarmTask()&&f.isActive()?d&&d(Error("rehau alarm task active")):(f.finalize(),this._tasks.splice(h,1,b),this._lock||b.init(),this._writeData(d))}else d&&d(Error("no such task with id:"+b.id))};d.prototype.deleteTask=function(b,c,d){if(b){for(var f=-1,h=null,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b){f=a;h=g;break}}if(h.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||c!=b){c=Error("pin error");
c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}}h.isRehauAlarmTask()&&h.isActive()?d&&d(Error("rehau alarm task active")):(h.finalize(),-1!=f&&this._tasks.splice(f,1),this._writeData(d))}else d&&d(Error("task id is null"))};d.prototype.setTaskActive=function(b,c,d,k){if(b){for(var f=null,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b){f=g;break}}if(f){if(f.isAlarmTask){if(this._alarmTask._active){k&&k(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!d||
d!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;k&&k(c);return}}f.isRehauAlarmTask()?k&&k(Error("do not allow to set active state for rehau alarm task")):(f.setActive(c),this._writeData(k))}else k&&k(Error("no such task:"+b))}else k&&k(Error("task id is null"))};d.prototype.doTask=function(b,c,d){if(b){for(var f=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){f=a;break}}if(f.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}b=
this._alarmTask._getAlarmPin();if(!c||c!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}}f.trigger(d)}else d&&d(Error("task id is null"))};d.prototype.cancelTask=function(b,c,d){if(b){for(var f=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){f=a;break}}if(f){if(f.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||c!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;
d&&d(c);return}}f.cancel(d)}else d&&d(Error("no such task"))}else d&&d(Error("task id is null"))};d.prototype.toggleTaskActive=function(b,c,d){if(b){for(var f=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){f=a;break}}if(f){if(f.isAlarmTask&&(b=this._alarmTask._getAlarmPin(),!c||c!=b)){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}f.toggleActive();this._writeData(d)}else d&&d(Error("no such task:"+b))}else d&&d(Error("task id is null"))};d.prototype.isTaskRunning=
function(b,c){if(b){for(var d=null,k=0;k<this._tasks.length;k++){var h=this._tasks[k];if(h.id==b){d=h;break}}d?c&&c(null,d.isRunning()):c&&c(Error("no such task"))}else c&&c(Error("task id is null"))};d.prototype.getCloudDeviceTriggerGateway=function(b){for(var c=null,d=0;d<this._tasks.length;d++){var k=this._tasks[d];if(k&&(c=k.getCloudDeviceTriggerGateway()))break}b&&b(null,c)};d.prototype.readTaskSync=function(b){if(!b)return null;for(var c=null,d=0;d<this._tasks.length;d++){var k=this._tasks[d];
if(k.id==b){c=k;break}}return c};d.prototype.startTaskTrace=function(b,c,d){this.readTask(b,function(b,f){b?d&&d(b):f.startTaskTrace(c,function(a){d&&d(a)})})};d.prototype.stopTaskTrace=function(b,c,d){this.readTask(b,function(b,f){b?d&&d(b):f.stopTaskTrace(c,function(a){d&&d(a)})})};d.prototype.setAlarmActive=function(b,c,d){this._alarmTask.setAlarmActive(b,c,this,d)};d.prototype.setAlarmDelay=function(b,c,d){this._alarmTask.setAlarmDelay(b,c,d)};d.prototype.getAlarmInfo=function(b){this._alarmTask.getAlarmInfo(b)};
d.prototype.selectAlarmTask=function(b,c,d,k){var f=this;this._alarmTask.selectAlarmTask(b,c,d,this._tasks,function(a){a?k&&k(a):f._writeData(k)})};d.prototype._getAlarmPin=function(){return this._alarmTask._getAlarmPin()};d.prototype.setAlarmPin=function(b,c,d){this._alarmTask.setAlarmPin(b,c,d)};d.prototype.onStatusEvt=function(b){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","receive status event:"+JSON.stringify(b));for(var c=0;c<this._tasks.length&&
!(2<=c&&0!=this._mode%31);c++)this._tasks[c].onStatusEvt(b)}};d.prototype.onStatusEvtForTask=function(b,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","for task:"+c+" receive status event:"+JSON.stringify(b));for(var d=0;d<this._tasks.length&&!(2<=d&&0!=this._mode%31);d++){var k=this._tasks[d];if(k.id==c)k.onStatusEvtForTask(b)}}};d.prototype.onIREvt=function(b){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info",
"receive ir event:"+JSON.stringify(b));for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++)this._tasks[c].onIREvt(b)}};d.prototype.onLocationChange=function(b){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onLocationChange(b),x.hub.taskman._AstroManager.onLocationChange(b),x.hub.taskman._PeriodicTimerManager.onLocationChange(b))};d.prototype.onTimeChange=function(b){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onTimeChange(b),
x.hub.taskman._AstroManager.onTimeChange(b),x.hub.taskman._PeriodicTimerManager.onTimeChange(b))};d.prototype.onTimerTick=function(b,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive time tick for task:"+b);for(var d=0;d<this._tasks.length&&!(2<=d&&0!=this._mode%31);d++){var k=this._tasks[d];if(k.id==b)k.onTimerTick(c)}}};d.prototype.onHttpEvt=function(b,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info",
"receive http event"+JSON.stringify(b));var d=!1,k=0;k=this._tasks.length;0!=this._mode%31&&2<k&&(k=2);for(var h=0;h<this._tasks.length&&!(2<=h&&0!=this._mode%31);h++)this._tasks[h].onHttpEvt(b,function(a,b){b&&(d=!0);k--;0==k&&c&&c(null,d)})}};d.prototype.onActivation=function(b){this.version=b?d.NS_VERSION:d.TMP_VERSION};d.prototype._writeData=function(b){var c=[];this._tasks.forEach(function(b){b&&c.push(b.toJSON())});this._writeFile(c,b)};d.prototype._loadData=function(b){var c=require("fs"),
d=this._getFile();c.readFile(d,"utf8",function(c,d){if(c)b&&b(c);else if(d)try{var a=JSON.parse(d),f=[];Array.isArray(a)&&a.forEach(function(a){(a=x.hub.taskman.Task.parse(a))&&f.push(a)});b&&b(null,f?f:[])}catch(l){b&&b(l)}else b&&b(null,[])})};d.prototype._writeFile=function(b,c){var d=require("fs"),k=this._getFile();d.writeFile(k,JSON.stringify(b,null,2),function(b){c&&c(b)})};d.prototype._getFile=function(){var b=require("x.hub.fileman.js").fileManager,c=require("path");require("fs");b=b.getUserRootDataPath();
return c.resolve(b,d.FILE_NAME)};d.prototype._sort=function(){var b=this._tasks.length-1;do{var c=!1;for(var d=0;d<b;++d)this._tasks[d].id>this._tasks[d+1].id&&(c=this._tasks[d],this._tasks[d]=this._tasks[d+1],this._tasks[d+1]=c,c=!0)}while(c)};return d}();
x.hub.taskman.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Handler");this.taskManager=new x.hub.taskman.TaskManager;this._rehauAlarmTaskManager=new x.hub.taskman.rehau.AlarmTaskManager(this.taskManager);var b=require("x.hub.eventbus.js");b.on("status",this.onStatusEvt.bind(this));b.on("irevt",this.onIREvt.bind(this));b.on("locationchange",this.onLocationChange.bind(this));b.on("timechange",this.onTimeChange.bind(this));b.on("neoserver_activation",
this.onActivation.bind(this))};d.prototype.TaskManager=x.hub.taskman.TaskManager;d.prototype.Task=x.hub.taskman.Task;d.prototype.Cloud=x.hub.taskman.Cloud;d.prototype.Util=x.hub.taskman._Util;d.prototype.init=function(b){this._logger.log("info","init task manager");if(localStorage){"true"==localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(this.taskManager.version=x.hub.taskman.TaskManager.NS_VERSION);var c=localStorage.getItem("x.hub.taskman.CLOUD_SERVER");c&&(x.hub.taskman.Cloud.prototype.URL=c)}var d=
this;this.taskManager.init(function(){d._rehauAlarmTaskManager.init(b)})};d.prototype.getRehauAlarmTaskManager=function(){return this._rehauAlarmTaskManager};d.prototype.lock=function(){this.taskManager.lock()};d.prototype.unlock=function(){this.taskManager.unlock()};d.prototype.doWebRequest=function(b,c,d){var f=function(b){if(b.error){var a=x.hub.taskman.ERROR_CODE.General_Error;b.error.code&&(a=b.error.code);d(JSON.stringify({XC_ERR:{code:a,msg:b.error.message}}))}else d(JSON.stringify({XC_SUC:"undefined"!=
typeof b.data&&null!=b.data?b.data:""}))};switch(b){case "Read":b=c.query.id;"undefined"==typeof b?this.readAllTasks(f):this.readTask(b,f);break;case "Create":this.createTask(c.query.data,f);break;case "Update":this.updateTask(c.query.data,c.query.pin,f);break;case "Delete":this.deleteTask(c.query.id,c.query.pin,f);break;case "Do":this.doTask(c.query.id,c.query.pin,f);break;case "Cancel":this.cancelTask(c.query.id,c.query.pin,f);break;case "isRunning":this.isTaskRunning(c.query.id,f);break;case "SetTaskActive":this.setTaskActive(c.query.id,
c.query.active,c.query.pin,f);break;case "ToggleTaskActive":this.toggleTaskActive(c.query.id,c.query.pin,f);break;case "SetAlarmActive":this.setAlarmActive(c.query.active,c.query.pin,f);break;case "SetAlarmDelay":this.setAlarmDelay(c.query.delay,c.query.pin,f);break;case "GetAlarmInfo":this.getAlarmInfo(f);break;case "SelectAlarmTask":this.selectAlarmTask(c.query.id,c.query.isAlarmTask,c.query.pin,f);break;case "SetAlarmPin":this.setAlarmPin(c.query.newPin,c.query.pin,f);break;case "GetCloudServer":f({data:x.hub.taskman.Cloud.prototype.URL});
break;case "SetCloudServer":if(!c.query.url){f({error:Error("url invalid")});break}"http"!=c.query.url.substr(0,4)&&(c.query.url="https://"+c.query.url);localStorage.setItem("x.hub.taskman.CLOUD_SERVER",c.query.url);x.hub.taskman.Cloud.prototype.URL=c.query.url;f({data:"success"});break;case "GetCloudDeviceTriggerGateway":this.getCloudDeviceTriggerGateway(f);break;default:b&&0==b.indexOf("Rehau")&&this.doRehauWebRequest(b,c,d)}};d.prototype.doRehauWebRequest=function(b,c,d){var f=function(b){if(b.error){var a=
x.hub.taskman.ERROR_CODE.General_Error;b.error.code&&(a=b.error.code);d(JSON.stringify({XC_ERR:{code:a,msg:b.error.message}}))}else d(JSON.stringify({XC_SUC:"undefined"!=typeof b.data&&null!=b.data?b.data:""}))};switch(b){case "RehauPinChallenge":this._rehauAlarmTaskManager.challenge(c.query.id,function(b,a){f({error:b,data:a})});break;case "RehauGetAlarmInfo":this._rehauAlarmTaskManager.getAlarmInfo(function(b,a){f({error:b,data:a})});break;case "RehauSetAlarmDelay":this._rehauAlarmTaskManager.setAlarmDelay(c.query.id,
c.query.delay,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetDoorAlarmDelay":this._rehauAlarmTaskManager.setDoorAlarmDelay(c.query.id,c.query.delay,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetAlarmActive":this._rehauAlarmTaskManager.setAlarmActive(c.query.id,c.query.active,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSelectAssociateTaskAlarm":this._rehauAlarmTaskManager.selectAssociateTaskAlarm(c.query.id,c.query.associateTaskId,
c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSelectAssociateTaskPreAlarm":this._rehauAlarmTaskManager.selectAssociateTaskPreAlarm(c.query.id,c.query.associateTaskId,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetNewPin":this._rehauAlarmTaskManager.setNewPin(c.query.id,c.query.pin,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauAddAlarmKey":this._rehauAlarmTaskManager.addAlarmKey(c.query.id,c.query.data,c.query.token,function(b,a){f({error:b,
data:a})});break;case "RehauUpdateAlarmKey":this._rehauAlarmTaskManager.updateAlarmKey(c.query.id,c.query.data,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauDeleteAlarmKey":this._rehauAlarmTaskManager.deleteAlarmKey(c.query.id,c.query.data,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauAddAlarmDoor":this._rehauAlarmTaskManager.addAlarmDoor(c.query.id,c.query.data,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauUpdateAlarmDoor":this._rehauAlarmTaskManager.updateAlarmDoor(c.query.id,
c.query.data,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauDeleteAlarmDoor":this._rehauAlarmTaskManager.deleteAlarmDoor(c.query.id,c.query.data,c.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetAlarmConfirmation":this._rehauAlarmTaskManager.setAlarmConfirmation(c.query.id,c.query.data,c.query.token,function(b,a){f({error:b,data:a})})}};d.prototype.readAllTasks=function(b){this.taskManager.readAllTasks(function(c,d){if(c)b&&b({error:c});else{var f=[];d.forEach(function(b){f.push(b.toJSON())});
b&&b({data:f})}})};d.prototype.createTask=function(b,c){b?(b.id||(b.id=-1),(b=x.hub.taskman.Task.parse(b))?this.taskManager.createTask(b,function(b,d){c&&c({error:b,data:d})}):c&&c({error:Error("task json invalid")})):c&&c({error:Error("task json is null")})};d.prototype.readTask=function(b,c){this.taskManager.readTask(b,function(b,d){c&&c({error:b,data:d?d.toJSON():null})})};d.prototype.updateTask=function(b,c,d){b?(b=x.hub.taskman.Task.parse(b))?this.taskManager.updateTask(b,c,function(b){d&&d({error:b})}):
d&&d({error:Error("task json invalid")}):d&&d({error:Error("task json is null")})};d.prototype.deleteTask=function(b,c,d){this.taskManager.deleteTask(b,c,function(b){d&&d({error:b})})};d.prototype.setTaskActive=function(b,c,d,k){this.taskManager.setTaskActive(b,c,d,function(b){k&&k({error:b})})};d.prototype.doTask=function(b,c,d){this.taskManager.doTask(b,c,function(b){d&&d({error:b})})};d.prototype.cancelTask=function(b,c,d){this.taskManager.cancelTask(b,c,function(b){d&&d({error:b})})};d.prototype.toggleTaskActive=
function(b,c,d){this.taskManager.toggleTaskActive(b,c,function(b){d&&d({error:b})})};d.prototype.isTaskRunning=function(b,c){this.taskManager.isTaskRunning(b,function(b,d){c&&c({error:b,data:d})})};d.prototype.getCloudDeviceTriggerGateway=function(b){this.taskManager.getCloudDeviceTriggerGateway(function(c,d){c?b&&b({error:c}):(d||(d={}),b&&b({data:d}))})};d.prototype.importTasks=function(b,c){this.taskManager.import(b,function(b){c&&c({error:b})})};d.prototype.startTaskTrace=function(b,c,d){this.taskManager.startTaskTrace(b,
c,function(b){d&&d({error:b})})};d.prototype.stopTaskTrace=function(b,c,d){this.taskManager.stopTaskTrace(b,c,function(b){d&&d({error:b})})};d.prototype.setAlarmActive=function(b,c,d){this.taskManager.setAlarmActive(b,c,function(b){d&&d({error:b})})};d.prototype.setAlarmDelay=function(b,c,d){this.taskManager.setAlarmDelay(b,c,function(b){d&&d({error:b})})};d.prototype.getAlarmInfo=function(b){this.taskManager.getAlarmInfo(function(c,d){b&&b({error:c,data:d})})};d.prototype.selectAlarmTask=function(b,
c,d,k){this.taskManager.selectAlarmTask(b,c,d,function(b){k&&k({error:b})})};d.prototype.setAlarmPin=function(b,c,d){this.taskManager.setAlarmPin(b,c,function(b){d&&d({error:b})})};d.prototype._getAlarmPin=function(){return this.taskManager._getAlarmPin()};d.prototype.onStatusEvt=function(b,c){c&&"taskman"==c.src&&c.taskID?(this._logger.log("trace","receive for task: "+c.taskID+" status event:"+JSON.stringify(b)),this.taskManager.onStatusEvtForTask(b,c.taskID)):c&&"rehau:alarmTask"==c.src&&c.alarmTaskID?
(this._logger.log("trace","receive for rehau alarm task: "+c.alarmTaskID+" status event:"+JSON.stringify(b)),this._rehauAlarmTaskManager.onStatusEvtForTask(b,c.alarmTaskID)):(this._logger.log("trace","receive status event:"+JSON.stringify(b)),this.taskManager.onStatusEvt(b))};d.prototype.onIREvt=function(b){this._logger.log("trace","receive ir event:"+JSON.stringify(b));this.taskManager.onIREvt(b)};d.prototype.onLocationChange=function(b){this._logger.log("trace","receive location change event:"+
JSON.stringify(b));this.taskManager.onLocationChange(b)};d.prototype.onTimeChange=function(b){this._logger.log("trace","receive time change event:"+JSON.stringify(b));this.taskManager.onTimeChange(b)};d.prototype.onActivation=function(b){this._logger.log("trace","receive activation change event:"+b);var c=!1;"true"==b&&(c=!0);this.taskManager.onActivation(c)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.taskman.Handler);
