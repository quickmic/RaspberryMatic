var http=require("http"),fs=require("fs");
http._getFileFallback=function(e,c,b){var f=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,a=f+Math.random().toString(36).substring(2);fs.existsSync(f)||fs.mkdirSync(f);f=require("url").parse(e);var d=80,m=!1;if(f.port){d=parseInt(f.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){b&&b(null);return}m=!0}var h=f.hostname,g=f.path,k;"https"==e.substring(0,5).toLowerCase()&&(m||(d=443));c&&c.user&&(k=c.user+":"+c.password);null==d&&(d=80);var l="",p=0,n=!1,q=require("net").connect({port:d,
host:h},function(){var b="GET "+g+" HTTP/1.1\r\n";b+="Host: "+h+"\r\n";k&&(b+="Authorization: Basic "+(new Buffer(k)).toString("base64")+"\r\n");q.write(b+"Connection: close\r\n\r\n")});q.on("data",function(b){if(n)fs.appendFileSync(a,b);else{p=l.length;l+=b.toString();var c=l.indexOf("\n\r\n");-1==c&&(c=l.indexOf("\n\n"));if(-1!=c){var f=l.indexOf("\n",c+1);n=!0;fs.writeFileSync(a,b.slice(f-p+1));l=l.substr(0,c)}}});q.on("end",function(){fs.existsSync(a)?b(a):b(null)});q.on("error",function(){b(null)})};
http.getFile=function(e,c,b,f,a){"undefined"==typeof a&&(a={});"undefined"==typeof a.encodeURL&&(a.encodeURL=!0);var d=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,m=d+Math.random().toString(36).substring(2);try{fs.existsSync(d)||fs.mkdirSync(d)}catch(p){b&&b(p);return}var h=require("url").parse(e),g=80;d=!1;if(h.port){g=parseInt(h.port);if(0===g||isNaN(g))g=80;if(!(0<g&&65536>g)){b&&b(null);return}d=!0}var k={host:h.hostname,port:g,path:a.encodeURL?encodeURI(decodeURI(h.path)):
h.path,method:"GET",headers:{}};c&&c.headers&&(k.headers=c.headers);c&&c.user&&(k.auth=c.user+":"+c.password);f&&(k.headers.Authorization=f);var l=require("http");a=l;"https"==e.substring(0,5).toLowerCase()&&(a=require("https"),d||(k.port=443));a=a.request(k,function(a){if(200==a.statusCode){var d=fs.createWriteStream(m);a.pipe(d);d.on("finish",function(){d.end();b(m)});d.on("error",function(){d.end()})}else 301==a.statusCode||302==a.statusCode?a.headers.location?(l.getFile(a.headers.location,c,b,
null,{encodeURL:!1}),a.destroy()):b&&b(null):401!=a.statusCode||f?b(null):(f=null,a.headers&&a.headers["www-authenticate"]&&"Digest "==a.headers["www-authenticate"].substr(0,7)?(f=require("x.crypt.js").DigestAuth(a.headers["www-authenticate"],k.path,c.user,c.password))?l.getFile(e,c,b,f):b&&b(null):b&&b(null))});a.on("error",function(a){XC.debugf(a);l._getFileFallback(e,c,b)});a.end()};
http.postFile=function(e,c,b,f){var a=require("url").parse(c),d=80,m=!1;if(a.port){d=parseInt(a.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){f&&f(null);return}m=!0}a={host:a.hostname,port:d,path:a.path,method:"POST",headers:{Connection:"close","Content-Type":"application/octet-stream"}};b&&b.user&&(a.auth=b.user+":"+b.password);if(b&&b.headers)for(var h in b.headers)a.headers[h]=b.headers[h];b=require("http");"https"==c.substring(0,5).toLowerCase()&&(b=require("https"),m||(a.port=443));var g=
b.request(a,function(b){f&&f(b)});try{var k=fs.createReadStream(e);k.pipe(g);k.on("finish",function(){k.close()});k.on("error",function(b){k.close();g.emit("error",b)})}catch(l){g.emit("error",l)}return g};
http.getFileAIOCloud=function(e,c,b,f,a){"undefined"==typeof a&&(a={});a=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep;var d=a+Math.random().toString(36).substring(2);try{fs.existsSync(a)||fs.mkdirSync(a)}catch(q){b&&b(q);return}var m=require("url").parse(e),h=80;a=!1;if(m.port){h=parseInt(m.port);if(0===h||isNaN(h))h=80;if(!(0<h&&65536>h)){b&&b(null);return}a=!0}var g={host:m.hostname,port:h,path:m.path,method:"GET",headers:{}};if(c&&c.url){"?"==g.path[g.path.length-1]&&(g.path=
g.path.substring(0,g.path.length-1));m=!0;for(var k in c.url)g.path+=m?"?":"&",g.path+=k+"="+encodeURIComponent(c.url[k]),m=!1}c&&c.user&&(g.auth=c.user+":"+c.password);f&&(g.headers.Authorization=f);var l=require("http"),p=l;"https"==e.substring(0,5).toLowerCase()&&(p=require("https"),a||(g.port=443));var n=fs.createWriteStream(d);n.on("error",function(b){XC.debugf(b.message,"error");n.end()});n.on("finish",function(){n.end();b(d)});n.on("open",function(){var a=p.request(g,function(a){200==a.statusCode?
a.pipe(n):302==a.statusCode?a.headers.location?(delete c.url,l.getFile(a.headers.location,c,b,null,{encodeURL:!1}),a.destroy()):b&&b(null):401!=a.statusCode||f?b(null):(f=null,a.headers&&a.headers["www-authenticate"]&&"Digest "==a.headers["www-authenticate"].substr(0,7)?(f=require("x.crypt.js").DigestAuth(a.headers["www-authenticate"],g.path,c.user,c.password))?l.getFile(e,c,b,f):b&&b(null):b&&b(null))});a.on("error",function(a){XC.debugf(a,"error");l._getFileFallback(e,c,b)});a.end()})};
fs.readFileLine=function(e,c,b){fs.readFile(e,function(f,a){f=!1;a=a.toString("utf-8").split("\n");a[c-1]&&(b(null,a[c-1]),f=!0);f||b("failed",null)})};fs.readFileBinary=function(e,c,b,f){fs.open(e,"r",function(a,d){fs.fstat(d,function(a,e){a=e.size;c>=a?(fs.closeSync?fs.closeSync(d):fs.close(d),f(null,"")):(c+b>a&&(b=a-c),1024<b&&(b=1024),a=new Buffer(b),fs.read(d,a,0,b,c,function(b,a,c){a=c.toString("hex");fs.closeSync?fs.closeSync(d):fs.close(d);b?f("failed",null):f(null,a)}))})})};
fs.rmdirRecursiveSync=function(e){var c=[];fs.existsSync(e)&&(c=fs.readdirSync(e),c.forEach(function(b,c){b=e+"/"+b;fs.lstatSync(b).isDirectory()?fs.rmdirRecursiveSync(b):fs.unlinkSync(b)}),fs.rmdirSync(e))};fs.mkdirRecursiveSync=function(e){var c=require("path");fs.existsSync(c.dirname(e))||fs.mkdirRecursiveSync(c.dirname(e));fs.existsSync(e)||fs.mkdirSync(e)};fs.copyFileSync=function(e,c){var b=c.substring(0,c.lastIndexOf("/"));fs.mkdirRecursiveSync(b);fs.writeFileSync(c,fs.readFileSync(e))};
fs.dataPath=function(){var e=null;try{e=require("nw.gui")}catch(c){}return"object"==typeof nw&&null!==nw&&nw.App?nw.App.dataPath+require("path").sep+"..":e?e.App.dataPath:process.cwd()};if("undefined"===typeof localStorage||null===localStorage){localStorage=null;try{var ls=require("node-localstorage").LocalStorage;localStorage=new ls("./localstorage")}catch(e){}};
