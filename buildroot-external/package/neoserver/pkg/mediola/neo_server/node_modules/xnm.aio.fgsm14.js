var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fgsm14=xnm.aio.fgsm14||{};
xnm.aio.fgsm14.Gateway=function(){var b=function(a,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.sample.Gateway");this.ip=a;this.port=c;this.port||(this.port=80);this.CommandHandler=null};b.prototype._doRequest=function(a,c,f,b,d){a={host:this.ip,port:this.port,path:c,method:a,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(f)for(var e in f)f.hasOwnProperty(e)&&(a.headers[e]=f[e]);b&&(a.headers["Content-Length"]=
b.length);this._logger.log("trace","do request:"+JSON.stringify(a));f=require("https");var k=this,h=d,g=f.request(a,function(c){c.setEncoding("utf-8");var a="";c.on("data",function(c){a+=c});c.on("end",function(){k._logger.log("trace","receive code:"+c.statusCode+" headers:"+JSON.stringify(c.headers)+" response:"+a);h&&(h(null,a,c),h=null)})});if(g.on)g.on("error",function(c){k._logger.log("trace","do request error:"+c.message);h&&(h(c),h=null)});g.setTimeout&&g.setTimeout(2E3,function(){k._logger.log("trace",
"do request timeout");g.abort();h&&(h(Error("timeout")),h=null)});b&&(this._logger.log("trace","do request send body:"+b),g.write(b));g.end()};b.prototype.getDevices=function(a){a(null,[{sys:"fgsm14",type:"swtich",address:1},{sys:"fgsm14",type:"dimmer",address:2}])};b.prototype.executeCommandCreator=function(a,c,b){a?c?b(null):b(Error("invalid command json")):b(Error("invalid device json"))};b.prototype.getStatesCreator=function(a,c,b){if(c){a=[];for(var f=0;f<c.length;f++){var d=c[f];d&&"switch"==
d.device.type&&d.id&&d.status&&"state"==d.status.value?a.push({id:d.id,status:"on"}):d&&"dimmer"==d.device.type&&d.id&&d.status&&"level"==d.status.value&&a.push({id:d.id,level:70})}b(null,a)}else b(Error("invalid device list"))};b.prototype.toJSON=function(){return{sys:"sample",ip:this.ip,port:this.port}};b.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.sample.Gateway?this.ip==b.ip:!1};b.parseJSON=function(a){return a.ip?new b(a.ip,a.port):null};return b}();
xnm.aio.fgsm14.DM=function(){var b=function(c,b){this.code=c;this.message=b;this.stack=Error().stack};b.prototype=Error();b.prototype.name="FGSM14DMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var a={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},
dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"moveUp"}},
{type:"enum",name:"move down",ref:{value:"moveDown"}},{type:"enum",name:"stop",ref:{value:"stop"}}]}};return{SYS:"fgsm14",getGatewayType:function(){return[{sys:this.SYS,name:"Sample",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(c,a,e){a=b.ERROR_CODE;c?c.ip?c.port?
c.type?e(null,c):e(new b(a.INVALID,"type is invalid")):e(new b(a.INVALID,"port is invalid")):e(new b(a.INVALID,"ip is invalid")):e(new b(a.INVALID,"info is invalid"))},updateGateway:function(c,a,e,d){c=b.ERROR_CODE;a?a.ip?a.port?a.type?d(null,a):d(new b(c.INVALID,"type is invalid")):d(new b(c.INVALID,"port is invalid")):d(new b(c.INVALID,"ip is invalid")):d(new b(c.INVALID,"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,e){var d=b.ERROR_CODE;if(c)if(c.address)if(c.type)if(c.gateway){a=
a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var k=a[f];break}k?e&&e(null,c):e(new b(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else e(new b(d.INVALID,"gateway is invalid"));else e(new b(d.INVALID,"type is invalid"));else e(new b(d.INVALID,"address is invalid"));else e(new b(d.INVALID,"info is invalid"))},updateDevice:function(c,a,e){var d=b.ERROR_CODE;if(c)if(c.address)if(c.type)if(c.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===
c.gateway){var k=a[f];break}k?e(null,c):e(new b(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else e(new b(d.INVALID,"gateway is invalid"));else e(new b(d.INVALID,"type is invalid"));else e(new b(d.INVALID,"address is invalid"));else e(new b(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,e){e()},applyUIFilter:function(a,b,e){var c=function(a,c){if("*"==a)return!0;for(var b=!1,d=0;d<a.length;d++)if(a[d]==c){b=!0;break}return b},f=function(a,b,d){var e=[];"command"==d.catagory?
a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==d.catagory&&a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},k=function(a,b){var c=[],d=xnm.aio.feller.DM.getCommandStatusMap(a,e);d&&(a=f(d,a,b),c=c.concat(a));return c};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),g=null;if("command"==b.catagory)g=k(a,b),h.command=g;else if("status"==b.catagory)g=k(a,b),
h.status=g;else return null;return g&&0!=g.length?h:null},getCommandStatusMap:function(b){return b.type?a[b.type]:null}}}();
xnm.aio.fgsm14.Handler=function(){var b=function(){};b.prototype.devicemanager=xnm.aio.fgsm14.DM;b.prototype.Gateway=xnm.aio.fgsm14.Gateway;b.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"fgsm14")};b.prototype.resolveGateway=function(a){return a?this.Gateway.parseJSON(a):null};b.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};b.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,
{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};b.prototype.doCommand=function(a,b,f,e){(a=this.resolveGateway(a))?a.executeCommandCreator(b,f,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};b.prototype.doStatus=function(a,b,f,e,d){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:f,status:e}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gateway json format invalid"))};b.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(b):
b&&b(Error("gateway json format invalid"))};return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fgsm14.Handler);
